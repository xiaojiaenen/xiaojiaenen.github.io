<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"><title>hive | 木槿昔年</title><meta name="keywords" content="hive"><meta name="author" content="小贾嗯嗯"><meta name="copyright" content="小贾嗯嗯"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#f7f9fe"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-touch-fullscreen" content="yes"><meta name="apple-mobile-web-app-title" content="hive"><meta name="application-name" content="hive"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="#f7f9fe"><meta property="og:type" content="article"><meta property="og:title" content="hive"><meta property="og:url" content="http://mujxn.cn/2021/02/21/hive/index.html"><meta property="og:site_name" content="木槿昔年"><meta property="og:description" content="Hive基本操作（1）启动hivebin&amp;#x2F;hive （2）查看数据库hive&amp;gt; show databases; （3）打开默认数据库hive&amp;gt; use default; （4）显示default数据库中的表hive&amp;gt; show tables; （5）创建一张表hive&amp;gt; cr"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="https://api-storage.4ce.cn/v1/56377fd133a97667091971790db975ba.jpg"><meta property="article:author" content="小贾嗯嗯"><meta property="article:tag"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://api-storage.4ce.cn/v1/56377fd133a97667091971790db975ba.jpg"><meta name="description" content="Hive基本操作（1）启动hivebin&amp;#x2F;hive （2）查看数据库hive&amp;gt; show databases; （3）打开默认数据库hive&amp;gt; use default; （4）显示default数据库中的表hive&amp;gt; show tables; （5）创建一张表hive&amp;gt; cr"><link rel="shortcut icon" href="/favicon.ico"><link rel="canonical" href="http://mujxn.cn/2021/02/21/hive/"><link rel="preconnect" href="//cdn.cbd.int"/><link rel="preconnect" href="//static.cloudflareinsights.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="google-site-verification" content="xxx"/><meta name="baidu-site-verification" content="code-xxx"/><meta name="msvalidate.01" content="xxx"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.cbd.int/@fancyapps/ui@5.0.20/dist/fancybox/fancybox.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/swiper/swiper.min.css" media="print" onload="this.media='all'"><script defer="defer" data-pjax="data-pjax" src="https://static.cloudflareinsights.com/beacon.min.js" data-cf-beacon="{&quot;token&quot;: &quot;79b0a3daa779466aabaa3090599e6c74&quot;}"></script><script>const GLOBAL_CONFIG = {
  linkPageTop: undefined,
  peoplecanvas: {"enable":true,"img":"https://upload-bbs.miyoushe.com/upload/2023/09/03/125766904/ee23df8517f3c3e3efc4145658269c06_5714860933110284659.png"},
  postHeadAiDescription: {"enable":true,"gptName":"AnZhiYu","mode":"local","switchBtn":false,"btnLink":"https://afdian.net/item/886a79d4db6711eda42a52540025c377","randomNum":3,"basicWordCount":1000,"key":"xxxx","Referer":"https://xx.xx/"},
  diytitle: {"enable":true,"leaveTitle":"w(ﾟДﾟ)w 不要走！再看看嘛！","backTitle":"♪(^∇^*)欢迎肥来！"},
  LA51: undefined,
  greetingBox: {"enable":true,"default":"晚上好👋","list":[{"greeting":"晚安😴","startTime":0,"endTime":5},{"greeting":"早上好鸭👋, 祝你一天好心情！","startTime":6,"endTime":9},{"greeting":"上午好👋, 状态很好，鼓励一下～","startTime":10,"endTime":10},{"greeting":"11点多啦, 在坚持一下就吃饭啦～","startTime":11,"endTime":11},{"greeting":"午安👋, 宝贝","startTime":12,"endTime":14},{"greeting":"🌈充实的一天辛苦啦！","startTime":14,"endTime":18},{"greeting":"19点喽, 奖励一顿丰盛的大餐吧🍔。","startTime":19,"endTime":19},{"greeting":"晚上好👋, 在属于自己的时间好好放松😌~","startTime":20,"endTime":24}]},
  twikooEnvId: '',
  commentBarrageConfig:undefined,
  root: '/',
  preloader: {"source":3},
  friends_vue_info: undefined,
  navMusic: true,
  mainTone: undefined,
  authorStatus: undefined,
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简","rightMenuMsgToTraditionalChinese":"转为繁体","rightMenuMsgToSimplifiedChinese":"转为简体"},
  noticeOutdate: {"limitDay":365,"position":"top","messagePrev":"距离上次更新已经","messageNext":"天了，文章内容可能已经过时了。"},
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":330},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    simplehomepage: true,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"copy":true,"copyrightEbable":false,"limitCount":50,"languages":{"author":"作者: 小贾嗯嗯","link":"链接: ","source":"来源: 木槿昔年","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。","copySuccess":"复制成功，复制和转载请标注本文地址"}},
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#425AEF","bgDark":"#1f1f1f","position":"top-center"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.min.js',
      css: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  shortcutKey: undefined,
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  configTitle: '木槿昔年',
  title: 'hive',
  postAI: '',
  pageFillDescription: 'Hive基本操作, （1）启动hive, （2）查看数据库, （3）打开默认数据库, （4）显示default数据库中的表, （5）创建一张表, （6）显示数据库中有几张表, （7）查看表的结构, （8）向表中插入数据, （9）查询表中数据, （10）退出hive, Hive实际操作, （1）启动hive, （2）显示数据库, （3）使用default数据库, （4）显示default数据库中的表, （5）删除已创建的student表, （6）创建student表 并声明文件分隔符’\t’, （7）加载x2Foptx2Fmodulex2Fdatasx2Fstudent.txt 文件到student数据库表中。, （8）Hive查询结果, 3．遇到的问题, 再打开一个客户端窗口启动hive会产生java.sql.SQLException异常。, 配置文件, HiveJDBC访问, 2.6.1启动hiveserver2服务, 2.6.2启动beeline, 2.6.3连接hiveserver2, 2.7 Hive常用交互命令, 1．-e不进入hive的交互窗口执行sql语句, 2．-f执行脚本中sql语句, 3 Hive数据类型, 3.1 基本数据类型, 3.2 集合数据类型, 案例实操, 1） 假设某表有如下一行我们用JSON格式来表示其数据结构。在Hive下访问的格式为, 2）基于上述数据结构我们在Hive里创建对应的表并导入数据。, 创建本地测试文件test.txt, 3）Hive上创建测试表test, 4）导入文本数据到测试表, 5）访问三种集合列里的数据以下分别是ARRAYMAPSTRUCT的访问方式, 3.3 类型转化, 第4章 DDL数据定义, 4.1 创建数据库, 4.2 查询数据库, 4.2.1 显示数据库, 4.2.2 查看数据库详情, 4.3.3 切换当前数据库, 4.3 修改数据库, 4.4 删除数据库, 4.5 创建表, 4.5.1 管理表, 4.5.2 外部表, **4.5.3 **管理表与外部表的互相转换, 4.6 分区表, 4.6.1 分区表基本操作, 4.6.2 分区表注意事项, 4.7 修改表, 4.7.1 重命名表, 4.7.2 增加、修改和删除表分区, 4.7.3 增加x2F修改x2F替换列信息, 4.8 删除表, 第5章 DML数据操作, 5.1 数据导入, 5.1.1 向表中装载数据（Load）, 5.1.2 通过查询语句向表中插入数据（Insert）, 5.1.3 查询语句中创建表并加载数据（As Select）, 5.1.4 创建表时通过Location指定加载数据路径, 5.1.5 Import数据到指定Hive表中, 5.2 数据导出, 5.2.1 Insert导出, 5.2.2 Hadoop命令导出到本地, 5.2.3 Hive Shell 命令导出, 5.2.4 Export导出到HDFS上, 5.2.5 Sqoop导出, 5.3 清除表中数据（Truncate）, 第6章 查询, 6.1 基本查询（Select…From）, 6.1.1 全表和特定列查询, 6.1.2 列别名, 6.1.3 算术运算符, 6.1.4 常用函数, 6.1.5 Limit语句, 6.2 Where语句, 6.2.1 比较运算符（Betweenx2FInx2F Is Null）, 6.2.2 Like和RLike, 6.2.3 逻辑运算符（Andx2FOrx2FNot）, 6.3 分组, 6.3.1 Group By语句, 6.3.2 Having语句, 6.4 Join语句, 6.4.1 等值Join, 6.4.2 表的别名, 6.4.3 内连接, 6.4.4 左外连接, 6.4.5 右外连接, 6.4.6 满外连接, 6.4.7 多表连接, 6.4.8 笛卡尔积, 6.4.9 连接谓词中不支持or, 6.5 排序, 6.5.1 全局排序（Order By）, 6.5.2 按照别名排序, 6.5.3 多个列排序, 6.5.4 每个MapReduce内部排序（Sort By）, 6.5.5 分区排序（Distribute By）, 6.5.6 Cluster By, 6.6 分桶及抽样查询, 6.6.1 分桶表数据存储, 6.6.2 分桶抽样查询, 6.7 其他常用查询函数, 6.7.1 空字段赋值, 6.7.2 CASE WHEN, 6.7.2 行转列, 6.7.3 列转行, 6.7.4 窗口函数, 第8章 压缩和存储, 8.1 Hadoop源码编译支持Snappy压缩, 8.1.1 资源准备, 8.1.2 jar包安装, 8.1.3 编译源码, 8.2 Hadoop压缩配置, 8.2.1 MR支持的压缩编码, 8.2.2 压缩参数配置, 8.3 开启Map输出阶段压缩, 8.4 开启Reduce输出阶段压缩, 8.5 文件存储格式, 8.5.1 列式存储和行式存储, 8.5.2 TextFile格式, 8.5.3 Orc格式, 8.5.4 Parquet格式, 8.5.5 主流文件存储格式对比实验, 8.6 存储和压缩结合, 8.6.1 修改Hadoop集群具有Snappy压缩方式, 8.6.2 测试存储和压缩, 第9章 企业级调优, 9.1 Fetch抓取, 9.2 本地模式, 9.3 表的优化, 9.3.1 小表、大表Join, 9.3.3 MapJoin, 9.7 JVM重用, 9.8 推测执行, 9.9 压缩, 9.10 执行计划（Explain）, 第10章 Hive实战之谷粒影音, 10.1 需求描述, 10.2 项目, 10.2.1 数据结构, 10.2.2 ETL原始数据, 10.3 准备工作, 10.3.1 创建表, 10.3.2 导入ETL后的数据, 10.3.3 向ORC表插入数据, 10.4 业务分析, 10.4.1 统计视频观看数Top10, 10.4.2 统计视频类别热度Top10, 10.4.3 统计出视频观看数最高的20个视频的所属类别以及类别包含Top20视频的个数, 10.4.4 统计视频观看数Top50所关联视频的所属类别Rank, 10.4.5 统计每个类别中的视频热度Top10以Music为例, 10.4.6 统计每个类别中视频流量Top10以Music为例, 10.4.7 统计上传视频最多的用户Top10以及他们上传的观看次数在前20的视频, 10.4.8 统计每个类别视频观看数Top10, 第11章 常见错误及解决方案基本操作启动查看数据库打开默认数据库显示数据库中的表创建一张表显示数据库中有几张表查看表的结构向表中插入数据查询表中数据退出实际操作启动显示数据库使用数据库显示数据库中的表删除已创建的表创建表并声明文件分隔符加载文件到数据库表中查询结果遇到的问题再打开一个客户端窗口启动会产生异常原因是默认存储在自带的数据库中推荐使用存储配置文件连接协议连接驱动用户名密码显示当前数据库以及查询表的头信息配置访问启动服务启动连接回车回车直接回车常用交互命令不进入的交互窗口执行语句执行脚本中语句在目录下创建文件文件中写入正确的语句执行文件中的语句执行文件中的语句并将结果写入文件中数据类型基本数据类型数据类型数据类型长度例子有符号整数有符号整数有符号整数有符号整数布尔类型或者单精度浮点数双精度浮点数字符系列可以指定字符集可以使用单引号或者双引号时间类型字节数组对于的类型相当于数据库的类型该类型是一个可变的字符串不过它不能声明其中最多能存储多少个字符理论上它可以存储的字符数集合数据类型数据类型描述语法示例和语言中的类似都可以通过点符号访问元素内容例如如果某个列的数据类型是那么第个元素可以通过字段来引用是一组键值对元组集合使用数组表示法可以访问数据例如如果某个列的数据类型是其中键值对是和那么可以通过字段名获取最后一个元素数组是一组具有相同类型和名称的变量的集合这些变量称为数组的元素每个数组元素都有一个编号编号从零开始例如数组值为那么第个元素可以通过数组名进行引用有三种复杂数据类型和和与中的和类似而与语言中的类似它封装了一个命名字段集合复杂数据类型允许任意层次的嵌套案例实操假设某表有如下一行我们用格式来表示其数据结构在下访问的格式为列表键值结构基于上述数据结构我们在里创建对应的表并导入数据创建本地测试文件注意和里的元素间关系都可以用同一个字符表示这里用上创建测试表字段解释列分隔符和的分隔符数据分割符号中的与的分隔符行分隔符导入文本数据到测试表访问三种集合列里的数据以下分别是的访问方式类型转化的原子数据类型是可以进行隐式转换的类似于的类型转换例如某表达式使用类型会自动转换为类型但是不会进行反向转化例如某表达式使用类型不会自动转换为类型它会返回错误除非使用操作隐式类型转换规则如下任何整数类型都可以隐式地转换为一个范围更广的类型如可以转换成可以转换成所有整数类型和类型都可以隐式地转换成都可以转换为类型不可以转换为任何其它的类型可以使用操作显示进行数据类型转换例如将把字符串转换成整数如果强制类型转换失败如执行表达式返回空值第章数据定义创建数据库创建一个数据库数据库在上的默认存储路径是避免要创建的数据库已经存在错误增加判断标准写法创建一个数据库指定数据库在上存放的位置图数据库存放位置查询数据库显示数据库显示数据库过滤显示查询的数据库查看数据库详情显示数据库信息显示数据库详细信息切换当前数据库切换当前数据库修改数据库用户可以使用命令为某个数据库的设置键值对属性值来描述这个数据库的属性信息数据库的其他元数据信息都是不可更改的包括数据库名和数据库所在的目录位置在中查看修改结果删除数据库删除空数据库如果删除的数据库不存在最好采用判断数据库是否存在如果数据库不为空可以采用命令强制删除创建表建表语法字段解释说明创建一个指定名字的表如果相同名字的表已经存在则抛出异常用户可以用选项来忽略这个异常关键字可以让用户创建一个外部表在建表的同时指定一个指向实际数据的路径创建内部表时会将数据移动到数据仓库指向的路径若创建外部表仅记录数据所在的路径不对数据的位置做任何改变在删除表的时候内部表的元数据和数据会被一起删除而外部表只删除元数据不删除数据为表和列添加注释创建分区表创建分桶表不常用用户在建表的时候可以自定义或者使用自带的如果没有指定或者将会使用自带的在建表的时候用户还需要为表指定列用户在指定表的列的同时也会指定自定义的通过确定表的具体的列的数据是的简称目的是用于序列化和反序列化指定存储文件类型常用的存储文件类型二进制序列文件文本列式存储格式文件如果文件数据是纯文本可以使用如果数据需要压缩使用指定表在上的存储位置允许用户复制现有的表结构但是不复制数据管理表理论默认创建的表都是所谓的管理表有时也被称为内部表因为这种表会或多或少地控制着数据的生命周期默认情况下会将这些表的数据存储在由配置项例如所定义的目录的子目录下当我们删除一个管理表时也会删除这个表中数据管理表不适合和其他工具共享数据案例实操普通创建表根据查询结果创建表查询的结果会添加到新创建的表中根据已经存在的表结构创建表查询表的类型外部表理论因为表是外部表所以并非认为其完全拥有这份数据删除该表并不会删除掉这份数据不过描述表的元数据信息会被删除掉管理表和外部表的使用场景每天将收集到的网站日志定期流入文本文件在外部表原始日志表的基础上做大量的统计分析用到的中间表结果表使用内部表存储数据通过进入内部表案例实操分别创建部门和员工外部表并向表中导入数据原始数据建表语句创建部门表创建员工表查看创建的表向外部表中导入数据导入数据查询结果查看表格式化数据管理表与外部表的互相转换查询表的类型修改内部表为外部表查询表的类型修改外部表为内部表查询表的类型注意和为固定写法区分大小写分区表分区表实际上就是对应一个文件系统上的独立的文件夹该文件夹下是该分区所有的数据文件中的分区就是分目录把一个大的数据集根据业务需要分割成小的数据集在查询时通过子句中的表达式选择查询所需要的指定的分区这样的查询效率会提高很多分区表基本操作引入分区表需要根据日期对日志进行管理创建分区表语法加载数据到分区表中图加载数据到分区表图分区表查询分区表中数据单分区查询多分区联合查询增加分区创建单个分区同时创建多个分区删除分区删除单个分区同时删除多个分区查看分区表有多少分区查看分区表结构分区表注意事项创建二级分区表正常的加载数据加载数据到二级分区表中查询分区数据把数据直接上传到分区目录上让分区表和数据产生关联的三种方式方式一上传数据后修复上传数据查询数据查询不到刚上传的数据执行修复命令再次查询数据方式二上传数据后添加分区上传数据执行添加分区查询数据方式三创建文件夹后数据到分区创建目录上传数据查询数据修改表重命名表语法实操案例增加修改和删除表分区详见分区表基本操作增加修改替换列信息语法更新列增加和替换列注是代表新增一字段字段位置在所有列后面列前则是表示替换表中所有字段实操案例查询表结构添加列查询表结构更新列查询表结构替换列查询表结构删除表第章数据操作数据导入向表中装载数据语法表示加载数据表示从本地加载数据到表否则从加载数据到表表示加载数据的路径表示覆盖表中已有数据否则表示追加表示加载到哪张表表示具体的表表示上传到指定分区实操案例创建一张表加载本地文件到加载文件到中上传文件到加载上数据加载数据覆盖表中已有的数据上传文件到加载数据覆盖表中已有的数据通过查询语句向表中插入数据创建一张分区表基本插入数据基本模式插入根据单张表查询结果多插入模式根据多张表查询结果查询语句中创建表并加载数据详见章创建表根据查询结果创建表查询的结果会添加到新创建的表中创建表时通过指定加载数据路径创建表并指定在上的位置上传数据到上查询数据数据到指定表中注意先用导出后再将数据导入数据导出导出将查询的结果导出到本地将查询的结果格式化导出到本地将查询的结果导出到上没有命令导出到本地命令导出基本语法执行语句或者脚本导出到上导出后续课程专门讲清除表中数据注意只能删除管理表不能删除外部表中数据第章查询查询语句语法基本查询全表和特定列查询全表查询选择特定列查询注意语言大小写不敏感可以写在一行或者多行关键字不能被缩写也不能分行各子句一般要分行写使用缩进提高语句的可读性列别名重命名一个列便于计算紧跟列名也可以在列名和别名之间加入关键字案例实操查询名称和部门算术运算符表运算符描述和相加减去和相乘除以对取余和按位取与和按位取或和按位取异或按位取反案例实操查询出所有员工的薪水后加显示常用函数求总行数求工资的最大值求工资的最小值求工资的总和求工资的平均值语句典型的查询会返回多行数据子句用于限制返回的行数语句使用子句将不满足条件的行过滤掉子句紧随子句案例实操查询出薪水大于的所有员工比较运算符下面表中描述了谓词操作符这些操作符同样可以用于和语句中表操作符支持的数据类型描述基本数据类型如果等于则返回反之返回基本数据类型如果和都为则返回其他的和等号操作符的结果一致如果任一为则结果为基本数据类型或者为则返回如果不等于则返回反之返回基本数据类型或者为则返回如果小于则返回反之返回基本数据类型或者为则返回如果小于等于则返回反之返回基本数据类型或者为则返回如果大于则返回反之返回基本数据类型或者为则返回如果大于等于则返回反之返回基本数据类型如果或者任一为则结果为如果的值大于等于而且小于或等于则结果为反之为如果使用关键字则可达到相反的效果所有数据类型如果等于则返回反之返回所有数据类型如果不等于则返回反之返回数值数值所有数据类型使用运算显示列表中的值类型是一个下的简单正则表达式如果与其匹配的话则返回反之返回的表达式说明如下表示必须以字母开头表示必须以字母结尾而表示包含有字母可以位于开头结尾或者字符串中间如果使用关键字则可达到相反的效果类型是一个正则表达式如果与其匹配则返回反之返回匹配使用的是中的正则表达式接口实现的因为正则也依据其中的规则例如正则表达式必须和整个字符串相匹配而不是只需与其字符串匹配案例实操查询出薪水等于的所有员工查询工资在到的员工信息查询为空的所有员工信息查询工资是或的员工信息和使用运算选择类似的值选择条件可以包含字符或数字代表零个或多个字符任意个字符代表一个字符子句是中这个功能的一个扩展其可以通过的正则表达式这个更强大的语言来指定匹配条件案例实操查找以开头薪水的员工信息查找第二个数值为的薪水的员工信息查找薪水中含有的员工信息逻辑运算符表操作符含义逻辑并逻辑或逻辑否案例实操查询薪水大于部门是查询薪水大于或者部门是查询除了部门和部门以外的员工信息分组语句语句通常会和聚合函数一起使用按照一个或者多个列队结果进行分组然后对每个组执行聚合操作案例实操计算表每个部门的平均工资计算每个部门中每个岗位的最高薪水语句与不同点针对表中的列发挥作用查询数据针对查询结果中的列发挥作用筛选数据后面不能写分组函数而后面可以使用分组函数只用于分组统计语句案例实操求每个部门的平均薪水大于的部门求每个部门的平均工资求每个部门的平均薪水大于的部门语句等值支持通常的语句但是只支持等值连接不支持非等值连接案例实操根据员工表和部门表中的部门编号相等查询员工编号员工名称和部门名称表的别名好处使用别名可以简化查询使用表名前缀可以提高执行效率案例实操合并员工表和部门表内连接内连接只有进行连接的两个表中都存在与连接条件相匹配的数据才会被保留下来左外连接左外连接操作符左边表中符合子句的所有记录将会被返回右外连接右外连接操作符右边表中符合子句的所有记录将会被返回满外连接满外连接将会返回所有表中符合语句条件的所有记录如果任一表的指定字段没有符合条件的值的话那么就使用值替代多表连接注意连接个表至少需要个连接条件例如连接三个表至少需要两个连接条件数据准备创建位置表导入数据多表连接查询大多数情况下会对每对连接对象启动一个任务本例中会首先启动一个对表和表进行连接操作然后会再启动一个将第一个的输出和表进行连接操作注意为什么不是表和表先进行连接操作呢这是因为总是按照从左到右的顺序执行的笛卡尔积笛卡尔集会在下面条件下产生省略连接条件连接条件无效所有表中的所有行互相连接案例实操连接谓词中不支持错误的排序全局排序全局排序一个使用子句排序升序默认降序子句在语句的结尾案例实操查询员工信息按工资升序排列查询员工信息按工资降序排列按照别名排序按照员工薪水的倍排序多个列排序按照部门和工资升序排序每个内部排序每个内部进行排序对全局结果集来说不是排序设置个数查看设置个数根据部门编号降序查看员工信息将查询结果导入到文件中按照部门编号降序排序分区排序类似中进行分区结合使用注意要求语句要写在语句之前对于进行测试一定要分配多进行处理否则无法看到的效果案例实操先按照部门编号分区再按照员工编号降序排序当和字段相同时可以使用方式除了具有的功能外还兼具的功能但是排序只能是升序排序不能指定排序规则为或者以下两种写法等价注意按照部门编号分区不一定就是固定死的数值可以是号和号部门分到一个分区里面去分桶及抽样查询分桶表数据存储分区针对的是数据的存储路径分桶针对的是数据文件分区提供一个隔离数据和优化查询的便利方式不过并非所有的数据集都可形成合理的分区特别是之前所提到过的要确定合适的划分大小这个疑虑分桶是将数据集分解成更容易管理的若干部分的另一个技术先创建分桶表通过直接导入数据文件的方式数据准备创建分桶表查看表结构导入数据到分桶表中查看创建的分桶表中是否分成个桶如图所示图未分桶发现并没有分成个桶是什么原因呢创建分桶表时数据通过子查询的方式导入先建一个普通的表向普通的表中导入数据清空表中数据导入数据到分桶表通过子查询的方式发现还是只有一个分桶如图所示图未分桶需要设置一个属性图分桶查询分桶的数据分桶抽样查询对于非常大的数据集有时用户需要使用的是一个具有代表性的查询结果而不是全部结果可以通过对表进行抽样来满足这个需求查询表中的数据注是抽样语句语法必须是总数的倍数或者因子根据的大小决定抽样的比例例如总共分了份当时抽取个的数据当时抽取个的数据表示从哪个开始抽取如果需要取多个分区以后的分区号为当前分区号加上例如总数为表示总共抽取个的数据抽取第个和第个的数据注意的值必须小于等于的值否则其他常用查询函数空字段赋值函数说明给值为的数据赋值它的格式是它的功能是如果为则函数返回的值否则返回的值如果两个参数都为则返回数据准备采用员工表查询如果员工的为则用代替查询如果员工的为则用领导代替时间函数相减同上数据准备悟空男大海男宋宋男凤姐女婷姐女婷婷女需求求出不同部门男女各多少人结果如下创建本地导入数据悟空男大海男宋宋男凤姐女婷姐女婷婷女创建表并导入数据按需求查询数据男女行转列相关函数说明返回输入字符串连接后的结果支持任意个输入字符串它是一个特殊形式的第一个参数剩余参数间的分隔符分隔符可以是与剩余参数一样的字符串如果分隔符是返回值也将为这个函数会跳过分隔符参数后的任何和空字符串分隔符将被加到被连接的字符串之间函数只接受基本数据类型它的主要作用是将某字段的值进行去重汇总产生类型字段数据准备表数据准备孙悟空白羊座大海射手座宋宋白羊座猪八戒白羊座凤姐射手座需求把星座和血型一样的人归类到一起结果如下射手座大海凤姐白羊座孙悟空猪八戒白羊座宋宋创建本地导入数据孙悟空白羊座大海射手座宋宋白羊座猪八戒白羊座凤姐射手座创建表并导入数据按需求查询数据列转行函数说明将一列中复杂的或者结构拆分成多行用法解释用于和等一起使用它能够将一列数据拆成多行数据在此基础上可以对拆分后的数据进行聚合数据准备表数据准备疑犯追踪悬疑动作科幻剧情悬疑警匪动作心理剧情战狼战争动作灾难需求将电影分类中的数组数据展开结果如下疑犯追踪悬疑疑犯追踪动作疑犯追踪科幻疑犯追踪剧情悬疑警匪动作心理剧情战狼战争战狼动作战狼灾难创建本地导入数据疑犯追踪悬疑动作科幻剧情悬疑警匪动作心理剧情战狼战争动作灾难创建表并导入数据按需求查询数据窗口函数相关函数说明当前行往前行数据往后行数据起点表示从前面的起点表示到后面的终点往前第行数据往后第行数据把有序分区中的行分发到指定数据的组中各个组有编号编号从开始对于每一行返回此行所属的组的编号注意必须为类型数据准备需求查询在年月份购买过的顾客及总人数查询顾客的购买明细及月购买总额上述的场景要将按照日期进行累加查询顾客上次的购买时间查询前时间的订单信息创建本地导入数据创建表并导入数据按需求查询数据查询在年月份购买过的顾客及总人数查询顾客的购买明细及月购买总额上述的场景要将按照日期进行累加所有行相加按分组组内数据相加按分组组内数据累加和一样由起点到当前行的聚合当前行和前面一行做聚合当前行和前边一行及后面一行当前行及后面所有行查看顾客上次的购买时间查询前时间的订单信息函数说明排序相同时会重复总数不会变排序相同时会重复总数会减少会根据顺序计算数据准备表数据准备孙悟空语文孙悟空数学孙悟空英语大海语文大海数学大海英语宋宋语文宋宋数学宋宋英语婷婷语文婷婷数学婷婷英语需求计算每门学科成绩排名创建本地导入数据创建表并导入数据按需求查询数据孙悟空数学宋宋数学婷婷数学大海数学宋宋英语大海英语婷婷英语孙悟空英语大海语文孙悟空语文婷婷语文宋宋语文第章函数系统内置函数查看系统自带的函数显示自带的函数的用法详细显示自带的函数的用法自定义函数自带了一些函数比如等但是数量有限自己可以通过自定义来方便的扩展当提供的内置函数无法满足你的业务处理需要时此时就可以考虑使用用户自定义函数根据用户自定义函数类别分为以下三种一进一出聚集函数多进一出类似于一进多出如官方文档地址编程步骤继承需要实现函数函数支持重载在的命令行窗口创建函数添加创建在的命令行窗口删除函数注意事项必须要有返回类型可以返回但是返回类型不能为自定义函数创建一个工程导入依赖创建一个类打成包上传到服务器将包添加到的创建临时函数与开发好的关联即可在中使用自定义的函数第章压缩和存储源码编译支持压缩资源准备联网配置能连接外网虚拟机是畅通的注意采用角色编译减少文件夹权限出现问题包准备源码包安装注意所有操作必须在用户下完成解压配置环境变量和验证如下都需要验证是否配置成功验证命令解压配置和验证命令编译源码准备编译环境编译安装查看库文件编译安装查看版本以测试是否安装成功编译执行成功后即为新生成的支持压缩的二进制安装包压缩配置支持的压缩编码表压缩格式工具算法文件扩展名是否可切分无否否是是无否为了支持多种压缩解压缩算法引入了编码解码器如下表所示表压缩格式对应的编码解码器压缩性能的比较表压缩算法原始文件大小压缩文件大小压缩速度解压速度压缩参数配置要在中启用压缩可以配置如下参数文件中表参数默认值阶段建议在中配置输入压缩使用文件扩展名判断是否支持某种编解码器输出这个参数设为启用压缩输出使用或编解码器在此阶段压缩数据输出这个参数设为启用压缩输出使用标准工具或者编解码器如和输出输出使用的压缩类型和开启输出阶段压缩开启输出阶段压缩可以减少中和间数据传输量具体配置如下案例实操开启中间传输数据压缩功能开启中输出压缩功能设置中输出数据的压缩方式执行查询语句开启输出阶段压缩当将输出写入到表中时输出内容同样可以进行压缩属性控制着这个功能用户可能需要保持默认设置文件中的默认值这样默认的输出就是非压缩的纯文本文件了用户可以通过在查询语句或执行脚本中设置这个值为来开启输出结果压缩功能案例实操开启最终输出数据压缩功能开启最终输出数据压缩设置最终数据输出压缩方式设置最终数据输出压缩为块压缩测试一下输出结果是否是压缩文件文件存储格式支持的存储数的格式主要有列式存储和行式存储图列式存储和行式存储如图所示左边为逻辑表右边第一个为行式存储第二个为列式存储行存储的特点查询满足条件的一整行数据的时候列存储则需要去每个聚集的字段找到对应的每个列的值行存储只需要找到其中一个值其余的值都在相邻地方所以此时行存储查询的速度更快列存储的特点因为每个字段的数据聚集存储在查询只需要少数几个字段的时候能大大减少读取的数据量每个字段的数据类型一定是相同的列式存储可以针对性的设计更好的设计压缩算法和的存储格式都是基于行存储的和是基于列式存储的格式默认格式数据不做压缩磁盘开销大数据解析开销大可结合使用但使用这种方式不会对数据进行切分从而无法对数据进行并行操作格式是版里引入的新的存储格式如图所示可以看到每个文件由个或多个组成每个大小这个实际相当于概念不过大小由这样应该能提升顺序读的吞吐率每个里有三部分组成分别是图格式一个轻量级的默认是每隔行做一个索引这里做的索引应该只是记录某行的各字段在中的存的是具体的数据先取部分行然后对这些行按列进行存储对每个列进行了编码分成多个来存储存的是各个的类型长度等信息每个文件有一个这里面存的是每个的行数每个的数据类型信息等每个文件的尾部是一个这里面记录了整个文件的压缩类型以及的长度信息等在读取文件时会到文件尾部读从里面解析到长度再读从里面解析到各个信息再读各个即从后往前读格式是面向分析型业务的列式存储格式由和合作开发年月从的孵化器里毕业成为顶级项目文件是以二进制方式存储的所以是不可以直接读取的文件中包括该文件的数据和元数据因此格式文件是自解析的通常情况下在存储数据的时候会按照大小设置行组的大小由于一般情况下每一个任务处理数据的最小单位是一个这样可以把每一个行组由一个任务处理增大任务执行并行度文件的格式如图所示图格式上图展示了一个文件的内容一个文件中可以存储多个行组文件的首位都是该文件的用于校验它是否是一个文件记录了文件元数据的大小通过该值和文件长度可以计算出元数据的偏移量文件的元数据中包括每一个行组的元数据信息和该文件存储数据的信息除了文件中每一个行组的元数据每一页的开始都会存储该页的元数据在中有三种类型的页数据页字典页和索引页数据页用于存储当前行组中该列的值字典页存储该列值的编码字典每一个列块中最多包含一个字典页索引页用来存储当前行组下该列的索引目前中还不支持索引页主流文件存储格式对比实验从存储文件的压缩比和查询速度两个角度对比存储文件的压缩比测试测试数据创建表存储数据格式为向表中加载数据查看表中数据大小创建表存储数据格式为向表中加载数据查看表中数据大小创建表存储数据格式为向表中加载数据查看表中数据大小存储文件的压缩比总结存储文件的查询速度测试存储文件的查询速度总结查询速度相近存储和压缩结合修改集群具有压缩方式查看命令使用查看支持的压缩方式将编译好的支持压缩的包导入到的中解压到当前路径进入到路径可以看到支持压缩的动态链接库月月月月月拷贝里面的所有内容到开发集群的路径上分发集群再次查看支持的压缩类型重新启动集群和测试存储和压缩官网存储方式的压缩表创建一个非压缩的的存储方式建表语句插入数据查看插入后数据创建一个压缩的存储方式建表语句插入数据查看插入后数据上一节中默认创建的存储方式导入数据后的大小为比压缩的还小原因是存储文件默认采用压缩比压缩的小存储方式和压缩总结在实际的项目开发当中表的数据存储格式一般选择或压缩方式一般选择第章企业级调优抓取抓取是指中对某些情况的查询可以不必使用计算例如在这种情况下可以简单地读取对应的存储目录下的文件然后输出查询结果到控制台在文件中默认是老版本默认是该属性修改为以后在全局查找字段查找查找等都不走案例实操把设置成然后执行查询语句都会执行程序把设置成然后执行查询语句如下查询方式都不会执行程序本地模式大多数的是需要提供的完整的可扩展性来处理大数据集的不过有时的输入数据量是非常小的在这种情况下为查询触发执行任务消耗的时间可能会比实际的执行时间要多的多对于大多数这种情况可以通过本地模式在单台机器上处理所有的任务对于小数据集执行时间可以明显被缩短用户可以通过设置的值为来让在适当的时候自动启动这个优化开启本地设置的最大输入数据量当输入数据量小于这个值时采用的方式默认为即设置的最大输入文件个数当输入文件个数小于这个值时采用的方式默认为案例实操开启本地模式并执行查询语句关闭本地模式并执行查询语句表的优化小表大表将相对分散并且数据量小的表放在的左边这样可以有效减少内存溢出错误发生的几率再进一步可以使用让小的维度表条以下的记录条数先进内存在端完成实际测试发现新版的已经对小表大表和大表小表进行了优化小表放在左边和右边已经没有明显区别案例实操需求测试大表小表和小表大表的效率建大表小表和后表的语句创建大表创建小表创建后表的语句分别向大表和小表中导入数据关闭功能默认是打开的执行小表大表语句执行大表小表语句大表大表空过滤有时超时是因为某些对应的数据太多而相同对应的数据都会发送到相同的上从而导致内存不够此时我们应该仔细分析这些异常的很多情况下这些对应的数据是异常数据我们需要在语句中进行过滤例如对应的字段为空操作如下案例实操配置历史服务器配置启动历史服务器查看创建原始数据表空表合并后数据表创建原始表创建空表创建后表的语句分别加载原始数据和空数据到对应表中测试不过滤空测试过滤空空转换有时虽然某个为空对应的数据很多但是相应的数据不是异常数据必须要包含在的结果中此时我们可以表中为空的字段赋一个随机的值使得数据随机均匀地分不到不同的上例如案例实操不随机分布空值设置个个数两张表结果如图所示可以看出来出现了数据倾斜某些的资源消耗远大于其他图空转换随机分布空值设置个个数两张表结果如图所示可以看出来消除了数据倾斜负载均衡的资源消耗图随机分布空值如果不指定或者不符合的条件那么解析器会将操作转换成即在阶段完成容易发生数据倾斜可以用把小表全部加载到内存在端进行避免处理开启参数设置设置自动选择大表小表的阈值设置默认一下认为是小表工作机制如图所示图工作机制案例实操开启功能默认为执行小表大表语句执行大表小表语句默认情况下阶段同一数据分发给一个当一个数据过大时就倾斜了并不是所有的聚合操作都需要在端完成很多聚合操作都可以先在端进行部分聚合最后在端得出最终结果开启端聚合参数设置是否在端进行聚合默认为在端进行聚合操作的条目数目有数据倾斜的时候进行负载均衡默认是当选项设定为生成的查询计划会有两个第一个中的输出结果会随机分布到中每个做部分聚合操作并输出结果这样处理的结果是相同的有可能被分发到不同的中从而达到负载均衡的目的第二个再根据预处理的数据结果按照分布到中这个过程可以保证相同的被分布到同一个中最后完成最终的聚合操作去重统计数据量小的时候无所谓数据量大的情况下由于操作需要用一个来完成这一个需要处理的数据量太大就会导致整个很难完成一般使用先再的方式替换案例实操创建一张大表加载数据设置个个数执行去重查询采用去重虽然会多用一个来完成但在数据量大的情况下这个绝对是值得的笛卡尔积尽量避免笛卡尔积的时候不加条件或者无效的条件只能使用个来完成笛卡尔积行列过滤列处理在中只拿需要的列如果有尽量使用分区过滤少用行处理在分区剪裁中当使用外关联时如果将副表的过滤条件写在后面那么就会先全表关联之后再过滤比如案例实操测试先关联两张表再用条件过滤通过子查询后再关联表动态分区调整关系型数据库中对分区表数据时候数据库自动会根据分区字段的值将数据插入到相应的分区中中也提供了类似的机制即动态分区只不过使用的动态分区需要进行相应的配置开启动态分区参数设置开启动态分区功能默认开启设置为非严格模式动态分区的模式默认表示必须指定至少一个分区为静态分区模式表示允许所有的分区字段都可以使用动态分区在所有执行的节点上最大一共可以创建多少个动态分区在每个执行的节点上最大可以创建多少个动态分区该参数需要根据实际的数据来设定比如源数据中包含了一年的数据即字段有个值那么该参数就需要设置成大于如果使用默认值则会报错整个中最大可以创建多少个文件当有空分区生成时是否抛出异常一般不需要设置案例实操需求将中的数据按照时间如插入到目标表的相应分区中创建分区表加载数据到分区表中创建目标分区表设置动态分区查看目标分区表的分区情况分桶详见章分区详见章数据倾斜合理设置数通常情况下作业会通过的目录产生一个或者多个任务主要的决定因素有的文件总个数的文件大小集群设置的文件块大小是不是数越多越好答案是否定的如果一个任务有很多小文件远远小于块大小则每个小文件也会被当做一个块用一个任务来完成而一个任务启动和初始化的时间远远大于逻辑处理的时间就会造成很大的资源浪费而且同时可执行的数是受限的是不是保证每个处理接近的文件块就高枕无忧了答案也是不一定比如有一个的文件正常会用一个去完成但这个文件只有一个或者两个小字段却有几千万的记录如果处理的逻辑比较复杂用一个任务去做肯定也比较耗时针对上面的问题和我们需要采取两种方式来解决即减少数和增加数小文件进行合并在执行前合并小文件减少数具有对小文件进行合并的功能系统默认的格式没有对小文件合并功能复杂文件增加数当的文件都很大任务逻辑复杂执行非常慢的时候可以考虑增加数来使得每个处理的数据量减少从而提高任务的执行效率增加的方法为根据公式调整最大值让最大值低于就可以增加的个数案例实操执行查询设置最大切片值为个字节合理设置数调整个数方法一每个处理的数据量默认是每个任务最大的数默认为计算数的公式参数总输入数据量参数调整个数方法二在的文件中修改设置每个的个数个数并不是越多越好过多的启动和初始化也会消耗时间和资源另外有多少个就会有多少个输出文件如果生成了很多个小文件那么如果这些小文件作为下一个任务的输入则也会出现小文件过多的问题在设置个数的时候也需要考虑这两个原则处理大数据量利用合适的数使单个任务处理数据量大小要合适并行执行会将一个查询转化成一个或者多个阶段这样的阶段可以是阶段抽样阶段合并阶段阶段或者执行过程中可能需要的其他阶段默认情况下一次只会执行一个阶段不过某个特定的可能包含众多的阶段而这些阶段可能并非完全互相依赖的也就是说有些阶段是可以并行执行的这样可能使得整个的执行时间缩短不过如果有更多的阶段可以并行执行那么可能就越快完成通过设置参数值为就可以开启并发执行不过在共享集群中需要注意下如果中并行阶段增多那么集群利用率就会增加打开任务并行执行同一个允许最大并行度默认为当然得是在系统资源比较空闲的时候才有优势否则没资源并行也起不来严格模式提供了一个严格模式可以防止用户执行那些可能意想不到的不好的影响的查询通过设置属性值为默认是非严格模式开启严格模式需要修改值为开启严格模式可以禁止种类型的查询对于分区表除非语句中含有分区字段过滤条件来限制范围否则不允许执行换句话说就是用户不允许扫描所有分区进行这个限制的原因是通常分区表都拥有非常大的数据集而且数据增加迅速没有进行分区限制的查询可能会消耗令人不可接受的巨大资源来处理这个表对于使用了语句的查询要求必须使用语句因为为了执行排序过程会将所有的结果数据分发到同一个中进行处理强制要求用户增加这个语句可以防止额外执行很长一段时间限制笛卡尔积的查询对关系型数据库非常了解的用户可能期望在执行查询的时候不使用语句而是使用语句这样关系数据库的执行优化器就可以高效地将语句转化成那个语句不幸的是并不会执行这种优化因此如果表足够大那么这个查询就会出现不可控的情况重用重用是调优参数的内容其对的性能具有非常大的影响特别是对于很难避免小文件的场景或特别多的场景这类场景大多数执行时间都很短的默认配置通常是使用派生来执行和任务的这时的启动过程可能会造成相当大的开销尤其是执行的包含有成百上千任务的情况重用可以使得实例在同一个中重新使用次的值可以在的文件中进行配置通常在之间具体多少需要根据具体业务场景测试得出这个功能的缺点是开启重用将一直占用使用到的插槽以便进行重用直到任务完成后才能释放如果某个不平衡的中有某几个执行的时间要比其他消耗的时间多的多的话那么保留的插槽就会一直空闲着却无法被其他的使用直到所有的都结束了才会释放推测执行在分布式集群环境下因为程序包括本身的负载不均衡或者资源分布不均等原因会造成同一个作业的多个任务之间运行速度不一致有些任务的运行速度可能明显慢于其他任务比如一个作业的某个任务进度只有而其他所有任务已经运行完毕则这些任务会拖慢作业的整体执行进度为了避免这种情况发生采用了推测执行机制它根据一定的法则推测出拖后腿的任务并为这样的任务启动一个备份任务让该任务与原始任务同时处理同一份数据并最终选用最先成功运行完成任务的计算结果作为最终结果设置开启推测执行参数的文件中进行配置不过本身也提供了配置项来控制的推测执行关于调优这些推测执行变量还很难给一个具体的建议如果用户对于运行时的偏差非常敏感的话那么可以将这些功能关闭掉如果用户因为输入数据量很大而需要执行长时间的或者的话那么启动推测执行造成的浪费是非常巨大大压缩详见第章执行计划基本语法案例实操查看下面这条语句的执行计划查看详细执行计划第章实战之谷粒影音需求描述统计硅谷影音视频网站的常规指标各种指标统计视频观看数统计视频类别热度统计视频观看数所属类别统计视频观看数所关联视频的所属类别统计每个类别中的视频热度统计每个类别中视频流量统计上传视频最多的用户以及他们上传的视频统计每个类别视频观看数项目数据结构视频表表视频表字段备注详细描述视频唯一位字符串视频上传者上传视频的用户名视频年龄视频在平台上的整数天视频类别上传视频指定的视频分类视频长度整形数字标识的视频长度观看次数视频被浏览的次数视频评分满分分流量视频的流量整型数字评论数一个视频的整数评论数相关视频相关视频的最多个用户表表用户表字段备注字段类型上传者用户名上传视频数朋友数量原始数据通过观察原始数据形式可以发现视频可以有多个所属分类每个所属分类用符号分割且分割的两边有空格字符同时相关视频也是可以有多个元素多个相关视频又用进行分割为了分析数据时方便对存在多个子元素的数据进行操作我们首先进行数据重组清洗操作即将所有的类别用分割同时去掉两边空格多个相关视频也使用进行分割之之之中该文件目录不存在执行准备工作创建表创建表创建表然后把原始数据插入到表中导入后的数据向表插入数据业务分析统计视频观看数思路使用按照字段做一个全局排序即可同时我们设置只显示前条最终代码统计视频类别热度思路即统计每个类别有多少个视频显示出包含视频最多的前个类别我们需要按照类别聚合然后组内的个数即可因为当前表结构为一个视频对应一个或多个类别所以如果要类别需要先将类别进行列转行展开然后再进行即可最后按照热度排序显示前条最终代码统计出视频观看数最高的个视频的所属类别以及类别包含视频的个数思路先找到观看数最高的个视频所属条目的所有信息降序排列把这条信息中的分裂出来列转行最后查询视频分类名称和该分类下有多少个的视频最终代码统计视频观看数所关联视频的所属类别思路查询出观看数最多的前个视频的所有信息当然包含了每个视频对应的关联视频记为临时表观看数前的视频将找到的条视频信息的相关视频列转行记为临时表将相关视频的进行列转行操作将相关视频的和表进行操作得到两列数据一列是一列是之前查询出来的相关视频按照视频类别进行分组统计每组视频个数然后排行最终代码统计每个类别中的视频热度以为例思路要想统计类别中的视频热度需要先找到类别那么就需要将展开所以可以创建一张表用于存放展开的数据向展开的表中插入数据统计对应类别中的视频热度最终代码创建表类别表向类别表中插入数据统计类别的也可以统计其他统计每个类别中视频流量以为例思路创建视频类别展开表列转行后的表按照排序即可最终代码统计上传视频最多的用户以及他们上传的观看次数在前的视频思路先找到上传视频最多的个用户的用户信息通过字段与表进行得到的信息按照观看次数进行排序即可最终代码统计每个类别视频观看数思路先得到展开的表数据子查询按照进行分区然后分区内排序并生成递增数字该递增数字这一列起名为列通过子查询产生的临时表查询值小于等于的数据行即可最终代码第章常见错误及解决方案出现乱码或者删除不掉数据免安装版的卸载或者用虚拟机直接操作或者换安装版的连接不上数据库导错驱动包应该把导入的不是这个包错把导入包下修改表中的主机名称没有都修改为而是修改为默认的输入格式处理是会对小文件进行合并可以采用就会根据分区数输出相应的文件不能执行程序可能是的没开启启动服务时报异常在路径下创建并在文件中添加内容报失败异常解决方案在目录下创建月文件并修改权限为堆内存溢出描述解决在中加入如下代码',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-09-27 23:36:15',
  postMainColor: '',
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#18171d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#f7f9fe')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(e => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.0.0"></head><body data-type="anzhiyu"><div id="web_bg"></div><div id="an_music_bg"></div><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><img class="loading-img nolazyload" alt="加载头像" src="https://npm.elemecdn.com/anzhiyu-blog-static@1.0.4/img/avatar.jpg"/><div class="loading-image-dot"></div></div></div><script>const preloader = {
  endLoading: () => {
    document.getElementById('loading-box').classList.add("loaded");
  },
  initLoading: () => {
    document.getElementById('loading-box').classList.remove("loaded")
  }
}
window.addEventListener('load',()=> { preloader.endLoading() })
setTimeout(function(){preloader.endLoading();},10000)

if (true) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.10/progress_bar/progress_bar.css"/><script async="async" src="https://cdn.cbd.int/pace-js@1.2.4/pace.min.js" data-pace-options="{ &quot;restartOnRequestAfter&quot;:false,&quot;eventLag&quot;:false}"></script><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><div id="nav-group"><span id="blog_name"><a id="site-name" href="/" accesskey="h"><div class="title">木槿昔年</div><i class="anzhiyufont anzhiyu-icon-house-chimney"></i></a></span><div class="mask-name-container"><div id="name-container"><a id="page-name" href="javascript:anzhiyu.scrollToDest(0, 500)">PAGE_NAME</a></div></div><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size: 0.9em;"></i><span> 隧道</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size: 0.9em;"></i><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size: 0.9em;"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/bangumis/"><i class="anzhiyufont anzhiyu-icon-bilibili faa-tada" style="font-size: 0.9em;"></i><span> 追番页</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada" style="font-size: 0.9em;"></i><span> 关于本人</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/essay/"><i class="anzhiyufont anzhiyu-icon-lightbulb faa-tada" style="font-size: 0.9em;"></i><span> 闲言碎语</span></a></li></ul></div></div></div><div id="nav-right"><div class="nav-button" id="randomPost_button"><a class="site-page" onclick="toRandomPost()" title="随机前往一个文章" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-dice"></i></a></div><input id="center-console" type="checkbox"/><label class="widget" for="center-console" title="中控台" onclick="anzhiyu.switchConsole();"><i class="left"></i><i class="widget center"></i><i class="widget right"></i></label><div id="console"><div class="console-card-group-reward"><ul class="reward-all console-card"><li class="reward-item"><a href="https://typora-notes-xiaojia.oss-cn-beijing.aliyuncs.com/mujxn.cn/WechatIMG47.jpg" target="_blank"><img class="post-qr-code-img" alt="微信" src="https://typora-notes-xiaojia.oss-cn-beijing.aliyuncs.com/mujxn.cn/WechatIMG47.jpg"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://typora-notes-xiaojia.oss-cn-beijing.aliyuncs.com/mujxn.cn/WechatIMG46.jpg" target="_blank"><img class="post-qr-code-img" alt="支付宝" src="https://typora-notes-xiaojia.oss-cn-beijing.aliyuncs.com/mujxn.cn/WechatIMG46.jpg"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div><div class="console-card-group"><div class="console-card-group-left"><div class="console-card" id="card-newest-comments"><div class="card-content"><div class="author-content-item-tips">互动</div><span class="author-content-item-title"> 最新评论</span></div><div class="aside-list"><span>正在加载中...</span></div></div></div><div class="console-card-group-right"><div class="console-card tags"><div class="card-content"><div class="author-content-item-tips">兴趣点</div><span class="author-content-item-title">寻找你感兴趣的领域</span></div></div><div class="console-card history"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-box-archiv"></i><span>文章</span></div></div></div></div><div class="button-group"><div class="console-btn-item"><a class="darkmode_switchbutton" title="显示模式切换" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-moon"></i></a></div><div class="console-btn-item" id="consoleHideAside" onclick="anzhiyu.hideAsideBtn()" title="边栏显示控制"><a class="asideSwitch"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></a></div><div class="console-btn-item" id="consoleMusic" onclick="anzhiyu.musicToggle()" title="音乐开关"><a class="music-switch"><i class="anzhiyufont anzhiyu-icon-music"></i></a></div></div><div class="console-mask" onclick="anzhiyu.hideConsole()" href="javascript:void(0);"></div></div><div class="nav-button" id="nav-totop"><a class="totopbtn" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i><span id="percent" onclick="anzhiyu.scrollToDest(0,500)">0</span></a></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);" title="切换"><i class="anzhiyufont anzhiyu-icon-bars"></i></a></div></div></div></nav><div id="post-info"><div id="post-firstinfo"><div class="meta-firstline"><a class="post-meta-original">原创</a><span class="post-meta-categories"><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-inbox post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/" itemprop="url">大数据</a></span><span class="article-meta tags"><a class="article-meta__tags" href="/tags/hive/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>hive</span></a></span></div></div><h1 class="post-title" itemprop="name headline">hive</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="anzhiyufont anzhiyu-icon-calendar-days post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" itemprop="dateCreated datePublished" datetime="2021-02-21T12:43:57.000Z" title="发表于 2021-02-21 20:43:57">2021-02-21</time><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-history post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" itemprop="dateCreated datePublished" datetime="2022-09-27T15:36:15.000Z" title="更新于 2022-09-27 23:36:15">2022-09-27</time></span></div><div class="meta-secondline"><span class="post-meta-separator"></span><span class="post-meta-pv-cv" id="" data-flag-title="hive"><i class="anzhiyufont anzhiyu-icon-fw-eye post-meta-icon"></i><span class="post-meta-label" title="阅读量">阅读量:</span><span id="busuanzi_value_page_pv"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-spin"></i></span></span><span class="post-meta-separator">       </span><span class="post-meta-position" title="作者IP属地为新乡"><i class="anzhiyufont anzhiyu-icon-location-dot"></i>新乡</span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section><div id="post-top-cover"><img class="nolazyload" id="post-top-bg" src="https://api-storage.4ce.cn/v1/56377fd133a97667091971790db975ba.jpg"></div></header><main id="blog-container"><div class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container" itemscope itemtype="http://mujxn.cn/2021/02/21/hive/"><header><a class="post-meta-categories" href="/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/" itemprop="url">大数据</a><a href="/tags/hive/" tabindex="-1" itemprop="url">hive</a><h1 id="CrawlerTitle" itemprop="name headline">hive</h1><span itemprop="author" itemscope itemtype="http://schema.org/Person">小贾嗯嗯</span><time itemprop="dateCreated datePublished" datetime="2021-02-21T12:43:57.000Z" title="发表于 2021-02-21 20:43:57">2021-02-21</time><time itemprop="dateCreated datePublished" datetime="2022-09-27T15:36:15.000Z" title="更新于 2022-09-27 23:36:15">2022-09-27</time></header><h3 id="Hive基本操作"><a href="#Hive基本操作" class="headerlink" title="Hive基本操作"></a>Hive基本操作</h3><h4 id="（1）启动hive"><a href="#（1）启动hive" class="headerlink" title="（1）启动hive"></a>（1）启动hive</h4><p><code>bin/hive</code></p>
<h4 id="（2）查看数据库"><a href="#（2）查看数据库" class="headerlink" title="（2）查看数据库"></a>（2）查看数据库</h4><p><code>hive&gt; show databases;</code></p>
<h4 id="（3）打开默认数据库"><a href="#（3）打开默认数据库" class="headerlink" title="（3）打开默认数据库"></a>（3）打开默认数据库</h4><p><code>hive&gt; use default;</code></p>
<h4 id="（4）显示default数据库中的表"><a href="#（4）显示default数据库中的表" class="headerlink" title="（4）显示default数据库中的表"></a>（4）显示default数据库中的表</h4><p><code>hive&gt; show tables;</code></p>
<h4 id="（5）创建一张表"><a href="#（5）创建一张表" class="headerlink" title="（5）创建一张表"></a>（5）创建一张表</h4><p><code>hive&gt; create table student(id int, name string);</code></p>
<h4 id="（6）显示数据库中有几张表"><a href="#（6）显示数据库中有几张表" class="headerlink" title="（6）显示数据库中有几张表"></a>（6）显示数据库中有几张表</h4><p><code>hive&gt; show tables;</code></p>
<h4 id="（7）查看表的结构"><a href="#（7）查看表的结构" class="headerlink" title="（7）查看表的结构"></a>（7）查看表的结构</h4><p><code>hive&gt; desc student;</code></p>
<h4 id="（8）向表中插入数据"><a href="#（8）向表中插入数据" class="headerlink" title="（8）向表中插入数据"></a>（8）向表中插入数据</h4><p><code>hive&gt; insert into student values(1000,&quot;ss&quot;);</code></p>
<h4 id="（9）查询表中数据"><a href="#（9）查询表中数据" class="headerlink" title="（9）查询表中数据"></a>（9）查询表中数据</h4><p><code>hive&gt; select * from student;</code></p>
<h4 id="（10）退出hive"><a href="#（10）退出hive" class="headerlink" title="（10）退出hive"></a>（10）退出hive</h4><p><code>hive&gt; quit;</code></p>
<h3 id="Hive实际操作"><a href="#Hive实际操作" class="headerlink" title="Hive实际操作"></a>Hive实际操作</h3><h4 id="（1）启动hive-1"><a href="#（1）启动hive-1" class="headerlink" title="（1）启动hive"></a>（1）启动hive</h4><p><code>bin/hive</code></p>
<h4 id="（2）显示数据库"><a href="#（2）显示数据库" class="headerlink" title="（2）显示数据库"></a>（2）显示数据库</h4><p><code>hive&gt; show databases;</code></p>
<h4 id="（3）使用default数据库"><a href="#（3）使用default数据库" class="headerlink" title="（3）使用default数据库"></a>（3）使用default数据库</h4><p><code>hive&gt; use default;</code></p>
<h4 id="（4）显示default数据库中的表-1"><a href="#（4）显示default数据库中的表-1" class="headerlink" title="（4）显示default数据库中的表"></a>（4）显示default数据库中的表</h4><p><code>hive&gt; show tables;</code></p>
<h4 id="（5）删除已创建的student表"><a href="#（5）删除已创建的student表" class="headerlink" title="（5）删除已创建的student表"></a>（5）删除已创建的student表</h4><p><code>hive&gt; drop table student;</code></p>
<h4 id="（6）创建student表-并声明文件分隔符’-t’"><a href="#（6）创建student表-并声明文件分隔符’-t’" class="headerlink" title="（6）创建student表, 并声明文件分隔符’\t’"></a>（6）创建student表, 并声明文件分隔符’\t’</h4><p><code>hive&gt; create table student(id int, name string) ROW FORMAT DELIMITED FIELDS TERMINATED</code></p>
<p> BY ‘\t’;&#96;&#96;&#96;</p>
<h4 id="（7）加载-opt-module-datas-student-txt-文件到student数据库表中。"><a href="#（7）加载-opt-module-datas-student-txt-文件到student数据库表中。" class="headerlink" title="（7）加载&#x2F;opt&#x2F;module&#x2F;datas&#x2F;student.txt 文件到student数据库表中。"></a>（7）加载&#x2F;opt&#x2F;module&#x2F;datas&#x2F;student.txt 文件到student数据库表中。</h4><p><code>hive&gt; load data local inpath &#39;/opt/module/datas/student.txt&#39; into table student;</code></p>
<h4 id="（8）Hive查询结果"><a href="#（8）Hive查询结果" class="headerlink" title="（8）Hive查询结果"></a>（8）Hive查询结果</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">​```hive&gt; select * from student;```</span><br><span class="line"></span><br><span class="line">OK</span><br><span class="line"></span><br><span class="line">1001	zhangshan</span><br><span class="line"></span><br><span class="line">1002	lishi</span><br><span class="line"></span><br><span class="line">1003	zhaoliu</span><br><span class="line"></span><br><span class="line">Time taken: 0.266 seconds, Fetched: 3 row(s)</span><br></pre></td></tr></table></figure>



<h3 id="3．遇到的问题"><a href="#3．遇到的问题" class="headerlink" title="3．遇到的问题"></a>3．遇到的问题</h3><h4 id="再打开一个客户端窗口启动hive，会产生java-sql-SQLException异常。"><a href="#再打开一个客户端窗口启动hive，会产生java-sql-SQLException异常。" class="headerlink" title="再打开一个客户端窗口启动hive，会产生java.sql.SQLException异常。"></a>再打开一个客户端窗口启动hive，会产生java.sql.SQLException异常。</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">Exception in thread &quot;main&quot; java.lang.RuntimeException: java.lang.RuntimeException:</span><br><span class="line"></span><br><span class="line"> Unable to instantiate</span><br><span class="line"></span><br><span class="line"> org.apache.hadoop.hive.ql.metadata.SessionHiveMetaStoreClient</span><br><span class="line"></span><br><span class="line">    at org.apache.hadoop.hive.ql.session.SessionState.start(SessionState.java:522)</span><br><span class="line"></span><br><span class="line">    at org.apache.hadoop.hive.cli.CliDriver.run(CliDriver.java:677)</span><br><span class="line"></span><br><span class="line">    at org.apache.hadoop.hive.cli.CliDriver.main(CliDriver.java:621)</span><br><span class="line"></span><br><span class="line">    at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)</span><br><span class="line"></span><br><span class="line">    at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:57)</span><br><span class="line"></span><br><span class="line">    at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)</span><br><span class="line"></span><br><span class="line">    at java.lang.reflect.Method.invoke(Method.java:606)</span><br><span class="line"></span><br><span class="line">    at org.apache.hadoop.util.RunJar.run(RunJar.java:221)</span><br><span class="line"></span><br><span class="line">    at org.apache.hadoop.util.RunJar.main(RunJar.java:136)</span><br><span class="line"></span><br><span class="line">Caused by: java.lang.RuntimeException: Unable to instantiate org.apache.hadoop.hive.ql.metadata.SessionHiveMetaStoreClient</span><br><span class="line"></span><br><span class="line">    at org.apache.hadoop.hive.metastore.MetaStoreUtils.newInstance(MetaStoreUtils.java:1523)</span><br><span class="line"></span><br><span class="line">    at org.apache.hadoop.hive.metastore.RetryingMetaStoreClient.&lt;init&gt;(RetryingMetaStoreClient.java:86)</span><br><span class="line"></span><br><span class="line">    at org.apache.hadoop.hive.metastore.RetryingMetaStoreClient.getProxy(RetryingMetaStoreClient.java:132)</span><br><span class="line"></span><br><span class="line">    at org.apache.hadoop.hive.metastore.RetryingMetaStoreClient.getProxy(RetryingMetaStoreClient.java:104)</span><br><span class="line"></span><br><span class="line">    at org.apache.hadoop.hive.ql.metadata.Hive.createMetaStoreClient(Hive.java:3005)</span><br><span class="line"></span><br><span class="line">    at org.apache.hadoop.hive.ql.metadata.Hive.getMSC(Hive.java:3024)</span><br><span class="line"></span><br><span class="line">    at org.apache.hadoop.hive.ql.session.SessionState.start(SessionState.java:503)</span><br><span class="line"></span><br><span class="line">... 8 more</span><br></pre></td></tr></table></figure>



<p>原因是，Metastore默认存储在自带的derby数据库中，推荐使用MySQL存储Metastore;&#96;&#96;&#96;</p>
<h3 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>javax.jdo.option.ConnectionURL<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>jdbc:mysql://localhost:3306/hive?createDatabaseIfNotExist=true<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">description</span>&gt;</span>Mysql连接协议<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>javax.jdo.option.ConnectionName<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>com.mysql.jdbc.Driver<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">description</span>&gt;</span>JDBC连接驱动<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>javax.jdo.option.ConnectionUserName<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>root<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">description</span>&gt;</span>用户名<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>javax.jdo.option.ConnectionPassword<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>123456<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">description</span>&gt;</span>密码<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    # 显示当前数据库，以及查询表的头信息配置。</span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>hive.cli.print.header<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>true<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>hive.cli.print.current.db<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>true<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="HiveJDBC访问"><a href="#HiveJDBC访问" class="headerlink" title="HiveJDBC访问"></a>HiveJDBC访问</h3><h4 id="2-6-1启动hiveserver2服务"><a href="#2-6-1启动hiveserver2服务" class="headerlink" title="2.6.1启动hiveserver2服务"></a>2.6.1启动hiveserver2服务</h4><p><code> bin/hiveserver2</code></p>
<h4 id="2-6-2启动beeline"><a href="#2-6-2启动beeline" class="headerlink" title="2.6.2启动beeline"></a>2.6.2启动beeline</h4><p><code>bin/beeline</code></p>
<p><code>Beeline version 1.2.1 by Apache Hive</code></p>
<p><code>beeline&gt;</code></p>
<h3 id="2-6-3连接hiveserver2"><a href="#2-6-3连接hiveserver2" class="headerlink" title="2.6.3连接hiveserver2"></a>2.6.3连接hiveserver2</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">beeline&gt; !connect jdbc:hive2://hadoop01:10000（回车）</span><br><span class="line"></span><br><span class="line">Connecting to jdbc:hive2://hadoop01:10000</span><br><span class="line"></span><br><span class="line">Enter username for jdbc:hive2://hadoop01:10000: xiaojia（回车）</span><br><span class="line"></span><br><span class="line">Enter password for jdbc:hive2://hadoop01:10000: （直接回车）</span><br><span class="line"></span><br><span class="line">Connected to: Apache Hive (version 1.2.1)</span><br><span class="line"></span><br><span class="line">Driver: Hive JDBC (version 1.2.1)</span><br><span class="line"></span><br><span class="line">Transaction isolation: TRANSACTION_REPEATABLE_READ</span><br><span class="line"></span><br><span class="line">0: jdbc:hive2://hadoop01:10000&gt; show databases;```</span><br><span class="line"></span><br><span class="line">+----------------+--+</span><br><span class="line"></span><br><span class="line">| database_name  |</span><br><span class="line"></span><br><span class="line">+----------------+--+</span><br><span class="line"></span><br><span class="line">| default     |</span><br><span class="line"></span><br><span class="line">| hive_db2    |</span><br><span class="line"></span><br><span class="line">+----------------+--+</span><br></pre></td></tr></table></figure>

<h3 id="2-7-Hive常用交互命令"><a href="#2-7-Hive常用交互命令" class="headerlink" title="2.7 Hive常用交互命令"></a>2.7 Hive常用交互命令</h3><p>bin&#x2F;hive -help</p>
<h4 id="1．“-e”不进入hive的交互窗口执行sql语句"><a href="#1．“-e”不进入hive的交互窗口执行sql语句" class="headerlink" title="1．“-e”不进入hive的交互窗口执行sql语句"></a>1．“-e”不进入hive的交互窗口执行sql语句</h4><p>[xiaojia@hadoop01 hive]$ bin&#x2F;hive -e “select id from student;&#96;&#96;&#96;”</p>
<h4 id="2．“-f”执行脚本中sql语句"><a href="#2．“-f”执行脚本中sql语句" class="headerlink" title="2．“-f”执行脚本中sql语句"></a>2．“-f”执行脚本中sql语句</h4><pre><code>（1）在data目录下创建hivef.sql文件
</code></pre>
<p> <code>touch hivef.sql</code></p>
<pre><code>    文件中写入正确的sql语句

    ```select *from student;```

（2）执行文件中的sql语句
</code></pre>
<p><code>bin/hive -f /opt/module/datas/hivef.sql</code></p>
<p>（3）执行文件中的sql语句并将结果写入文件中</p>
<p><code>bin/hive -f /opt/module/datas/hivef.sql  &gt; /opt/module/datas/hive_result.txt</code></p>
<h3 id="3-Hive数据类型"><a href="#3-Hive数据类型" class="headerlink" title="3 Hive数据类型"></a>3 Hive数据类型</h3><h4 id="3-1-基本数据类型"><a href="#3-1-基本数据类型" class="headerlink" title="3.1 基本数据类型"></a>3.1 基本数据类型</h4><table>
<thead>
<tr>
<th>Hive数据类型</th>
<th>Java数据类型</th>
<th>长度</th>
<th>例子</th>
</tr>
</thead>
<tbody><tr>
<td>TINYINT</td>
<td>byte</td>
<td>1byte有符号整数</td>
<td>20</td>
</tr>
<tr>
<td>SMALINT</td>
<td>short</td>
<td>2byte有符号整数</td>
<td>20</td>
</tr>
<tr>
<td>INT</td>
<td>int</td>
<td>4byte有符号整数</td>
<td>20</td>
</tr>
<tr>
<td>BIGINT</td>
<td>long</td>
<td>8byte有符号整数</td>
<td>20</td>
</tr>
<tr>
<td>BOOLEAN</td>
<td>boolean</td>
<td>布尔类型，true或者false</td>
<td>TRUE  FALSE</td>
</tr>
<tr>
<td>FLOAT</td>
<td>float</td>
<td>单精度浮点数</td>
<td>3.14159</td>
</tr>
<tr>
<td>DOUBLE</td>
<td>double</td>
<td>双精度浮点数</td>
<td>3.14159</td>
</tr>
<tr>
<td>STRING</td>
<td>string</td>
<td>字符系列。可以指定字符集。可以使用单引号或者双引号。</td>
<td>‘now is the time’ “for all good men”</td>
</tr>
<tr>
<td>TIMESTAMP</td>
<td></td>
<td>时间类型</td>
<td></td>
</tr>
<tr>
<td>BINARY</td>
<td></td>
<td>字节数组</td>
<td></td>
</tr>
</tbody></table>
<pre><code>    **对于Hive的String类型相当于数据库的varchar类型，该类型是一个可变的字符串，不过它不能声明其中最多能存储多少个字符，理论上它可以存储2GB的字符数。**
</code></pre>
<h4 id="3-2-集合数据类型"><a href="#3-2-集合数据类型" class="headerlink" title="3.2 集合数据类型"></a>3.2 集合数据类型</h4><table>
<thead>
<tr>
<th>数据类型</th>
<th>描述</th>
<th>语法示例</th>
</tr>
</thead>
<tbody><tr>
<td>STRUCT</td>
<td>和c语言中的struct类似，都可以通过“点”符号访问元素内容。例如，如果某个列的数据类型是STRUCT{first STRING, last STRING},那么第1个元素可以通过字段.first来引用。</td>
<td>struct()</td>
</tr>
<tr>
<td>MAP</td>
<td>MAP是一组键-值对元组集合，使用数组表示法可以访问数据。例如，如果某个列的数据类型是MAP，其中键-&gt;值对是’first’-&gt;’John’和’last’-&gt;’Doe’，那么可以通过字段名[‘last’]获取最后一个元素</td>
<td>map()</td>
</tr>
<tr>
<td>ARRAY</td>
<td>数组是一组具有相同类型和名称的变量的集合。这些变量称为数组的元素，每个数组元素都有一个编号，编号从零开始。例如，数组值为[‘John’, ‘Doe’]，那么第2个元素可以通过数组名[1]进行引用。</td>
<td>Array()</td>
</tr>
</tbody></table>
<pre><code>    **Hive有三种复杂数据类型ARRAY、MAP 和 STRUCT。ARRAY和MAP与Java中的Array和Map类似，而STRUCT与C语言中的Struct类似，它封装了一个命名字段集合，复杂数据类型允许任意层次的嵌套。**
</code></pre>
<h3 id="案例实操"><a href="#案例实操" class="headerlink" title="案例实操"></a>案例实操</h3><h4 id="1）-假设某表有如下一行，我们用JSON格式来表示其数据结构。在Hive下访问的格式为"><a href="#1）-假设某表有如下一行，我们用JSON格式来表示其数据结构。在Hive下访问的格式为" class="headerlink" title="1） 假设某表有如下一行，我们用JSON格式来表示其数据结构。在Hive下访问的格式为"></a>1） 假设某表有如下一行，我们用JSON格式来表示其数据结构。在Hive下访问的格式为</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;songsong&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;friends&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;bingbing&quot;</span> <span class="punctuation">,</span> <span class="string">&quot;lili&quot;</span><span class="punctuation">]</span> <span class="punctuation">,</span>    <span class="comment">//列表Array,</span></span><br><span class="line">    <span class="attr">&quot;children&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span>            <span class="comment">//键值Map,</span></span><br><span class="line">    	<span class="attr">&quot;xiao song&quot;</span><span class="punctuation">:</span> <span class="number">18</span> <span class="punctuation">,</span></span><br><span class="line">    	<span class="attr">&quot;xiaoxiao song&quot;</span><span class="punctuation">:</span> <span class="number">19</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="attr">&quot;address&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span>            <span class="comment">//结构Struct,</span></span><br><span class="line">    	<span class="attr">&quot;street&quot;</span><span class="punctuation">:</span> <span class="string">&quot;hui long guan&quot;</span> <span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;city&quot;</span><span class="punctuation">:</span> <span class="string">&quot;beijing&quot;</span></span><br><span class="line">	<span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>





<h4 id="2）基于上述数据结构，我们在Hive里创建对应的表，并导入数据。"><a href="#2）基于上述数据结构，我们在Hive里创建对应的表，并导入数据。" class="headerlink" title="2）基于上述数据结构，我们在Hive里创建对应的表，并导入数据。"></a>2）基于上述数据结构，我们在Hive里创建对应的表，并导入数据。</h4><h5 id="创建本地测试文件test-txt"><a href="#创建本地测试文件test-txt" class="headerlink" title="创建本地测试文件test.txt"></a>创建本地测试文件test.txt</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">songsong,bingbing_lili,xiao song:18_xiaoxiao song:19,hui long guan_beijingyangyang,caicai_susu,xiao yang:18_xiaoxiao yang:19,chao yang_beijing</span><br></pre></td></tr></table></figure>

<p>注意：MAP，STRUCT和ARRAY里的元素间关系都可以用同一个字符表示，这里用“_”。</p>
<h5 id="3）Hive上创建测试表test"><a href="#3）Hive上创建测试表test" class="headerlink" title="3）Hive上创建测试表test"></a>3）Hive上创建测试表test</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">create table test(</span><br><span class="line">    name string,</span><br><span class="line">    friends array&lt;string&gt;,</span><br><span class="line">    children map&lt;string, int&gt;,</span><br><span class="line">    address struct&lt;street:string, city:string&gt;)</span><br><span class="line">    row format delimited fields terminated by &#x27;,&#x27;</span><br><span class="line">    collection items terminated by &#x27;_&#x27;</span><br><span class="line">    map keys terminated by &#x27;:&#x27;</span><br><span class="line">    lines terminated by &#x27;\n&#x27;;```</span><br></pre></td></tr></table></figure>

<p>字段解释：</p>
<p><strong>row format delimited fields terminated by ‘,’  – 列分隔符</strong></p>
<p><strong>collection items terminated by ‘_’  –MAP STRUCT 和 ARRAY 的分隔符(数据分割符号)</strong></p>
<p><strong>map keys terminated by ‘:’				– MAP中的key与value的分隔符</strong></p>
<p><strong>lines terminated by ‘\n’;&#96;&#96;&#96;					– 行分隔符</strong></p>
<h4 id="4）导入文本数据到测试表"><a href="#4）导入文本数据到测试表" class="headerlink" title="4）导入文本数据到测试表"></a>4）导入文本数据到测试表</h4><p><code>hive (default)&gt; load data local inpath ‘/opt/module/datas/test.txt’into table test</code></p>
<h4 id="5）访问三种集合列里的数据，以下分别是ARRAY，MAP，STRUCT的访问方式"><a href="#5）访问三种集合列里的数据，以下分别是ARRAY，MAP，STRUCT的访问方式" class="headerlink" title="5）访问三种集合列里的数据，以下分别是ARRAY，MAP，STRUCT的访问方式"></a>5）访问三种集合列里的数据，以下分别是ARRAY，MAP，STRUCT的访问方式</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">​```hive (default)&gt; select friends[1],children[&#x27;xiao song&#x27;],address.city from test</span><br><span class="line">where name=&quot;songsong&quot;;```</span><br><span class="line">OK</span><br><span class="line">_c0   _c1   citylili   18    beijing</span><br><span class="line">Time taken: 0.076 seconds, Fetched: 1 row(s)</span><br></pre></td></tr></table></figure>



<h3 id="3-3-类型转化"><a href="#3-3-类型转化" class="headerlink" title="3.3 类型转化"></a>3.3 类型转化</h3><p>Hive的原子数据类型是可以进行隐式转换的，类似于Java的类型转换，例如某表达式使用INT类型，TINYINT会自动转换为INT类型，但是Hive不会进行反向转化，例如，某表达式使用TINYINT类型，INT不会自动转换为TINYINT类型，它会返回错误，除非使用CAST操作。</p>
<p>1．隐式类型转换规则如下</p>
<p>（1）任何整数类型都可以隐式地转换为一个范围更广的类型，如TINYINT可以转换成INT，INT可以转换成BIGINT。</p>
<p>（2）所有整数类型、FLOAT和STRING类型都可以隐式地转换成DOUBLE。</p>
<p>（3）TINYINT、SMALLINT、INT都可以转换为FLOAT。</p>
<p>（4）BOOLEAN类型不可以转换为任何其它的类型。</p>
<p>2．可以使用CAST操作显示进行数据类型转换</p>
<p>例如CAST(‘1’ AS INT)将把字符串’1’ 转换成整数1；如果强制类型转换失败，如执行CAST(‘X’ AS INT)，表达式返回空值 NULL。</p>
<h1 id="第4章-DDL数据定义"><a href="#第4章-DDL数据定义" class="headerlink" title="第4章 DDL数据定义"></a><strong>第4章</strong> <strong>DDL数据定义</strong></h1><h2 id="4-1-创建数据库"><a href="#4-1-创建数据库" class="headerlink" title="4.1 创建数据库"></a><strong>4.1 创建数据库</strong></h2><p>1）创建一个数据库，数据库在HDFS上的默认存储路径是&#x2F;user&#x2F;hive&#x2F;warehouse&#x2F;*.db。</p>
<p><code>hive (default)&gt; create database db_hive;</code></p>
<p>2）避免要创建的数据库已经存在错误，增加if not exists判断。（标准写法）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">​```hive (default)&gt; create database db_hive;```</span><br><span class="line">FAILED: Execution Error, return code 1 from org.apache.hadoop.hive.ql.exec.DDLTask. Database db_hive already exists```hive (default)&gt; create database if not exists db_hive;```</span><br></pre></td></tr></table></figure>



<p>3）创建一个数据库，指定数据库在HDFS上存放的位置</p>
<p><code>hive (default)&gt; create database db_hive2 location &#39;/db_hive2.db&#39;;</code></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="file:////tmp/wps-xiaojia/ksohtml/wpsTJtCB9.jpg" alt="img"> </p>
<p>图6-4 数据库存放位置</p>
<h2 id="4-2-查询数据库"><a href="#4-2-查询数据库" class="headerlink" title="4.2 查询数据库"></a><strong>4.2 查询数据库</strong></h2><h3 id="4-2-1-显示数据库"><a href="#4-2-1-显示数据库" class="headerlink" title="4.2.1 显示数据库"></a><strong>4.2.1 显示数据库</strong></h3><p>1．显示数据库</p>
<p><code>hive&gt; show databases;</code></p>
<p>2．过滤显示查询的数据库</p>
<p><code>hive&gt; show databases like &#39;db_hive*&#39;;</code></p>
<p>OK</p>
<p>db_hive</p>
<p>db_hive_1</p>
<h3 id="4-2-2-查看数据库详情"><a href="#4-2-2-查看数据库详情" class="headerlink" title="4.2.2 查看数据库详情"></a><strong>4.2.2 查看数据库详情</strong></h3><p>1．显示数据库信息</p>
<p><code>hive&gt; desc database db_hive;</code></p>
<p>OK</p>
<p>db_hive		hdfs:&#x2F;&#x2F;hadoop01:9000&#x2F;user&#x2F;hive&#x2F;warehouse&#x2F;db_hive.db	xiaojiaUSER	</p>
<p>2．显示数据库详细信息，extended</p>
<p><code>hive&gt; desc database extended db_hive;</code></p>
<p>OK</p>
<p>db_hive		hdfs:&#x2F;&#x2F;hadoop01:9000&#x2F;user&#x2F;hive&#x2F;warehouse&#x2F;db_hive.db	xiaojiaUSER	</p>
<p>40.3.3 切换当前数据库</p>
<p><code>hive (default)&gt; use db_hive;</code></p>
<h3 id="4-3-3-切换当前数据库"><a href="#4-3-3-切换当前数据库" class="headerlink" title="4.3.3 切换当前数据库"></a><strong>4.3.3 切换当前数据库</strong></h3><p><code>hive (default)&gt; use db_hive;</code></p>
<h2 id="4-3-修改数据库"><a href="#4-3-修改数据库" class="headerlink" title="4.3 修改数据库"></a><strong>4.3 修改数据库</strong></h2><p>用户可以使用ALTER DATABASE命令为某个数据库的DBPROPERTIES设置键-值对属性值，来描述这个数据库的属性信息。数据库的其他元数据信息都是不可更改的，包括数据库名和数据库所在的目录位置。</p>
<p><code>hive (default)&gt; alter database db_hive set dbproperties(&#39;createtime&#39;=&#39;20170830&#39;);</code></p>
<p>在hive中查看修改结果</p>
<p><code>hive&gt; desc database extended db_hive;</code></p>
<p>db_name comment location     owner_name    owner_type    parameters</p>
<p>db_hive     hdfs:&#x2F;&#x2F;hadoop01:8020&#x2F;user&#x2F;hive&#x2F;warehouse&#x2F;db_hive.db   xiaojia USER   {createtime&#x3D;20170830}</p>
<h2 id="4-4-删除数据库"><a href="#4-4-删除数据库" class="headerlink" title="4.4 删除数据库"></a><strong>4.4 删除数据库</strong></h2><p>1．删除空数据库</p>
<p><code>hive&gt;drop database db_hive2;</code></p>
<p>2．如果删除的数据库不存在，最好采用 if exists判断数据库是否存在</p>
<p><code>hive&gt; drop database db_hive;</code></p>
<p>FAILED: SemanticException [Error 10072]: Database does not exist: db_hive</p>
<p><code>hive&gt; drop database if exists db_hive2;</code></p>
<p>3．如果数据库不为空，可以采用cascade命令，强制删除</p>
<p><code>hive&gt; drop database db_hive;</code></p>
<p>FAILED: Execution Error, return code 1 from org.apache.hadoop.hive.ql.exec.DDLTask. InvalidOperationException(message:Database db_hive is not empty. One or more tables exist.)</p>
<p><code>hive&gt; drop database db_hive cascade;</code></p>
<h2 id="4-5-创建表"><a href="#4-5-创建表" class="headerlink" title="4.5 创建表"></a><strong>4.5 创建表</strong></h2><p>1．建表语法</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">CREATE [EXTERNAL] TABLE [IF NOT EXISTS] table_name </span><br><span class="line"></span><br><span class="line">[(col_name data_type [COMMENT col_comment], ...)] </span><br><span class="line"></span><br><span class="line">[COMMENT table_comment] </span><br><span class="line"></span><br><span class="line">[PARTITIONED BY (col_name data_type [COMMENT col_comment], ...)] </span><br><span class="line"></span><br><span class="line">[CLUSTERED BY (col_name, col_name, ...) </span><br><span class="line"></span><br><span class="line">[SORTED BY (col_name [ASC|DESC], ...)] INTO num_buckets BUCKETS] </span><br><span class="line"></span><br><span class="line">[ROW FORMAT row_format] </span><br><span class="line"></span><br><span class="line">[STORED AS file_format] </span><br><span class="line"></span><br><span class="line">[LOCATION hdfs_path]</span><br></pre></td></tr></table></figure>



<p>2．字段解释说明 </p>
<p>（1）CREATE TABLE 创建一个指定名字的表。如果相同名字的表已经存在，则抛出异常；用户可以用 IF NOT EXISTS 选项来忽略这个异常。</p>
<p>（2）EXTERNAL关键字可以让用户创建一个外部表，在建表的同时指定一个指向实际数据的路径（LOCATION），Hive创建内部表时，会将数据移动到数据仓库指向的路径；若创建外部表，仅记录数据所在的路径，不对数据的位置做任何改变。在删除表的时候，内部表的元数据和数据会被一起删除，而外部表只删除元数据，不删除数据。</p>
<p>（3）COMMENT：为表和列添加注释。</p>
<p>（4）PARTITIONED BY创建分区表</p>
<p>（5）CLUSTERED BY创建分桶表</p>
<p>（6）SORTED BY不常用</p>
<p>（7）ROW FORMAT </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">DELIMITED [FIELDS TERMINATED BY char] [COLLECTION ITEMS TERMINATED BY char]</span><br><span class="line"></span><br><span class="line">    [MAP KEYS TERMINATED BY char] [LINES TERMINATED BY char] </span><br><span class="line"></span><br><span class="line">  | SERDE serde_name [WITH SERDEPROPERTIES (property_name=property_value, property_name=property_value, ...)]</span><br></pre></td></tr></table></figure>



<p>用户在建表的时候可以自定义SerDe或者使用自带的SerDe。如果没有指定ROW FORMAT 或者ROW FORMAT DELIMITED，将会使用自带的SerDe。在建表的时候，用户还需要为表指定列，用户在指定表的列的同时也会指定自定义的SerDe，Hive通过SerDe确定表的具体的列的数据。</p>
<p>SerDe是Serialize&#x2F;Deserilize的简称，目的是用于序列化和反序列化。</p>
<p>（8）STORED AS指定存储文件类型</p>
<p>常用的存储文件类型：SEQUENCEFILE（二进制序列文件）、TEXTFILE（文本）、RCFILE（列式存储格式文件）</p>
<p>如果文件数据是纯文本，可以使用STORED AS TEXTFILE。如果数据需要压缩，使用 STORED AS SEQUENCEFILE。</p>
<p>（9）LOCATION ：指定表在HDFS上的存储位置。</p>
<p>（10）LIKE允许用户复制现有的表结构，但是不复制数据。</p>
<h3 id="4-5-1-管理表"><a href="#4-5-1-管理表" class="headerlink" title="4.5.1 管理表"></a><strong>4.5.1 管理表</strong></h3><p>1．理论</p>
<p>默认创建的表都是所谓的管理表，有时也被称为内部表。因为这种表，Hive会（或多或少地）控制着数据的生命周期。Hive默认情况下会将这些表的数据存储在由配置项hive.metastore.warehouse.dir(例如，&#x2F;user&#x2F;hive&#x2F;warehouse)所定义的目录的子目录下。	当我们删除一个管理表时，Hive也会删除这个表中数据。管理表不适合和其他工具共享数据。</p>
<p>2．案例实操</p>
<p>（1）普通创建表</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">create table if not exists student2(id int, name string)</span><br><span class="line">row format delimited fields terminated by &#x27;\t&#x27;</span><br><span class="line">stored as textfile</span><br><span class="line">location &#x27;/user/hive/warehouse/student2&#x27;;```</span><br></pre></td></tr></table></figure>



<p>（2）根据查询结果创建表（查询的结果会添加到新创建的表中）</p>
<p><code>create table if not exists student3 as select id, name from student;</code></p>
<p>（3）根据已经存在的表结构创建表</p>
<p><code>create table if not exists student4 like student;</code></p>
<p>（4）查询表的类型</p>
<p><code>hive (default)&gt; desc formatted student2;</code></p>
<p>Table Type:       MANAGED_TABLE  </p>
<h3 id="4-5-2-外部表"><a href="#4-5-2-外部表" class="headerlink" title="4.5.2 外部表"></a><strong>4.5.2 外部表</strong></h3><p>1．理论</p>
<p>因为表是外部表，所以Hive并非认为其完全拥有这份数据。删除该表并不会删除掉这份数据，不过描述表的元数据信息会被删除掉。</p>
<p>2．管理表和外部表的使用场景</p>
<p>每天将收集到的网站日志定期流入HDFS文本文件。在外部表（原始日志表）的基础上做大量的统计分析，用到的中间表、结果表使用内部表存储，数据通过SELECT+INSERT进入内部表。</p>
<p>3．案例实操</p>
<p>分别创建部门和员工外部表，并向表中导入数据。</p>
<p>（1）原始数据</p>
<pre><code>    ![img](file:////tmp/wps-xiaojia/ksohtml/wpsbXzU3C.png)  ![img](file:////tmp/wps-xiaojia/ksohtml/wpsNRchw6.png) 

（2）建表语句

    创建部门表
</code></pre>
<p><code>create external table if not exists default.dept(deptno int,dname string,loc int)row format delimited fields terminated by &#39;\t&#39;;</code></p>
<pre><code>    创建员工表
</code></pre>
<p><code>create external table if not exists default.emp(empno int,ename string,job string,mgr int,hiredate string, sal double, comm double,deptno int)row format delimited fields terminated by &#39;\t&#39;;</code></p>
<p>（3）查看创建的表</p>
<p><code>hive (default)&gt; show tables;</code></p>
<p>OK</p>
<p>tab_name</p>
<p>dept</p>
<p>emp</p>
<pre><code>（4）向外部表中导入数据

    导入数据
</code></pre>
<p><code>hive (default)&gt; load data local inpath &#39;/opt/module/datas/dept.txt&#39; into table default.dept;</code></p>
<p><code>hive (default)&gt; load data local inpath &#39;/opt/module/datas/emp.txt&#39; into table default.emp;</code></p>
<p>查询结果</p>
<p><code>hive (default)&gt; select * from emp;</code></p>
<p><code>hive (default)&gt; select * from dept;</code></p>
<pre><code>（5）查看表格式化数据
</code></pre>
<p><code>hive (default)&gt; desc formatted dept;</code></p>
<p>Table Type:       EXTERNAL_TABLE</p>
<h3 id="4-5-3-管理表与外部表的互相转换"><a href="#4-5-3-管理表与外部表的互相转换" class="headerlink" title="**4.5.3 **管理表与外部表的互相转换"></a>**4.5.3 **管理表与外部表的互相转换</h3><p>（1）查询表的类型</p>
<p><code>hive (default)&gt; desc formatted student2;</code></p>
<p>Table Type:       MANAGED_TABLE</p>
<p>（2）修改内部表student2为外部表</p>
<p><code>alter table student2 set tblproperties(&#39;EXTERNAL&#39;=&#39;TRUE&#39;);</code></p>
<p>（3）查询表的类型</p>
<p><code>hive (default)&gt; desc formatted student2;</code></p>
<p>Table Type:       EXTERNAL_TABLE</p>
<p>（4）修改外部表student2为内部表</p>
<p><code>alter table student2 set tblproperties(&#39;EXTERNAL&#39;=&#39;FALSE&#39;);</code></p>
<p>（5）查询表的类型</p>
<p><code>hive (default)&gt; desc formatted student2;</code></p>
<p>Table Type:       MANAGED_TABLE</p>
<p>注意：(‘EXTERNAL’&#x3D;’TRUE’)和(‘EXTERNAL’&#x3D;’FALSE’)为固定写法，区分大小写！</p>
<h2 id="4-6-分区表"><a href="#4-6-分区表" class="headerlink" title="4.6 分区表"></a><strong>4.6 分区表</strong></h2><p>分区表实际上就是对应一个HDFS文件系统上的独立的文件夹，该文件夹下是该分区所有的数据文件。Hive中的分区就是分目录，把一个大的数据集根据业务需要分割成小的数据集。在查询时通过WHERE子句中的表达式选择查询所需要的指定的分区，这样的查询效率会提高很多。</p>
<h3 id="4-6-1-分区表基本操作"><a href="#4-6-1-分区表基本操作" class="headerlink" title="4.6.1 分区表基本操作"></a><strong>4.6.1 分区表基本操作</strong></h3><p>1．引入分区表（需要根据日期对日志进行管理）</p>
<p><code>/user/hive/warehouse/log_partition/20170702/20170702.log</code></p>
<p><code>/user/hive/warehouse/log_partition/20170703/20170703.log</code></p>
<p><code>/user/hive/warehouse/log_partition/20170704/20170704.log</code></p>
<p>2．创建分区表语法</p>
<p><code>hive (default)&gt; create table dept_partition(deptno int, dname string, loc string)partitioned by (month string)row format delimited fields terminated by &#39;\t&#39;;</code></p>
<p>3．加载数据到分区表中</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">​```hive (default)&gt; load data local inpath &#x27;/opt/module/datas/dept.txt&#x27; into table default.dept_partition partition(month=&#x27;201709&#x27;);```</span><br><span class="line"></span><br><span class="line">​```hive (default)&gt; load data local inpath &#x27;/opt/module/datas/dept.txt&#x27; into table default.dept_partition partition(month=&#x27;201708&#x27;);```</span><br><span class="line"></span><br><span class="line">​```hive (default)&gt; load data local inpath &#x27;/opt/module/datas/dept.txt&#x27; into table default.dept_partition partition(month=&#x27;201707’);```</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="file:////tmp/wps-xiaojia/ksohtml/wpsTUWNYz.jpg" alt="img"> </p>
<p>图6-5 加载数据到分区表</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="file:////tmp/wps-xiaojia/ksohtml/wpseg0nr3.jpg" alt="img"> </p>
<p>图6-6 分区表</p>
<p>4．查询分区表中数据</p>
<pre><code>单分区查询
</code></pre>
<p><code>hive (default)&gt; select * from dept_partition where month=&#39;201709&#39;;</code></p>
<p>多分区联合查询</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">​```hive (default)&gt; select * from dept_partition where month=&#x27;201709&#x27;</span><br><span class="line"></span><br><span class="line">       union</span><br><span class="line"></span><br><span class="line">       select * from dept_partition where month=&#x27;201708&#x27;</span><br><span class="line"></span><br><span class="line">       union</span><br><span class="line"></span><br><span class="line">       select * from dept_partition where month=&#x27;201707&#x27;;```</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">_u3.deptno    _u3.dname    _u3.loc _u3.month</span><br><span class="line"></span><br><span class="line">10    ACCOUNTING    NEW YORK     201707</span><br><span class="line"></span><br><span class="line">10    ACCOUNTING    NEW YORK     201708</span><br><span class="line"></span><br><span class="line">10    ACCOUNTING    NEW YORK     201709</span><br><span class="line"></span><br><span class="line">20    RESEARCH     DALLAS  201707</span><br><span class="line"></span><br><span class="line">20    RESEARCH     DALLAS  201708</span><br><span class="line"></span><br><span class="line">20    RESEARCH     DALLAS  201709</span><br><span class="line"></span><br><span class="line">30    SALES  CHICAGO 201707</span><br><span class="line"></span><br><span class="line">30    SALES  CHICAGO 201708</span><br><span class="line"></span><br><span class="line">30    SALES  CHICAGO 201709</span><br><span class="line"></span><br><span class="line">40    OPERATIONS    BOSTON  201707</span><br><span class="line"></span><br><span class="line">40    OPERATIONS    BOSTON  201708</span><br><span class="line"></span><br><span class="line">40    OPERATIONS    BOSTON  201709</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>5．增加分区</p>
<pre><code>创建单个分区
</code></pre>
<p><code>hive (default)&gt; alter table dept_partition add partition(month=&#39;201706&#39;) ;</code></p>
<pre><code>同时创建多个分区
</code></pre>
<p><code>hive (default)&gt; alter table dept_partition add partition(month=&#39;201705&#39;) partition(month=&#39;201704&#39;);</code></p>
<p>6．删除分区</p>
<pre><code>删除单个分区
</code></pre>
<p><code>hive (default)&gt; alter table dept_partition drop partition (month=&#39;201704&#39;);</code></p>
<p>同时删除多个分区</p>
<p><code>hive (default)&gt; alter table dept_partition drop partition (month=&#39;201705&#39;), partition (month=&#39;201706&#39;);</code></p>
<p>7．查看分区表有多少分区</p>
<p><code>hive&gt; show partitions dept_partition;</code></p>
<p>8．查看分区表结构</p>
<p><code>hive&gt; desc formatted dept_partition;</code></p>
<p># Partition Information      </p>
<p># col_name        data_type        comment       </p>
<p>month          string   </p>
<h3 id="4-6-2-分区表注意事项"><a href="#4-6-2-分区表注意事项" class="headerlink" title="4.6.2 分区表注意事项"></a><strong>4.6.2 分区表注意事项</strong></h3><p>1．创建二级分区表</p>
<p><code>hive (default)&gt; create table dept_partition2(        deptno int, dname string, loc string        )        partitioned by (month string, day string)        row format delimited fields terminated by &#39;\t&#39;;</code></p>
<p>2．正常的加载数据</p>
<p>（1）加载数据到二级分区表中</p>
<p><code>hive (default)&gt; load data local inpath &#39;/opt/module/datas/dept.txt&#39; into table default.dept_partition2 partition(month=&#39;201709&#39;, day=&#39;13&#39;);</code></p>
<p>（2）查询分区数据</p>
<p><code>hive (default)&gt; select * from dept_partition2 where month=&#39;201709&#39; and day=&#39;13&#39;;</code></p>
<p>3．把数据直接上传到分区目录上，让分区表和数据产生关联的三种方式</p>
<p>（1）方式一：上传数据后修复</p>
<pre><code>上传数据
</code></pre>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">​```hive (default)&gt; dfs -mkdir -p</span><br><span class="line"></span><br><span class="line"> /user/hive/warehouse/dept_partition2/month=201709/day=12;```</span><br><span class="line"></span><br><span class="line">​```hive (default)&gt; dfs -put /opt/module/datas/dept.txt  /user/hive/warehouse/dept_partition2/month=201709/day=12;```</span><br></pre></td></tr></table></figure>





<pre><code>查询数据（查询不到刚上传的数据）
</code></pre>
<p><code>hive (default)&gt; select * from dept_partition2 where month=&#39;201709&#39; and day=&#39;12&#39;;</code></p>
<p>执行修复命令</p>
<p><code>hive&gt; msck repair table dept_partition2;</code></p>
<p>再次查询数据</p>
<p><code>hive (default)&gt; select * from dept_partition2 where month=&#39;201709&#39; and day=&#39;12&#39;;</code></p>
<pre><code>（2）方式二：上传数据后添加分区

上传数据
</code></pre>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">​```hive (default)&gt; dfs -mkdir -p</span><br><span class="line"></span><br><span class="line"> /user/hive/warehouse/dept_partition2/month=201709/day=11;```</span><br><span class="line"></span><br><span class="line">​```hive (default)&gt; dfs -put /opt/module/datas/dept.txt  /user/hive/warehouse/dept_partition2/month=201709/day=11;```</span><br></pre></td></tr></table></figure>





<pre><code>执行添加分区

```hive (default)&gt; alter table dept_partition2 add partition(month=&#39;201709&#39;,day=&#39;11&#39;);```

查询数据
</code></pre>
<p><code>hive (default)&gt; select * from dept_partition2 where month=&#39;201709&#39; and day=&#39;11&#39;;</code></p>
<pre><code>（3）方式三：创建文件夹后load数据到分区
</code></pre>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">创建目录</span><br><span class="line"></span><br><span class="line">​```hive (default)&gt; dfs -mkdir -p</span><br><span class="line"></span><br><span class="line"> /user/hive/warehouse/dept_partition2/month=201709/day=10;```</span><br><span class="line"></span><br><span class="line">上传数据</span><br><span class="line"></span><br><span class="line">​```hive (default)&gt; load data local inpath &#x27;/opt/module/datas/dept.txt&#x27; into table</span><br><span class="line"></span><br><span class="line"> dept_partition2 partition(month=&#x27;201709&#x27;,day=&#x27;10&#x27;);```</span><br><span class="line"></span><br><span class="line">查询数据</span><br><span class="line"></span><br><span class="line">​```hive (default)&gt; select * from dept_partition2 where month=&#x27;201709&#x27; and day=&#x27;10&#x27;;```</span><br></pre></td></tr></table></figure>





<h2 id="4-7-修改表"><a href="#4-7-修改表" class="headerlink" title="4.7 修改表"></a><strong>4.7 修改表</strong></h2><h3 id="4-7-1-重命名表"><a href="#4-7-1-重命名表" class="headerlink" title="4.7.1 重命名表"></a><strong>4.7.1 重命名表</strong></h3><p>1．语法</p>
<p><code>ALTER TABLE table_name RENAME TO new_table_name</code></p>
<p>2．实操案例</p>
<p><code>hive (default)&gt; alter table dept_partition2 rename to dept_partition3;</code></p>
<h3 id="4-7-2-增加、修改和删除表分区"><a href="#4-7-2-增加、修改和删除表分区" class="headerlink" title="4.7.2 增加、修改和删除表分区"></a><strong>4.7.2 增加、修改和删除表分区</strong></h3><p>详见4.6.1分区表基本操作。</p>
<h3 id="4-7-3-增加-修改-替换列信息"><a href="#4-7-3-增加-修改-替换列信息" class="headerlink" title="4.7.3 增加&#x2F;修改&#x2F;替换列信息"></a><strong>4.7.3 增加&#x2F;修改&#x2F;替换列信息</strong></h3><p>1．语法</p>
<pre><code>更新列
</code></pre>
<p><code>ALTER TABLE table_name CHANGE [COLUMN] col_old_name col_new_name column_type [COMMENT col_comment] [FIRST|AFTER column_name]</code></p>
<p>增加和替换列</p>
<p><code>ALTER TABLE table_name ADD|REPLACE COLUMNS (col_name data_type [COMMENT col_comment], ...) </code></p>
<p>注：ADD是代表新增一字段，字段位置在所有列后面(partition列前)，REPLACE则是表示替换表中所有字段。</p>
<p>2．实操案例</p>
<p>（1）查询表结构</p>
<p><code>hive&gt; desc dept_partition;</code></p>
<p>（2）添加列</p>
<p><code>hive (default)&gt; alter table dept_partition add columns(deptdesc string);</code></p>
<p>（3）查询表结构</p>
<p><code>hive&gt; desc dept_partition;</code></p>
<p>（4）更新列</p>
<p><code>hive (default)&gt; alter table dept_partition change column deptdesc desc int;</code></p>
<p>（5）查询表结构</p>
<p><code>hive&gt; desc dept_partition;</code></p>
<p>（6）替换列</p>
<p><code>hive (default)&gt; alter table dept_partition replace columns(deptno string, dname string, loc string);</code></p>
<p>（7）查询表结构</p>
<p><code>hive&gt; desc dept_partition;</code></p>
<h2 id="4-8-删除表"><a href="#4-8-删除表" class="headerlink" title="4.8 删除表"></a><strong>4.8 删除表</strong></h2><p><code>hive (default)&gt; drop table dept_partition;</code></p>
<h1 id="第5章-DML数据操作"><a href="#第5章-DML数据操作" class="headerlink" title="第5章 DML数据操作"></a><strong>第5章</strong> <strong>DML数据操作</strong></h1><h2 id="5-1-数据导入"><a href="#5-1-数据导入" class="headerlink" title="5.1 数据导入"></a><strong>5.1 数据导入</strong></h2><h3 id="5-1-1-向表中装载数据（Load）"><a href="#5-1-1-向表中装载数据（Load）" class="headerlink" title="5.1.1 向表中装载数据（Load）"></a><strong>5.1.1 向表中装载数据（Load）</strong></h3><p>1．语法</p>
<p><code>hive&gt; load data [local] inpath &#39;/opt/module/datas/student.txt&#39; overwrite | into table student [partition (partcol1=val1,…)];</code></p>
<p>（1）load data:表示加载数据</p>
<p>（2）local:表示从本地加载数据到hive表；否则从HDFS加载数据到hive表</p>
<p>（3）inpath:表示加载数据的路径</p>
<p>（4）overwrite:表示覆盖表中已有数据，否则表示追加</p>
<p>（5）into table:表示加载到哪张表</p>
<p>（6）student:表示具体的表</p>
<p>（7）partition:表示上传到指定分区</p>
<p>2．实操案例</p>
<pre><code>（0）创建一张表
</code></pre>
<p><code>hive (default)&gt; create table student(id string, name string) row format delimited fields terminated by &#39;\t&#39;;</code></p>
<p>（1）加载本地文件到hive</p>
<p><code>hive (default)&gt; load data local inpath &#39;/opt/module/datas/student.txt&#39; into table default.student;</code></p>
<p>（2）加载HDFS文件到hive中</p>
<pre><code>上传文件到HDFS
</code></pre>
<p><code>hive (default)&gt; dfs -put /opt/module/datas/student.txt /user/xiaojia/hive;</code></p>
<p>加载HDFS上数据</p>
<p><code>hive (default)&gt; load data inpath &#39;/user/xiaojia/hive/student.txt&#39; into table default.student;</code></p>
<p>（3）加载数据覆盖表中已有的数据</p>
<p>上传文件到HDFS</p>
<p><code>hive (default)&gt; dfs -put /opt/module/datas/student.txt /user/xiaojia/hive;</code></p>
<p>加载数据覆盖表中已有的数据</p>
<p><code>hive (default)&gt; load data inpath &#39;/user/xiaojia/hive/student.txt&#39; overwrite into table default.student;</code></p>
<h3 id="5-1-2-通过查询语句向表中插入数据（Insert）"><a href="#5-1-2-通过查询语句向表中插入数据（Insert）" class="headerlink" title="5.1.2 通过查询语句向表中插入数据（Insert）"></a><strong>5.1.2 通过查询语句向表中插入数据（Insert）</strong></h3><p>1．创建一张分区表</p>
<p><code>hive (default)&gt; create table student(id int, name string) partitioned by (month string) row format delimited fields terminated by &#39;\t&#39;;</code></p>
<p>2．基本插入数据</p>
<p><code>hive (default)&gt; insert into table  student partition(month=&#39;201709&#39;) values(1,&#39;wangwu&#39;);</code></p>
<p>3．基本模式插入（根据单张表查询结果）</p>
<p><code>hive (default)&gt; insert overwrite table student partition(month=&#39;201708&#39;) select id, name from student where month=&#39;201709&#39;;</code></p>
<p>4．多插入模式（根据多张表查询结果）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">​```hive (default)&gt; from student</span><br><span class="line"></span><br><span class="line">       insert overwrite table student partition(month=&#x27;201707&#x27;)</span><br><span class="line"></span><br><span class="line">       select id, name where month=&#x27;201709&#x27;</span><br><span class="line"></span><br><span class="line">       insert overwrite table student partition(month=&#x27;201706&#x27;)</span><br><span class="line"></span><br><span class="line">       select id, name where month=&#x27;201709&#x27;;```</span><br></pre></td></tr></table></figure>





<h3 id="5-1-3-查询语句中创建表并加载数据（As-Select）"><a href="#5-1-3-查询语句中创建表并加载数据（As-Select）" class="headerlink" title="5.1.3 查询语句中创建表并加载数据（As Select）"></a><strong>5.1.3 查询语句中创建表并加载数据（As Select）</strong></h3><p>详见4.5.1章创建表。</p>
<p>根据查询结果创建表（查询的结果会添加到新创建的表中）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">create table if not exists student3</span><br><span class="line"></span><br><span class="line">as select id, name from student;```</span><br></pre></td></tr></table></figure>



<h3 id="5-1-4-创建表时通过Location指定加载数据路径"><a href="#5-1-4-创建表时通过Location指定加载数据路径" class="headerlink" title="5.1.4 创建表时通过Location指定加载数据路径"></a><strong>5.1.4 创建表时通过Location指定加载数据路径</strong></h3><p>1．创建表，并指定在hdfs上的位置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">​```hive (default)&gt; create table if not exists student5(</span><br><span class="line"></span><br><span class="line">       id int, name string</span><br><span class="line"></span><br><span class="line">       )</span><br><span class="line"></span><br><span class="line">       row format delimited fields terminated by &#x27;\t&#x27;</span><br><span class="line"></span><br><span class="line">       location &#x27;/user/hive/warehouse/student5&#x27;;```</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>2．上传数据到hdfs上</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">​```hive (default)&gt; dfs -put /opt/module/datas/student.txt</span><br><span class="line"></span><br><span class="line">/user/hive/warehouse/student5;```</span><br></pre></td></tr></table></figure>



<p>3．查询数据</p>
<p><code>hive (default)&gt; select * from student5;</code></p>
<h3 id="5-1-5-Import数据到指定Hive表中"><a href="#5-1-5-Import数据到指定Hive表中" class="headerlink" title="5.1.5 Import数据到指定Hive表中"></a><strong>5.1.5 Import数据到指定Hive表中</strong></h3><p>注意：先用export导出后，再将数据导入。</p>
<p><code>hive (default)&gt; import table student2 partition(month=&#39;201709&#39;) from&#39;/user/hive/warehouse/export/student&#39;;</code></p>
<h2 id="5-2-数据导出"><a href="#5-2-数据导出" class="headerlink" title="5.2 数据导出"></a><strong>5.2 数据导出</strong></h2><h3 id="5-2-1-Insert导出"><a href="#5-2-1-Insert导出" class="headerlink" title="5.2.1 Insert导出"></a><strong>5.2.1 Insert导出</strong></h3><p>1．将查询的结果导出到本地</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">​```hive (default)&gt; insert overwrite local directory &#x27;/opt/module/datas/export/student&#x27;</span><br><span class="line"></span><br><span class="line">      select * from student;```</span><br></pre></td></tr></table></figure>



<p>2．将查询的结果格式化导出到本地</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">hive(default)&gt;insert overwrite local directory &#x27;/opt/module/datas/export/student1&#x27;</span><br><span class="line"></span><br><span class="line">      ROW FORMAT DELIMITED FIELDS TERMINATED BY &#x27;\t&#x27;       select * from student;```</span><br></pre></td></tr></table></figure>



<p>3．将查询的结果导出到HDFS上(没有local)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">​```hive (default)&gt; insert overwrite directory &#x27;/user/xiaojia/student2&#x27;</span><br><span class="line"></span><br><span class="line">       ROW FORMAT DELIMITED FIELDS TERMINATED BY &#x27;\t&#x27; </span><br><span class="line"></span><br><span class="line">       select * from student;```</span><br></pre></td></tr></table></figure>



<h3 id="5-2-2-Hadoop命令导出到本地"><a href="#5-2-2-Hadoop命令导出到本地" class="headerlink" title="5.2.2 Hadoop命令导出到本地"></a><strong>5.2.2 Hadoop命令导出到本地</strong></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">​```hive (default)&gt; dfs -get /user/hive/warehouse/student/month=201709/000000_0</span><br><span class="line"></span><br><span class="line">/opt/module/datas/export/student3.txt;```</span><br></pre></td></tr></table></figure>



<h3 id="5-2-3-Hive-Shell-命令导出"><a href="#5-2-3-Hive-Shell-命令导出" class="headerlink" title="5.2.3 Hive Shell 命令导出"></a><strong>5.2.3 Hive Shell 命令导出</strong></h3><p>基本语法：（hive -f&#x2F;-e 执行语句或者脚本 &gt; file）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[xiaojia@hadoop01 hive]$ bin/hive -e &#x27;select * from default.student;```&#x27; &gt;</span><br><span class="line"></span><br><span class="line"> /opt/module/datas/export/student4.txt;```</span><br></pre></td></tr></table></figure>



<h3 id="5-2-4-Export导出到HDFS上"><a href="#5-2-4-Export导出到HDFS上" class="headerlink" title="5.2.4 Export导出到HDFS上"></a><strong>5.2.4 Export导出到HDFS上</strong></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(defahiveult)&gt; export table default.student to</span><br><span class="line"></span><br><span class="line"> &#x27;/user/hive/warehouse/export/student&#x27;;```</span><br></pre></td></tr></table></figure>



<h3 id="5-2-5-Sqoop导出"><a href="#5-2-5-Sqoop导出" class="headerlink" title="5.2.5 Sqoop导出"></a><strong>5.2.5 Sqoop导出</strong></h3><p>后续课程专门讲。</p>
<h2 id="5-3-清除表中数据（Truncate）"><a href="#5-3-清除表中数据（Truncate）" class="headerlink" title="5.3 清除表中数据（Truncate）"></a><strong>5.3 清除表中数据（Truncate）</strong></h2><p>注意：Truncate只能删除管理表，不能删除外部表中数据</p>
<p><code>hive (default)&gt; truncate table student;</code></p>
<h1 id="第6章-查询"><a href="#第6章-查询" class="headerlink" title="第6章 查询"></a><strong>第6章</strong> <strong>查询</strong></h1><p><a target="_blank" rel="noopener" href="https://cwiki.apache.org/confluence/display/Hive/LanguageManual+Select">https://cwiki.apache.org/confluence/display/Hive/LanguageManual+Select</a></p>
<p>查询语句语法：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[WITH CommonTableExpression (, CommonTableExpression)*]  (Note: Only available starting with Hive 0.13.0)SELECT [ALL | DISTINCT] select_expr, select_expr, ... FROM table_reference [WHERE where_condition] [GROUP BY col_list] [ORDER BY col_list] [CLUSTER BY col_list  | [DISTRIBUTE BY col_list] [SORT BY col_list] ] [LIMIT number]</span><br></pre></td></tr></table></figure>



<h2 id="6-1-基本查询（Select…From）"><a href="#6-1-基本查询（Select…From）" class="headerlink" title="6.1 基本查询（Select…From）"></a><strong>6.1 基本查询（Select…From）</strong></h2><h3 id="6-1-1-全表和特定列查询"><a href="#6-1-1-全表和特定列查询" class="headerlink" title="6.1.1 全表和特定列查询"></a><strong>6.1.1 全表和特定列查询</strong></h3><p>1．全表查询</p>
<p><code>hive (default)&gt; select * from emp;</code></p>
<p>2．选择特定列查询</p>
<p><code>hive (default)&gt; select empno, ename from emp;</code></p>
<p>注意：</p>
<p>（1）SQL 语言大小写不敏感。 </p>
<p>（2）SQL 可以写在一行或者多行</p>
<p>（3）关键字不能被缩写也不能分行</p>
<p>（4）各子句一般要分行写。</p>
<p>（5）使用缩进提高语句的可读性。</p>
<h3 id="6-1-2-列别名"><a href="#6-1-2-列别名" class="headerlink" title="6.1.2 列别名"></a><strong>6.1.2 列别名</strong></h3><p>1．重命名一个列</p>
<p>2．便于计算</p>
<p>3．紧跟列名，也可以在列名和别名之间加入关键字‘AS’ </p>
<p>4．案例实操</p>
<p>查询名称和部门</p>
<p><code>hive (default)&gt; select ename AS name, deptno dn from emp;</code></p>
<h3 id="6-1-3-算术运算符"><a href="#6-1-3-算术运算符" class="headerlink" title="6.1.3 算术运算符"></a><strong>6.1.3 算术运算符</strong></h3><p>表6-3</p>
<table>
<thead>
<tr>
<th>运算符</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>A+B</td>
<td>A和B 相加</td>
</tr>
<tr>
<td>A-B</td>
<td>A减去B</td>
</tr>
<tr>
<td>A*B</td>
<td>A和B 相乘</td>
</tr>
<tr>
<td>A&#x2F;B</td>
<td>A除以B</td>
</tr>
<tr>
<td>A%B</td>
<td>A对B取余</td>
</tr>
<tr>
<td>A&amp;B</td>
<td>A和B按位取与</td>
</tr>
<tr>
<td>A|B</td>
<td>A和B按位取或</td>
</tr>
<tr>
<td>A^B</td>
<td>A和B按位取异或</td>
</tr>
<tr>
<td>~A</td>
<td>A按位取反</td>
</tr>
</tbody></table>
<p>案例实操</p>
<pre><code> 查询出所有员工的薪水后加1显示。
</code></pre>
<p><code>hive (default)&gt; select sal +1 from emp;</code></p>
<h3 id="6-1-4-常用函数"><a href="#6-1-4-常用函数" class="headerlink" title="6.1.4 常用函数"></a><strong>6.1.4 常用函数</strong></h3><p>1．求总行数（count）</p>
<p><code>hive (default)&gt; select count(*) cnt from emp;</code></p>
<p>2．求工资的最大值（max）</p>
<p><code>hive (default)&gt; select max(sal) max_sal from emp;</code></p>
<p>3．求工资的最小值（min）</p>
<p><code>hive (default)&gt; select min(sal) min_sal from emp;</code></p>
<p>4．求工资的总和（sum）</p>
<p><code>hive (default)&gt; select sum(sal) sum_sal from emp;</code> &#96;&#96;&#96;</p>
<p>5．求工资的平均值（avg）</p>
<p><code>hive (default)&gt; select avg(sal) avg_sal from emp;</code></p>
<h3 id="6-1-5-Limit语句"><a href="#6-1-5-Limit语句" class="headerlink" title="6.1.5 Limit语句"></a><strong>6.1.5 Limit语句</strong></h3><p>典型的查询会返回多行数据。LIMIT子句用于限制返回的行数。</p>
<p><code>hive (default)&gt; select * from emp limit 5;</code></p>
<h2 id="6-2-Where语句"><a href="#6-2-Where语句" class="headerlink" title="6.2 Where语句"></a><strong>6.2 Where语句</strong></h2><p>1．使用WHERE子句，将不满足条件的行过滤掉</p>
<p>2．WHERE子句紧随FROM子句</p>
<p>3．案例实操</p>
<p>查询出薪水大于1000的所有员工</p>
<p><code>hive (default)&gt; select * from emp where sal &gt;1000;</code></p>
<h3 id="6-2-1-比较运算符（Between-In-Is-Null）"><a href="#6-2-1-比较运算符（Between-In-Is-Null）" class="headerlink" title="6.2.1 比较运算符（Between&#x2F;In&#x2F; Is Null）"></a><strong>6.2.1 比较运算符（Between&#x2F;In&#x2F; Is Null）</strong></h3><p>1）下面表中描述了谓词操作符，这些操作符同样可以用于JOIN…ON和HAVING语句中。</p>
<p>表6-4</p>
<table>
<thead>
<tr>
<th>操作符</th>
<th>支持的数据类型</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>A&#x3D;B</td>
<td>基本数据类型</td>
<td>如果A等于B则返回TRUE，反之返回FALSE</td>
</tr>
<tr>
<td>A&lt;&#x3D;&gt;B</td>
<td>基本数据类型</td>
<td>如果A和B都为NULL，则返回TRUE，其他的和等号（&#x3D;）操作符的结果一致，如果任一为NULL则结果为NULL</td>
</tr>
<tr>
<td>A&lt;&gt;B, A!&#x3D;B</td>
<td>基本数据类型</td>
<td>A或者B为NULL则返回NULL；如果A不等于B，则返回TRUE，反之返回FALSE</td>
</tr>
<tr>
<td>A&lt;B</td>
<td>基本数据类型</td>
<td>A或者B为NULL，则返回NULL；如果A小于B，则返回TRUE，反之返回FALSE</td>
</tr>
<tr>
<td>A&lt;&#x3D;B</td>
<td>基本数据类型</td>
<td>A或者B为NULL，则返回NULL；如果A小于等于B，则返回TRUE，反之返回FALSE</td>
</tr>
<tr>
<td>A&gt;B</td>
<td>基本数据类型</td>
<td>A或者B为NULL，则返回NULL；如果A大于B，则返回TRUE，反之返回FALSE</td>
</tr>
<tr>
<td>A&gt;&#x3D;B</td>
<td>基本数据类型</td>
<td>A或者B为NULL，则返回NULL；如果A大于等于B，则返回TRUE，反之返回FALSE</td>
</tr>
<tr>
<td>A [NOT] BETWEEN B AND C</td>
<td>基本数据类型</td>
<td>如果A，B或者C任一为NULL，则结果为NULL。如果A的值大于等于B而且小于或等于C，则结果为TRUE，反之为FALSE。如果使用NOT关键字则可达到相反的效果。</td>
</tr>
<tr>
<td>A IS NULL</td>
<td>所有数据类型</td>
<td>如果A等于NULL，则返回TRUE，反之返回FALSE</td>
</tr>
<tr>
<td>A IS NOT NULL</td>
<td>所有数据类型</td>
<td>如果A不等于NULL，则返回TRUE，反之返回FALSE</td>
</tr>
<tr>
<td>IN(数值1, 数值2)</td>
<td>所有数据类型</td>
<td>使用 IN运算显示列表中的值</td>
</tr>
<tr>
<td>A [NOT] LIKE B</td>
<td>STRING 类型</td>
<td>B是一个SQL下的简单正则表达式，如果A与其匹配的话，则返回TRUE；反之返回FALSE。B的表达式说明如下：‘x%’表示A必须以字母‘x’开头，‘%x’表示A必须以字母’x’结尾，而‘%x%’表示A包含有字母’x’,可以位于开头，结尾或者字符串中间。如果使用NOT关键字则可达到相反的效果。</td>
</tr>
<tr>
<td>A RLIKE B, A REGEXP B</td>
<td>STRING 类型</td>
<td>B是一个正则表达式，如果A与其匹配，则返回TRUE；反之返回FALSE。匹配使用的是JDK中的正则表达式接口实现的，因为正则也依据其中的规则。例如，正则表达式必须和整个字符串A相匹配，而不是只需与其字符串匹配。</td>
</tr>
</tbody></table>
<p>2）案例实操</p>
<p>（1）查询出薪水等于5000的所有员工</p>
<p><code>hive (default)&gt; select * from emp where sal =5000;</code></p>
<p>（2）查询工资在500到1000的员工信息</p>
<p><code>hive (default)&gt; select * from emp where sal between 500 and 1000;</code></p>
<p>（3）查询comm为空的所有员工信息</p>
<p><code>hive (default)&gt; select * from emp where comm is null;</code></p>
<p>（4）查询工资是1500或5000的员工信息</p>
<p><code>hive (default)&gt; select * from emp where sal IN (1500, 5000);</code></p>
<h3 id="6-2-2-Like和RLike"><a href="#6-2-2-Like和RLike" class="headerlink" title="6.2.2 Like和RLike"></a><strong>6.2.2 Like和RLike</strong></h3><p>1）使用LIKE运算选择类似的值</p>
<p>2）选择条件可以包含字符或数字:</p>
<p>% 代表零个或多个字符(任意个字符)。</p>
<p>_ 代表一个字符。</p>
<p>3）RLIKE子句是Hive中这个功能的一个扩展，其可以通过Java的正则表达式这个更强大的语言来指定匹配条件。</p>
<p>4）案例实操</p>
<pre><code>（1）查找以2开头薪水的员工信息
</code></pre>
<p><code>hive (default)&gt; select * from emp where sal LIKE &#39;2%&#39;;</code></p>
<pre><code>（2）查找第二个数值为2的薪水的员工信息
</code></pre>
<p><code>hive (default)&gt; select * from emp where sal LIKE &#39;_2%&#39;;</code></p>
<pre><code>（3）查找薪水中含有2的员工信息
</code></pre>
<p><code>hive (default)&gt; select * from emp where sal RLIKE &#39;[2]&#39;;</code></p>
<h3 id="6-2-3-逻辑运算符（And-Or-Not）"><a href="#6-2-3-逻辑运算符（And-Or-Not）" class="headerlink" title="6.2.3 逻辑运算符（And&#x2F;Or&#x2F;Not）"></a><strong>6.2.3 逻辑运算符（And&#x2F;Or&#x2F;Not）</strong></h3><p>表6-5</p>
<table>
<thead>
<tr>
<th>操作符</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>AND</td>
<td>逻辑并</td>
</tr>
<tr>
<td>OR</td>
<td>逻辑或</td>
</tr>
<tr>
<td>NOT</td>
<td>逻辑否</td>
</tr>
</tbody></table>
<p>案例实操</p>
<pre><code>（1）查询薪水大于1000，部门是30
</code></pre>
<p><code>hive (default)&gt; select * from emp where sal&gt;1000 and deptno=30;</code></p>
<pre><code>（2）查询薪水大于1000，或者部门是30
</code></pre>
<p><code>hive (default)&gt; select * from emp where sal&gt;1000 or deptno=30;</code></p>
<pre><code>（3）查询除了20部门和30部门以外的员工信息
</code></pre>
<p><code>hive (default)&gt; select * from emp where deptno not IN(30, 20);</code></p>
<h2 id="6-3-分组"><a href="#6-3-分组" class="headerlink" title="6.3 分组"></a><strong>6.3 分组</strong></h2><h3 id="6-3-1-Group-By语句"><a href="#6-3-1-Group-By语句" class="headerlink" title="6.3.1 Group By语句"></a><strong>6.3.1 Group By语句</strong></h3><p>GROUP BY语句通常会和聚合函数一起使用，按照一个或者多个列队结果进行分组，然后对每个组执行聚合操作。</p>
<p>案例实操：</p>
<pre><code>（1）计算emp表每个部门的平均工资
</code></pre>
<p><code>hive (default)&gt; select t.deptno, avg(t.sal) avg_sal from emp t group by t.deptno;</code></p>
<pre><code>（2）计算emp每个部门中每个岗位的最高薪水
</code></pre>
<p><code>hive (default)&gt; select t.deptno, t.job, max(t.sal) max_sal from emp t group by t.deptno, t.job;</code></p>
<h3 id="6-3-2-Having语句"><a href="#6-3-2-Having语句" class="headerlink" title="6.3.2 Having语句"></a><strong>6.3.2 Having语句</strong></h3><p>1．having与where不同点</p>
<p>（1）where针对表中的列发挥作用，查询数据；having针对查询结果中的列发挥作用，筛选数据。</p>
<p>（2）where后面不能写分组函数，而having后面可以使用分组函数。</p>
<p>（3）having只用于group by分组统计语句。</p>
<p>2．案例实操</p>
<p>（1）求每个部门的平均薪水大于2000的部门</p>
<p>求每个部门的平均工资</p>
<p><code>hive (default)&gt; select deptno, avg(sal) from emp group by deptno;</code></p>
<pre><code> 求每个部门的平均薪水大于2000的部门
</code></pre>
<p><code>hive (default)&gt; select deptno, avg(sal) avg_sal from emp group by deptno having avg_sal &gt; 2000;</code></p>
<h2 id="6-4-Join语句"><a href="#6-4-Join语句" class="headerlink" title="6.4 Join语句"></a><strong>6.4 Join语句</strong></h2><h3 id="6-4-1-等值Join"><a href="#6-4-1-等值Join" class="headerlink" title="6.4.1 等值Join"></a><strong>6.4.1 等值Join</strong></h3><p>Hive支持通常的SQL JOIN语句，但是只支持等值连接，不支持非等值连接。</p>
<p>案例实操</p>
<p>（1）根据员工表和部门表中的部门编号相等，查询员工编号、员工名称和部门名称；</p>
<p><code>hive (default)&gt; select e.empno, e.ename, d.deptno, d.dname from emp e join dept d on e.deptno = d.deptno;</code></p>
<h3 id="6-4-2-表的别名"><a href="#6-4-2-表的别名" class="headerlink" title="6.4.2 表的别名"></a><strong>6.4.2 表的别名</strong></h3><p>1．好处</p>
<p>（1）使用别名可以简化查询。</p>
<p>（2）使用表名前缀可以提高执行效率。</p>
<p>2．案例实操</p>
<p>合并员工表和部门表</p>
<p><code>hive (default)&gt; select e.empno, e.ename, d.deptno from emp e join dept d on e.deptno = d.deptno;</code></p>
<h3 id="6-4-3-内连接"><a href="#6-4-3-内连接" class="headerlink" title="6.4.3 内连接"></a><strong>6.4.3 内连接</strong></h3><p>内连接：只有进行连接的两个表中都存在与连接条件相匹配的数据才会被保留下来。</p>
<p><code>hive (default)&gt; select e.empno, e.ename, d.deptno from emp e join dept d on e.deptno= d.deptno;</code></p>
<h3 id="6-4-4-左外连接"><a href="#6-4-4-左外连接" class="headerlink" title="6.4.4 左外连接"></a><strong>6.4.4 左外连接</strong></h3><p>左外连接：JOIN操作符左边表中符合WHERE子句的所有记录将会被返回。</p>
<p><code>hive (default)&gt; select e.empno, e.ename, d.deptno from emp e left join dept d on e.deptno= d.deptno;</code></p>
<h3 id="6-4-5-右外连接"><a href="#6-4-5-右外连接" class="headerlink" title="6.4.5 右外连接"></a><strong>6.4.5 右外连接</strong></h3><p>右外连接：JOIN操作符右边表中符合WHERE子句的所有记录将会被返回。</p>
<p><code>hive (default)&gt; select e.empno, e.ename, d.deptno from emp e right join dept d on e.deptno= d.deptno;</code></p>
<h3 id="6-4-6-满外连接"><a href="#6-4-6-满外连接" class="headerlink" title="6.4.6 满外连接"></a><strong>6.4.6 满外连接</strong></h3><pre><code>满外连接：将会返回所有表中符合WHERE语句条件的所有记录。如果任一表的指定字段没有符合条件的值的话，那么就使用NULL值替代。
</code></pre>
<p><code>hive (default)&gt; select e.empno, e.ename, d.deptno from emp e full join dept d on e.deptno= d.deptno;</code></p>
<h3 id="6-4-7-多表连接"><a href="#6-4-7-多表连接" class="headerlink" title="6.4.7 多表连接"></a><strong>6.4.7 多表连接</strong></h3><p>注意：连接 n个表，至少需要n-1个连接条件。例如：连接三个表，至少需要两个连接条件。</p>
<p>数据准备</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="file:////tmp/wps-xiaojia/ksohtml/wpsjFlEUw.png" alt="img"></p>
<p>1．创建位置表</p>
<p><code>create table if not exists default.location(loc int,loc_name string)row format delimited fields terminated by &#39;\t&#39;;</code></p>
<p>2．导入数据</p>
<p><code>hive (default)&gt; load data local inpath &#39;/opt/module/datas/location.txt&#39; into table default.location;</code></p>
<p>3．多表连接查询</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">hive (default)&gt;SELECT e.ename, d.deptno, l. loc_name</span><br><span class="line"></span><br><span class="line">FROM  emp e </span><br><span class="line"></span><br><span class="line">JOIN  dept d</span><br><span class="line"></span><br><span class="line">ON   d.deptno = e.deptno </span><br><span class="line"></span><br><span class="line">JOIN  location l</span><br><span class="line"></span><br><span class="line">ON   d.loc = l.loc;</span><br></pre></td></tr></table></figure>



<p>大多数情况下，Hive会对每对JOIN连接对象启动一个MapReduce任务。本例中会首先启动一个MapReduce job对表e和表d进行连接操作，然后会再启动一个MapReduce job将第一个MapReduce job的输出和表l;&#96;&#96;&#96;进行连接操作。</p>
<p>注意：为什么不是表d和表l先进行连接操作呢？这是因为Hive总是按照从左到右的顺序执行的。</p>
<h3 id="6-4-8-笛卡尔积"><a href="#6-4-8-笛卡尔积" class="headerlink" title="6.4.8 笛卡尔积"></a><strong>6.4.8 笛卡尔积</strong></h3><p>1．笛卡尔集会在下面条件下产生</p>
<p>（1）省略连接条件</p>
<p>（2）连接条件无效</p>
<p>（3）所有表中的所有行互相连接</p>
<p>2．案例实操</p>
<p><code>hive (default)&gt; select empno, dname from emp, dept;</code></p>
<h3 id="6-4-9-连接谓词中不支持or"><a href="#6-4-9-连接谓词中不支持or" class="headerlink" title="6.4.9 连接谓词中不支持or"></a><strong>6.4.9 连接谓词中不支持or</strong></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hive (default)&gt; select e.empno, e.ename, d.deptno from emp e join dept d on e.deptno= d.deptno or e.ename=d.ename;  错误的</span><br></pre></td></tr></table></figure>

<h2 id="6-5-排序"><a href="#6-5-排序" class="headerlink" title="6.5 排序"></a><strong>6.5 排序</strong></h2><h3 id="6-5-1-全局排序（Order-By）"><a href="#6-5-1-全局排序（Order-By）" class="headerlink" title="6.5.1 全局排序（Order By）"></a><strong>6.5.1 全局排序（Order By）</strong></h3><p>Order By：全局排序，一个Reducer</p>
<p>1．使用 ORDER BY 子句排序</p>
<p>ASC（ascend）: 升序（默认）</p>
<p>DESC（descend）: 降序</p>
<p>2．ORDER BY 子句在SELECT语句的结尾</p>
<p>3．案例实操 </p>
<pre><code>（1）查询员工信息按工资升序排列
</code></pre>
<p><code>hive (default)&gt; select * from emp order by sal;</code></p>
<pre><code>（2）查询员工信息按工资降序排列
</code></pre>
<p><code>hive (default)&gt; select * from emp order by sal desc;</code></p>
<h3 id="6-5-2-按照别名排序"><a href="#6-5-2-按照别名排序" class="headerlink" title="6.5.2 按照别名排序"></a><strong>6.5.2 按照别名排序</strong></h3><p>按照员工薪水的2倍排序</p>
<p><code>hive (default)&gt; select ename, sal*2 twosal from emp order by twosal;</code></p>
<h3 id="6-5-3-多个列排序"><a href="#6-5-3-多个列排序" class="headerlink" title="6.5.3 多个列排序"></a><strong>6.5.3 多个列排序</strong></h3><p>按照部门和工资升序排序</p>
<p><code>hive (default)&gt; select ename, deptno, sal from emp order by deptno, sal ;</code></p>
<h3 id="6-5-4-每个MapReduce内部排序（Sort-By）"><a href="#6-5-4-每个MapReduce内部排序（Sort-By）" class="headerlink" title="6.5.4 每个MapReduce内部排序（Sort By）"></a><strong>6.5.4 每个MapReduce内部排序（Sort By）</strong></h3><p>Sort By：每个Reducer内部进行排序，对全局结果集来说不是排序。</p>
<pre><code>1．设置reduce个数
</code></pre>
<p><code>hive (default)&gt; set mapreduce.job.reduces=3;</code></p>
<p>2．查看设置reduce个数</p>
<p><code>hive (default)&gt; set mapreduce.job.reduces;</code></p>
<p>3．根据部门编号降序查看员工信息</p>
<p><code>hive (default)&gt; select * from emp sort by empno desc;</code></p>
<pre><code>4．将查询结果导入到文件中（按照部门编号降序排序）
</code></pre>
<p><code>hive (default)&gt; insert overwrite local directory &#39;/opt/module/datas/sortby-result&#39; select * from emp sort by deptno desc;</code></p>
<h3 id="6-5-5-分区排序（Distribute-By）"><a href="#6-5-5-分区排序（Distribute-By）" class="headerlink" title="6.5.5 分区排序（Distribute By）"></a><strong>6.5.5 分区排序（Distribute By）</strong></h3><p>Distribute By：类似MR中partition，进行分区，结合sort by使用。</p>
<pre><code>注意，Hive要求DISTRIBUTE BY语句要写在SORT BY语句之前。
</code></pre>
<p>对于distribute by进行测试，一定要分配多reduce进行处理，否则无法看到distribute by的效果。</p>
<p>案例实操：</p>
<pre><code>（1）先按照部门编号分区，再按照员工编号降序排序。
</code></pre>
<p><code>hive (default)&gt; set mapreduce.job.reduces=3;</code></p>
<p><code>hive (default)&gt; insert overwrite local directory &#39;/opt/module/datas/distribute-result&#39; select * from emp distribute by deptno sort by empno desc;</code></p>
<h3 id="6-5-6-Cluster-By"><a href="#6-5-6-Cluster-By" class="headerlink" title="6.5.6 Cluster By"></a><strong>6.5.6 Cluster By</strong></h3><p>当distribute by和sorts by字段相同时，可以使用cluster by方式。</p>
<p>cluster by除了具有distribute by的功能外还兼具sort by的功能。但是排序只能是升序排序，不能指定排序规则为ASC或者DESC。</p>
<p>1）以下两种写法等价</p>
<p><code>hive (default)&gt; select * from emp cluster by deptno;</code></p>
<p><code>hive (default)&gt; select * from emp distribute by deptno sort by deptno;</code></p>
<p>注意：按照部门编号分区，不一定就是固定死的数值，可以是20号和30号部门分到一个分区里面去。</p>
<h2 id="6-6-分桶及抽样查询"><a href="#6-6-分桶及抽样查询" class="headerlink" title="6.6 分桶及抽样查询"></a><strong>6.6 分桶及抽样查询</strong></h2><h3 id="6-6-1-分桶表数据存储"><a href="#6-6-1-分桶表数据存储" class="headerlink" title="6.6.1 分桶表数据存储"></a><strong>6.6.1 分桶表数据存储</strong></h3><pre><code>分区针对的是数据的存储路径；分桶针对的是数据文件。
</code></pre>
<p>分区提供一个隔离数据和优化查询的便利方式。不过，并非所有的数据集都可形成合理的分区，特别是之前所提到过的要确定合适的划分大小这个疑虑。</p>
<pre><code>分桶是将数据集分解成更容易管理的若干部分的另一个技术。
</code></pre>
<p>1．先创建分桶表，通过直接导入数据文件的方式</p>
<p>（1）数据准备</p>
<p>（2）创建分桶表</p>
<p><code>create table stu_buck(id int, name string) clustered by(id) into 4 buckets row format delimited fields terminated by &#39;\t&#39;;</code></p>
<p>（3）查看表结构</p>
<p><code>hive (default)&gt; desc formatted stu_buck;</code></p>
<p>Num Buckets:       4   </p>
<p>（4）导入数据到分桶表中</p>
<p><code>hive (default)&gt; load data local inpath &#39;/opt/module/datas/student.txt&#39; into table stu_buck;</code></p>
<p>（5）查看创建的分桶表中是否分成4个桶，如图6-7所示</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="file:////tmp/wps-xiaojia/ksohtml/wpsmyhBRt.jpg" alt="img"> </p>
<p>图6-7 未分桶</p>
<p>发现并没有分成4个桶。是什么原因呢？</p>
<p>2．创建分桶表时，数据通过子查询的方式导入</p>
<p>（1）先建一个普通的stu表</p>
<p><code>create table stu(id int, name string)row format delimited fields terminated by &#39;\t&#39;;</code></p>
<p>（2）向普通的stu表中导入数据</p>
<p><code>load data local inpath &#39;/opt/module/datas/student.txt&#39; into table stu;</code></p>
<p>（3）清空stu_buck表中数据</p>
<p><code>truncate table stu_buck;select * from stu_buck;</code></p>
<p>（4）导入数据到分桶表，通过子查询的方式</p>
<p><code>insert into table stu_buckselect id, name from stu;</code></p>
<p>（5）发现还是只有一个分桶，如图6-8所示</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="file:////tmp/wps-xiaojia/ksohtml/wpsA24alX.jpg" alt="img"> </p>
<p>图6-8 未分桶</p>
<p>（6）需要设置一个属性</p>
<p><code>hive (default)&gt; set hive.enforce.bucketing=true;</code></p>
<p><code>hive (default)&gt; set mapreduce.job.reduces=-1;</code></p>
<p><code>hive (default)&gt; insert into table stu_buck select id, name from stu;</code></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="file:////tmp/wps-xiaojia/ksohtml/wpsX4cOOq.jpg" alt="img"> </p>
<p>图6-9 分桶</p>
<p>（7）查询分桶的数据</p>
<p><code>hive (default)&gt; select * from stu_buck;</code></p>
<p>OKstu_buck.id   stu_buck.name1004   ss41008   ss81012   ss121016   ss161001   ss11005   ss51009   ss91013   ss131002   ss21006   ss61010   ss101014   ss141003   ss31007   ss71011   ss111015   ss15</p>
<h3 id="6-6-2-分桶抽样查询"><a href="#6-6-2-分桶抽样查询" class="headerlink" title="6.6.2 分桶抽样查询"></a><strong>6.6.2 分桶抽样查询</strong></h3><p>对于非常大的数据集，有时用户需要使用的是一个具有代表性的查询结果而不是全部结果。Hive可以通过对表进行抽样来满足这个需求。</p>
<p>查询表stu_buck中的数据。</p>
<p><code>hive (default)&gt; select * from stu_buck tablesample(bucket 1 out of 4 on id);</code></p>
<p>注：tablesample是抽样语句，语法：TABLESAMPLE(BUCKET x OUT OF y) 。</p>
<p>y必须是table总bucket数的倍数或者因子。hive根据y的大小，决定抽样的比例。例如，table总共分了4份，当y&#x3D;2时，抽取(4&#x2F;2&#x3D;)2个bucket的数据，当y&#x3D;8时，抽取(4&#x2F;8&#x3D;)1&#x2F;2个bucket的数据。</p>
<p>x表示从哪个bucket开始抽取，如果需要取多个分区，以后的分区号为当前分区号加上y。例如，table总bucket数为4，tablesample(bucket 1 out of 2)，表示总共抽取（4&#x2F;2&#x3D;）2个bucket的数据，抽取第1(x)个和第3(x+y)个bucket的数据。</p>
<p>注意：x的值必须小于等于y的值，否则</p>
<p>FAILED: SemanticException [Error 10061]: Numerator should not be bigger than denominator in sample clause for table stu_buck</p>
<h2 id="6-7-其他常用查询函数"><a href="#6-7-其他常用查询函数" class="headerlink" title="6.7 其他常用查询函数"></a><strong>6.7</strong> <strong>其他常用查询函数</strong></h2><h3 id="6-7-1-空字段赋值"><a href="#6-7-1-空字段赋值" class="headerlink" title="6.7.1 空字段赋值"></a><strong>6.7.1</strong> <strong>空字段赋值</strong></h3><ol>
<li>函数说明</li>
</ol>
<p>NVL：给值为NULL的数据赋值，它的格式是NVL( string1, replace_with)。它的功能是如果string1为NULL，则NVL函数返回replace_with的值，否则返回string1的值，如果两个参数都为NULL ，则返回NULL。</p>
<ol start="2">
<li><p>数据准备：采用员工表</p>
</li>
<li><p>查询：如果员工的comm为NULL，则用-1代替</p>
</li>
</ol>
<p><code>hive (default)&gt; select nvl(comm,-1) from emp;</code></p>
<p>OK</p>
<p>_c0</p>
<p>20.0</p>
<p>300.0</p>
<p>500.0</p>
<p>-1.0</p>
<p>1400.0</p>
<p>-1.0</p>
<p>-1.0</p>
<p>-1.0</p>
<p>-1.0</p>
<p>0.0</p>
<p>-1.0</p>
<p>-1.0</p>
<p>-1.0</p>
<p>-1.0</p>
<ol start="4">
<li>查询：如果员工的comm为NULL，则用领导id代替</li>
</ol>
<p><code>hive (default)&gt; select nvl(comm,mgr) from emp;</code></p>
<p>OK</p>
<p>_c0</p>
<p>20.0</p>
<p>300.0</p>
<p>500.0</p>
<p>7839.0</p>
<p>1400.0</p>
<p>7839.0</p>
<p>7839.0</p>
<p>7566.0</p>
<p>NULL</p>
<p>0.0</p>
<p>7788.0</p>
<p>7698.0</p>
<p>7566.0</p>
<ol start="5">
<li>date时间函数</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">hive (default)&gt; select date_format(&#x27;2019-06-29&#x27;,&#x27;yyyyMMdd&#x27;);</span><br><span class="line">OK</span><br><span class="line">_c0</span><br><span class="line">20190629</span><br><span class="line">Time taken: 0.075 seconds, Fetched: 1 row(s)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">hive (default)&gt; select date_add(&#x27;2020-07-08&#x27;,6);</span><br><span class="line">OK</span><br><span class="line">_c0</span><br><span class="line">2020-07-14</span><br><span class="line">Time taken: 0.09 seconds, Fetched: 1 row(s)</span><br><span class="line">hive (default)&gt; select date_add(&#x27;2020-07-08&#x27;,-6);</span><br><span class="line">OK</span><br><span class="line">_c0</span><br><span class="line">2020-07-02</span><br><span class="line">Time taken: 0.083 seconds, Fetched: 1 row(s)</span><br></pre></td></tr></table></figure>

<p>date_sub相减同上</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">hive (default)&gt; select datediff(&#x27;2020-09-27 12:12:12&#x27;,&#x27;2019-12-06&#x27;);</span><br><span class="line">OK</span><br><span class="line">_c0</span><br><span class="line">296</span><br><span class="line">Time taken: 0.086 seconds, Fetched: 1 row(s)</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">hive (default)&gt; select date_add(regexp_replace(&#x27;2019/07/07&#x27;,&#x27;/&#x27;,&#x27;-&#x27;),5);</span><br><span class="line">OK</span><br><span class="line">_c0</span><br><span class="line">2019-07-12</span><br><span class="line">Time taken: 0.512 seconds, Fetched: 1 row(s)</span><br></pre></td></tr></table></figure>



<h3 id="6-7-2-CASE-WHEN"><a href="#6-7-2-CASE-WHEN" class="headerlink" title="6.7.2 CASE WHEN"></a><strong>6.7.2 CASE WHEN</strong></h3><ol>
<li>数据准备</li>
</ol>
<table>
<thead>
<tr>
<th>name</th>
<th>dept_id</th>
<th>sex</th>
</tr>
</thead>
<tbody><tr>
<td>悟空</td>
<td>A</td>
<td>男</td>
</tr>
<tr>
<td>大海</td>
<td>A</td>
<td>男</td>
</tr>
<tr>
<td>宋宋</td>
<td>B</td>
<td>男</td>
</tr>
<tr>
<td>凤姐</td>
<td>A</td>
<td>女</td>
</tr>
<tr>
<td>婷姐</td>
<td>B</td>
<td>女</td>
</tr>
<tr>
<td>婷婷</td>
<td>B</td>
<td>女</td>
</tr>
</tbody></table>
<p>2．需求</p>
<p>求出不同部门男女各多少人。结果如下：</p>
<p>A   2    1</p>
<p>B   1    2</p>
<p>3．创建本地emp_sex.txt，导入数据</p>
<p><code>[xiaojia@hadoop01 datas]$ vi emp_sex.txt</code></p>
<p>悟空	A	男</p>
<p>大海	A	男</p>
<p>宋宋	B	男</p>
<p>凤姐	A	女</p>
<p>婷姐	B	女</p>
<p>婷婷	B	女</p>
<p>4．创建hive表并导入数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">create table emp_sex(</span><br><span class="line"></span><br><span class="line">name string, </span><br><span class="line"></span><br><span class="line">dept_id string, </span><br><span class="line"></span><br><span class="line">sex string) </span><br><span class="line"></span><br><span class="line">row format delimited fields terminated by &quot;\t&quot;;</span><br><span class="line"></span><br><span class="line">load data local inpath &#x27;/opt/module/datas/emp_sex.txt&#x27; into table emp_sex;</span><br></pre></td></tr></table></figure>

<p>5．按需求查询数据</p>
<p><code>select  dept_id, sum(case sex when &#39;男&#39; then 1 else 0 end) male_count, sum(case sex when &#39;女&#39; then 1 else 0 end) female_countfrom  emp_sexgroup by dept_id;</code></p>
<h3 id="6-7-2-行转列"><a href="#6-7-2-行转列" class="headerlink" title="6.7.2 行转列"></a><strong>6.7.2 行转列</strong></h3><p>1．相关函数说明</p>
<p>CONCAT(string A&#x2F;col, string B&#x2F;col…)：返回输入字符串连接后的结果，支持任意个输入字符串;&#96;&#96;&#96;</p>
<p>CONCAT_WS(separator, str1, str2,…)：它是一个特殊形式的 CONCAT()。第一个参数剩余参数间的分隔符。分隔符可以是与剩余参数一样的字符串。如果分隔符是 NULL，返回值也将为 NULL。这个函数会跳过分隔符参数后的任何 NULL 和空字符串。分隔符将被加到被连接的字符串之间;&#96;&#96;&#96;</p>
<p>COLLECT_SET(col)：函数只接受基本数据类型，它的主要作用是将某字段的值进行去重汇总，产生array类型字段。</p>
<p>2．数据准备</p>
<p>表6-6 数据准备</p>
<table>
<thead>
<tr>
<th>name</th>
<th>constellation</th>
<th>blood_type</th>
</tr>
</thead>
<tbody><tr>
<td>孙悟空</td>
<td>白羊座</td>
<td>A</td>
</tr>
<tr>
<td>大海</td>
<td>射手座</td>
<td>A</td>
</tr>
<tr>
<td>宋宋</td>
<td>白羊座</td>
<td>B</td>
</tr>
<tr>
<td>猪八戒</td>
<td>白羊座</td>
<td>A</td>
</tr>
<tr>
<td>凤姐</td>
<td>射手座</td>
<td>A</td>
</tr>
</tbody></table>
<p>3．需求</p>
<p>把星座和血型一样的人归类到一起。结果如下：</p>
<p>射手座,A       大海|凤姐</p>
<p>白羊座,A       孙悟空|猪八戒</p>
<p>白羊座,B       宋宋</p>
<p>4．创建本地constellation.txt，导入数据</p>
<p><code>[xiaojia@hadoop01 datas]$ vi constellation.txt</code></p>
<p>孙悟空	白羊座	A</p>
<p>大海	   射手座	A</p>
<p>宋宋	   白羊座	B</p>
<p>猪八戒  白羊座	A</p>
<p>凤姐	   射手座	A</p>
<p>5．创建hive表并导入数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">create table person_info(</span><br><span class="line"></span><br><span class="line">name string, </span><br><span class="line"></span><br><span class="line">constellation string, </span><br><span class="line"></span><br><span class="line">blood_type string) </span><br><span class="line"></span><br><span class="line">row format delimited fields terminated by &quot;\t&quot;;</span><br><span class="line"></span><br><span class="line">load data local inpath “/opt/module/datas/person_info.txt” into table person_info;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>6．按需求查询数据</p>
<p><code>select  t1.base,  concat_ws(&#39;|&#39;, collect_set(t1.name)) namefrom  (select    name,    concat(constellation, &quot;,&quot;, blood_type) base  from    person_info) t1group by  t1.base;</code></p>
<h3 id="6-7-3-列转行"><a href="#6-7-3-列转行" class="headerlink" title="6.7.3 列转行"></a><strong>6.7.3</strong> <strong>列转行</strong></h3><p>1．函数说明</p>
<p>EXPLODE(col)：将hive一列中复杂的array或者map结构拆分成多行。</p>
<p>LATERAL VIEW</p>
<p>用法：LATERAL VIEW udtf(expression) tableAlias AS columnAlias</p>
<p>解释：用于和split, explode等UDTF一起使用，它能够将一列数据拆成多行数据，在此基础上可以对拆分后的数据进行聚合。</p>
<p>2．数据准备</p>
<p>表6-7 数据准备</p>
<table>
<thead>
<tr>
<th>movie</th>
<th>category</th>
</tr>
</thead>
<tbody><tr>
<td>《疑犯追踪》</td>
<td>悬疑,动作,科幻,剧情</td>
</tr>
<tr>
<td>《Lie to me》</td>
<td>悬疑,警匪,动作,心理,剧情</td>
</tr>
<tr>
<td>《战狼2》</td>
<td>战争,动作,灾难</td>
</tr>
</tbody></table>
<p>3．需求</p>
<p>将电影分类中的数组数据展开。结果如下：</p>
<p>《疑犯追踪》    悬疑</p>
<p>《疑犯追踪》    动作</p>
<p>《疑犯追踪》    科幻</p>
<p>《疑犯追踪》    剧情</p>
<p>《Lie to me》  悬疑</p>
<p>《Lie to me》  警匪</p>
<p>《Lie to me》  动作</p>
<p>《Lie to me》  心理</p>
<p>《Lie to me》  剧情</p>
<p>《战狼2》     战争</p>
<p>《战狼2》     动作</p>
<p>《战狼2》     灾难</p>
<p>4．创建本地movie.txt，导入数据</p>
<p><code>[xiaojia@hadoop01 datas]$ vi movie.txt</code></p>
<p>《疑犯追踪》	悬疑,动作,科幻,剧情</p>
<p>《Lie to me》	悬疑,警匪,动作,心理,剧情</p>
<p>《战狼2》	战争,动作,灾难</p>
<p>5．创建hive表并导入数据</p>
<p><code>create table movie_info(  movie string,   category array&lt;string&gt;) row format delimited fields terminated by &quot;\t&quot;collection items terminated by &quot;,&quot;; load data local inpath &quot;/opt/module/datas/movie.txt&quot; into table movie_info;</code></p>
<p>6．按需求查询数据</p>
<p><code>select  movie,  category_namefrom   movie_info lateral view explode(category) table_tmp as category_name;</code></p>
<h3 id="6-7-4-窗口函数"><a href="#6-7-4-窗口函数" class="headerlink" title="6.7.4 窗口函数"></a><strong>6.7.4</strong> <strong>窗口函数</strong></h3><p>1．相关函数说明</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">```CURRENT ROW```：当前行</span><br><span class="line"></span><br><span class="line">```n PRECEDING```：往前n行数据</span><br><span class="line"></span><br><span class="line">```n FOLLOWING```：往后n行数据</span><br><span class="line"></span><br><span class="line">```UNBOUNDED```：起点，UNBOUNDED PRECEDING 表示从前面的起点， UNBOUNDED FOLLOWING表示到后面的终点</span><br><span class="line"></span><br><span class="line">```LAG(col,n)```：往前第n行数据</span><br><span class="line"></span><br><span class="line">```LEAD(col,n)```：往后第n行数据</span><br><span class="line"></span><br><span class="line">NTILE(n)：把有序分区中的行分发到指定数据的组中，各个组有编号，编号从1开始，对于每一行，NTILE返回此行所属的组的编号。注意：n必须为int类型。</span><br><span class="line"></span><br><span class="line">2．数据准备：name，orderdate，cost</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>jack,2017-01-01,10</p>
<p>tony,2017-01-02,15</p>
<p>jack,2017-02-03,23</p>
<p>tony,2017-01-04,29</p>
<p>jack,2017-01-05,46</p>
<p>jack,2017-04-06,42</p>
<p>tony,2017-01-07,50</p>
<p>jack,2017-01-08,55</p>
<p>mart,2017-04-08,62</p>
<p>mart,2017-04-09,68</p>
<p>neil,2017-05-10,12</p>
<p>mart,2017-04-11,75</p>
<p>neil,2017-06-12,80</p>
<p>mart,2017-04-13,94</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">3．需求</span><br><span class="line"></span><br><span class="line">（1）查询在2017年4月份购买过的顾客及总人数</span><br><span class="line"></span><br><span class="line">（2）查询顾客的购买明细及月购买总额</span><br><span class="line"></span><br><span class="line">（3）上述的场景,要将cost按照日期进行累加</span><br><span class="line"></span><br><span class="line">（4）查询顾客上次的购买时间</span><br><span class="line"></span><br><span class="line">（5）查询前20%时间的订单信息</span><br><span class="line"></span><br><span class="line">4．创建本地business.txt，导入数据</span><br><span class="line"></span><br><span class="line">[xiaojia@hadoop01 datas]$ vi business.txt</span><br><span class="line"></span><br><span class="line">5．创建hive表并导入数据</span><br><span class="line"></span><br><span class="line">```create table business(name string, orderdate string,cost int) ROW FORMAT DELIMITED FIELDS TERMINATED BY &#x27;,&#x27;;```</span><br><span class="line"></span><br><span class="line">``` load data local inpath &quot;/opt/module/datas/business.txt&quot; into table business;```</span><br><span class="line"></span><br><span class="line">6．按需求查询数据</span><br><span class="line"></span><br><span class="line">（1）查询在2017年4月份购买过的顾客及总人数</span><br><span class="line"></span><br><span class="line">```select name,count(*) over ()```</span><br><span class="line"></span><br><span class="line">``` from business where substring(orderdate,1,7) = &#x27;2017-04&#x27;``` </span><br><span class="line"></span><br><span class="line">``` group by name;```</span><br><span class="line"></span><br><span class="line">（2）查询顾客的购买明细及月购买总额</span><br><span class="line"></span><br><span class="line">```select name,orderdate,cost,sum(cost) over(partition by month(orderdate)) from business;```</span><br><span class="line"></span><br><span class="line">（3）上述的场景,要将cost按照日期进行累加</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>select name,orderdate,cost, sum(cost) over() as sample1,–所有行相加</p>
<p>sum(cost) over(partition by name) as sample2,–按name分组，组内数据相加 </p>
<p>sum(cost) over(partition by name order by orderdate) as sample3,–按name分组，组内数据累加 </p>
<p>sum(cost) over(partition by name order by orderdate rows between UNBOUNDED PRECEDING and current row ) as sample4 ,–和sample3一样,由起点到当前行的聚合 </p>
<p>sum(cost) over(partition by name order by orderdate rows between 1 PRECEDING and current row) as sample5, –当前行和前面一行做聚合 </p>
<p>sum(cost) over(partition by name order by orderdate rows between 1 PRECEDING AND 1 FOLLOWING ) as sample6,–当前行和前边一行及后面一行</p>
<p> sum(cost) over(partition by name order by orderdate rows between current row and UNBOUNDED FOLLOWING ) as sample7 –当前行及后面所有行</p>
<p> from business;</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">（4）查看顾客上次的购买时间</span><br><span class="line"></span><br><span class="line">```select name,orderdate,cost, lag(orderdate,1,&#x27;1900-01-01&#x27;) over(partition by name order by orderdate ) as time1, lag(orderdate,2) over (partition by name order by orderdate) as time2 from business;```</span><br><span class="line"></span><br><span class="line">（5）查询前20%时间的订单信息</span><br><span class="line"></span><br><span class="line">```select * from (  select name,orderdate,cost, ntile(5) over(order by orderdate) sorted  from business) twhere sorted = 1;```</span><br><span class="line"></span><br><span class="line">### **6.7.5** **Rank**</span><br><span class="line"></span><br><span class="line">1．函数说明</span><br><span class="line"></span><br><span class="line">RANK() 排序相同时会重复，总数不会变</span><br><span class="line"></span><br><span class="line">DENSE_RANK() 排序相同时会重复，总数会减少</span><br><span class="line"></span><br><span class="line">ROW_NUMBER() 会根据顺序计算</span><br><span class="line"></span><br><span class="line">2．数据准备</span><br><span class="line"></span><br><span class="line">表6-7 数据准备</span><br><span class="line"></span><br><span class="line">| name   | subject | score |</span><br><span class="line">| ------ | ------- | ----- |</span><br><span class="line">| 孙悟空 | 语文    | 87    |</span><br><span class="line">| 孙悟空 | 数学    | 95    |</span><br><span class="line">| 孙悟空 | 英语    | 68    |</span><br><span class="line">| 大海   | 语文    | 94    |</span><br><span class="line">| 大海   | 数学    | 56    |</span><br><span class="line">| 大海   | 英语    | 84    |</span><br><span class="line">| 宋宋   | 语文    | 64    |</span><br><span class="line">| 宋宋   | 数学    | 86    |</span><br><span class="line">| 宋宋   | 英语    | 84    |</span><br><span class="line">| 婷婷   | 语文    | 65    |</span><br><span class="line">| 婷婷   | 数学    | 85    |</span><br><span class="line">| 婷婷   | 英语    | 78    |</span><br><span class="line"></span><br><span class="line">3．需求</span><br><span class="line"></span><br><span class="line">计算每门学科成绩排名。</span><br><span class="line"></span><br><span class="line">4．创建本地movie.txt，导入数据</span><br><span class="line"></span><br><span class="line">```[xiaojia@hadoop01 datas]$ vi score.txt```</span><br><span class="line"></span><br><span class="line">5．创建hive表并导入数据</span><br><span class="line"></span><br><span class="line">```create table score(name string,subject string, score int) row format delimited fields terminated by &quot;\t&quot;;load data local inpath &#x27;/opt/module/datas/score.txt&#x27; into table score;```</span><br><span class="line"></span><br><span class="line">6．按需求查询数据</span><br><span class="line"></span><br><span class="line">```select name,subject,score,rank() over(partition by subject order by score desc) rp,```</span><br><span class="line"></span><br><span class="line">```dense_rank() over(partition by subject order by score desc) drp,```</span><br><span class="line"></span><br><span class="line">```row_number() over(partition by subject order by score desc) rmp```</span><br><span class="line"></span><br><span class="line">```from score;```</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p> name   subject score  rp    drp   rmp</p>
<p>孙悟空  数学 </p>
<p>  95    1    1    1</p>
<p>宋宋   数学   86    2    2    2</p>
<p>婷婷   数学   85    3    3    3</p>
<p>大海   数学   56    4    4    4</p>
<p>宋宋   英语   84    1    1    1</p>
<p>大海   英语   84    1    1    2</p>
<p>婷婷   英语   78    3    2    3</p>
<p>孙悟空  英语   68    4    3    4</p>
<p>大海   语文   94    1    1    1</p>
<p>孙悟空  语文   87    2    2    2</p>
<p>婷婷   语文   65    3    3    3</p>
<p>宋宋   语文   64    4    4    4</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># **第7章** **函数**</span><br><span class="line"></span><br><span class="line">## **7.1** **系统内置函数**</span><br><span class="line"></span><br><span class="line">1．查看系统自带的函数</span><br><span class="line"></span><br><span class="line">```hive&gt; show functions;```</span><br><span class="line"></span><br><span class="line">2．显示自带的函数的用法</span><br><span class="line"></span><br><span class="line">```hive&gt; desc function upper;```</span><br><span class="line"></span><br><span class="line">3．详细显示自带的函数的用法</span><br><span class="line"></span><br><span class="line">```hive&gt; desc function extended upper;```</span><br><span class="line"></span><br><span class="line">## **7.2 自定义函数**</span><br><span class="line"></span><br><span class="line">1）Hive 自带了一些函数，比如：max/min等，但是数量有限，自己可以通过自定义UDF来方便的扩展。</span><br><span class="line"></span><br><span class="line">2）当Hive提供的内置函数无法满足你的业务处理需要时，此时就可以考虑使用用户自定义函数（UDF：user-defined function）。</span><br><span class="line"></span><br><span class="line">3）根据用户自定义函数类别分为以下三种：</span><br><span class="line"></span><br><span class="line">	（1）UDF（User-Defined-Function）</span><br><span class="line">	</span><br><span class="line">		一进一出</span><br><span class="line">	</span><br><span class="line">	（2）UDAF（User-Defined Aggregation Function）</span><br><span class="line">	</span><br><span class="line">		聚集函数，多进一出</span><br><span class="line">	</span><br><span class="line">		类似于：count/max/min</span><br><span class="line">	</span><br><span class="line">	（3）UDTF（User-Defined Table-Generating Functions）</span><br><span class="line">	</span><br><span class="line">		一进多出</span><br><span class="line">	</span><br><span class="line">		如lateral view explore()</span><br><span class="line"></span><br><span class="line">4）官方文档地址</span><br><span class="line"></span><br><span class="line">https://cwiki.apache.org/confluence/display/Hive/HivePlugins</span><br><span class="line"></span><br><span class="line">5）编程步骤：</span><br><span class="line"></span><br><span class="line">	（1）继承org.apache.hadoop.hive.ql.UDF</span><br><span class="line">	</span><br><span class="line">	（2）需要实现evaluate函数；evaluate函数支持重载；</span><br><span class="line">	</span><br><span class="line">	（3）在hive的命令行窗口创建函数</span><br><span class="line">	</span><br><span class="line">		a）添加jar</span><br><span class="line"></span><br><span class="line">```add jar linux_jar_path```</span><br><span class="line"></span><br><span class="line">		b）创建function，</span><br><span class="line"></span><br><span class="line">```create [temporary] function [dbname.]function_name AS class_name;```</span><br><span class="line"></span><br><span class="line">	（4）在hive的命令行窗口删除函数</span><br><span class="line"></span><br><span class="line">```Drop [temporary] function [if exists] [dbname.]function_name;```</span><br><span class="line"></span><br><span class="line">6）注意事项</span><br><span class="line"></span><br><span class="line">	（1）UDF必须要有返回类型，可以返回null，但是返回类型不能为void；</span><br><span class="line"></span><br><span class="line">## **7.3 自定义UDF函数**</span><br><span class="line"></span><br><span class="line">1．创建一个Maven工程Hive</span><br><span class="line"></span><br><span class="line">2．导入依赖</span><br><span class="line"></span><br><span class="line">```xml</span><br><span class="line">&lt;dependencies&gt;</span><br><span class="line">    &lt;!-- https://mvnrepository.com/artifact/org.apache.hive/hive-exec --&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.apache.hive&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;hive-exec&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;1.2.1&lt;/version&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">&lt;/dependencies&gt;</span><br></pre></td></tr></table></figure>





<p>3．创建一个类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xiaojia.hive;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hive.ql.exec.UDF;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Lower</span> <span class="keyword">extends</span> <span class="title class_">UDF</span> &#123;</span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">evaluate</span> <span class="params">(<span class="keyword">final</span> String s)</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (s == <span class="literal">null</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> s.toLowerCase();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<p>4．打成jar包上传到服务器&#x2F;opt&#x2F;module&#x2F;jars&#x2F;udf.jar</p>
<p>5．将jar包添加到hive的classpath</p>
<p><code>hive (default)&gt; add jar /opt/module/datas/udf.jar;</code></p>
<p>6．创建临时函数与开发好的java class关联</p>
<p><code>hive (default)&gt; create temporary function mylower as &quot;com.xiaojia.hive.Lower&quot;;</code></p>
<p>7．即可在hql中使用自定义的函数strip </p>
<p><code>hive (default)&gt; select ename, mylower(ename) lowername from emp;</code></p>
<h1 id="第8章-压缩和存储"><a href="#第8章-压缩和存储" class="headerlink" title="第8章 压缩和存储"></a><strong>第8章</strong> <strong>压缩和存储</strong></h1><h2 id="8-1-Hadoop源码编译支持Snappy压缩"><a href="#8-1-Hadoop源码编译支持Snappy压缩" class="headerlink" title="8.1 Hadoop源码编译支持Snappy压缩"></a><strong>8.1 Hadoop源码编译支持Snappy压缩</strong></h2><h3 id="8-1-1-资源准备"><a href="#8-1-1-资源准备" class="headerlink" title="8.1.1 资源准备"></a><strong>8.1.1 资源准备</strong></h3><p>1．CentOS联网 </p>
<p>配置CentOS能连接外网。Linux虚拟机ping <a target="_blank" rel="noopener" href="http://www.baidu.com/">www.baidu.com</a> 是畅通的</p>
<p>注意：采用root角色编译，减少文件夹权限出现问题</p>
<p>2．jar包准备(hadoop源码、JDK8 、maven、protobuf)</p>
<p>（1）hadoop-2.7.2-src.tar.gz</p>
<p>（2）jdk-8u144-linux-x64.tar.gz</p>
<p>（3）snappy-1.1.3.tar.gz</p>
<p>（4）apache-maven-3.0.5-bin.tar.gz</p>
<p>（5）protobuf-2.5.0.tar.gz</p>
<h3 id="8-1-2-jar包安装"><a href="#8-1-2-jar包安装" class="headerlink" title="8.1.2 jar包安装"></a><strong>8.1.2 jar包安装</strong></h3><p>注意：所有操作必须在root用户下完成</p>
<p>1．JDK解压、配置环境变量JAVA_HOME和PATH，验证<a target="_blank" rel="noopener" href="http://lib.csdn.net/base/javase">java</a>-version(如下都需要验证是否配置成功)</p>
<p><code>[root@hadoop101 software] # tar -zxf jdk-8u144-linux-x64.tar.gz -C /opt/module/</code></p>
<p><code>[root@hadoop101 software]# vi /etc/profile</code></p>
<p><code>#JAVA_HOMEexport JAVA_HOME=/opt/module/jdk1.8.0_144export PATH=$PATH:$JAVA_HOME/bin</code></p>
<p><code>[root@hadoop101 software]#source /etc/profile</code></p>
<p>验证命令：java -version</p>
<p>2．Maven解压、配置 MAVEN_HOME和PATH</p>
<p><code>[root@hadoop101 software]# tar -zxvf apache-maven-3.0.5-bin.tar.gz -C /opt/module/</code></p>
<p><code>[root@hadoop101 apache-maven-3.0.5]# vi /etc/profile</code></p>
<p><code>#MAVEN_HOMEexport MAVEN_HOME=/opt/module/apache-maven-3.0.5export PATH=$PATH:$MAVEN_HOME/bin</code></p>
<p><code>[root@hadoop101 software]#source /etc/profile</code></p>
<p>验证命令：mvn -version</p>
<h3 id="8-1-3-编译源码"><a href="#8-1-3-编译源码" class="headerlink" title="8.1.3 编译源码"></a><strong>8.1.3 编译源码</strong></h3><p>1．准备编译环境</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@hadoop101 software]# yum install svn</span><br><span class="line"></span><br><span class="line">[root@hadoop101 software]# yum install autoconf automake libtool cmake</span><br><span class="line"></span><br><span class="line">[root@hadoop101 software]# yum install ncurses-devel</span><br><span class="line"></span><br><span class="line">[root@hadoop101 software]# yum install openssl-devel</span><br><span class="line"></span><br><span class="line">[root@hadoop101 software]# yum install gcc*</span><br></pre></td></tr></table></figure>





<p>2．编译安装snappy</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@hadoop101 software]# tar -zxvf snappy-1.1.3.tar.gz -C /opt/module/</span><br><span class="line"></span><br><span class="line">[root@hadoop101 module]# cd snappy-1.1.3/</span><br><span class="line"></span><br><span class="line">[root@hadoop101 snappy-1.1.3]# ./configure</span><br><span class="line"></span><br><span class="line">[root@hadoop101 snappy-1.1.3]# make</span><br><span class="line"></span><br><span class="line">[root@hadoop101 snappy-1.1.3]# make install</span><br></pre></td></tr></table></figure>





<p># 查看snappy库文件</p>
<p><code>[root@hadoop101 snappy-1.1.3]# ls -lh /usr/local/lib |grep snappy</code></p>
<p>3．编译安装protobuf</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@hadoop101 software]# tar -zxvf protobuf-2.5.0.tar.gz -C /opt/module/</span><br><span class="line"></span><br><span class="line">[root@hadoop101 module]# cd protobuf-2.5.0/</span><br><span class="line"></span><br><span class="line">[root@hadoop101 protobuf-2.5.0]# ./configure </span><br><span class="line"></span><br><span class="line">[root@hadoop101 protobuf-2.5.0]#  make </span><br><span class="line"></span><br><span class="line">[root@hadoop101 protobuf-2.5.0]#  make install</span><br><span class="line"></span><br><span class="line">\# 查看protobuf版本以测试是否安装成功</span><br><span class="line">[root@hadoop101 protobuf-2.5.0]# protoc --version</span><br></pre></td></tr></table></figure>





<p>4．编译hadoop native</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@hadoop101 software]# tar -zxvf hadoop-2.7.2-src.tar.gz</span><br><span class="line"></span><br><span class="line">[root@hadoop101 software]# cd hadoop-2.7.2-src/</span><br><span class="line"></span><br><span class="line">[root@hadoop101 software]# mvn clean package -DskipTests -Pdist,native -Dtar -Dsnappy.lib=/usr/local/lib -Dbundle.snappy</span><br></pre></td></tr></table></figure>





<p>执行成功后，&#x2F;opt&#x2F;software&#x2F;hadoop-2.7.2-src&#x2F;hadoop-dist&#x2F;target&#x2F;<a target="_blank" rel="noopener" href="http://lib.csdn.net/base/hadoop">hadoop</a>-2.7.2.tar.gz即为新生成的支持snappy压缩的二进制安装包。</p>
<h2 id="8-2-Hadoop压缩配置"><a href="#8-2-Hadoop压缩配置" class="headerlink" title="8.2 Hadoop压缩配置"></a><strong>8.2 Hadoop压缩配置</strong></h2><h3 id="8-2-1-MR支持的压缩编码"><a href="#8-2-1-MR支持的压缩编码" class="headerlink" title="8.2.1 MR支持的压缩编码"></a><strong>8.2.1 MR支持的压缩编码</strong></h3><p>表6-8</p>
<table>
<thead>
<tr>
<th>压缩格式</th>
<th>工具</th>
<th>算法</th>
<th>文件扩展名</th>
<th>是否可切分</th>
</tr>
</thead>
<tbody><tr>
<td>DEFAULT</td>
<td>无</td>
<td>DEFAULT</td>
<td>.deflate</td>
<td>否</td>
</tr>
<tr>
<td>Gzip</td>
<td>gzip</td>
<td>DEFAULT</td>
<td>.gz</td>
<td>否</td>
</tr>
<tr>
<td>bzip2</td>
<td>bzip2</td>
<td>bzip2</td>
<td>.bz2</td>
<td>是</td>
</tr>
<tr>
<td>LZO</td>
<td>lzop</td>
<td>LZO</td>
<td>.lzo</td>
<td>是</td>
</tr>
<tr>
<td>Snappy</td>
<td>无</td>
<td>Snappy</td>
<td>.snappy</td>
<td>否</td>
</tr>
</tbody></table>
<p>为了支持多种压缩&#x2F;解压缩算法，Hadoop引入了编码&#x2F;解码器，如下表所示：</p>
<p>表6-9</p>
<table>
<thead>
<tr>
<th>压缩格式</th>
<th>对应的编码&#x2F;解码器</th>
</tr>
</thead>
<tbody><tr>
<td>DEFLATE</td>
<td>org.apache.hadoop.io.compress.DefaultCodec</td>
</tr>
<tr>
<td>gzip</td>
<td>org.apache.hadoop.io.compress.GzipCodec</td>
</tr>
<tr>
<td>bzip2</td>
<td>org.apache.hadoop.io.compress.BZip2Codec</td>
</tr>
<tr>
<td>LZO</td>
<td>com.hadoop.compression.lzo.LzopCodec</td>
</tr>
<tr>
<td>Snappy</td>
<td>org.apache.hadoop.io.compress.SnappyCodec</td>
</tr>
</tbody></table>
<p>压缩性能的比较：</p>
<p>表6-10</p>
<table>
<thead>
<tr>
<th>压缩算法</th>
<th>原始文件大小</th>
<th>压缩文件大小</th>
<th>压缩速度</th>
<th>解压速度</th>
</tr>
</thead>
<tbody><tr>
<td>gzip</td>
<td>8.3GB</td>
<td>1.8GB</td>
<td>17.5MB&#x2F;s</td>
<td>58MB&#x2F;s</td>
</tr>
<tr>
<td>bzip2</td>
<td>8.3GB</td>
<td>1.1GB</td>
<td>2.4MB&#x2F;s</td>
<td>9.5MB&#x2F;s</td>
</tr>
<tr>
<td>LZO</td>
<td>8.3GB</td>
<td>2.9GB</td>
<td>49.3MB&#x2F;s</td>
<td>74.6MB&#x2F;s</td>
</tr>
</tbody></table>
<p><a target="_blank" rel="noopener" href="http://google.github.io/snappy/">http://google.github.io/snappy/</a></p>
<p>On a single core of a Core i7 processor in 64-bit mode, Snappy compresses at about 250 MB&#x2F;sec or more and decompresses at about 500 MB&#x2F;sec or more.</p>
<h3 id="8-2-2-压缩参数配置"><a href="#8-2-2-压缩参数配置" class="headerlink" title="8.2.2 压缩参数配置"></a><strong>8.2.2 压缩参数配置</strong></h3><p>要在Hadoop中启用压缩，可以配置如下参数（mapred-site.xml文件中）：</p>
<p>表6-11</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>默认值</th>
<th>阶段</th>
<th>建议</th>
</tr>
</thead>
<tbody><tr>
<td>io.compression.codecs  （在core-site.xml中配置）</td>
<td>org.apache.hadoop.io.compress.DefaultCodec, org.apache.hadoop.io.compress.GzipCodec, org.apache.hadoop.io.compress.BZip2Codec,org.apache.hadoop.io.compress.Lz4Codec</td>
<td>输入压缩</td>
<td>Hadoop使用文件扩展名判断是否支持某种编解码器</td>
</tr>
<tr>
<td>mapreduce.map.output.compress</td>
<td>false</td>
<td>mapper输出</td>
<td>这个参数设为true启用压缩</td>
</tr>
<tr>
<td>mapreduce.map.output.compress.codec</td>
<td>org.apache.hadoop.io.compress.DefaultCodec</td>
<td>mapper输出</td>
<td>使用LZO、LZ4或snappy编解码器在此阶段压缩数据</td>
</tr>
<tr>
<td>mapreduce.output.fileoutputformat.compress</td>
<td>false</td>
<td>reducer输出</td>
<td>这个参数设为true启用压缩</td>
</tr>
<tr>
<td>mapreduce.output.fileoutputformat.compress.codec</td>
<td>org.apache.hadoop.io.compress. DefaultCodec</td>
<td>reducer输出</td>
<td>使用标准工具或者编解码器，如gzip和bzip2</td>
</tr>
<tr>
<td>mapreduce.output.fileoutputformat.compress.type</td>
<td>RECORD</td>
<td>reducer输出</td>
<td>SequenceFile输出使用的压缩类型：NONE和BLOCK</td>
</tr>
</tbody></table>
<h2 id="8-3-开启Map输出阶段压缩"><a href="#8-3-开启Map输出阶段压缩" class="headerlink" title="8.3 开启Map输出阶段压缩"></a><strong>8.3 开启Map输出阶段压缩</strong></h2><p>开启map输出阶段压缩可以减少job中map和Reduce task间数据传输量。具体配置如下：</p>
<p><strong>案例实操：</strong></p>
<p>1．开启hive中间传输数据压缩功能</p>
<p><code>hive (default)&gt;set hive.exec.compress.intermediate=true;</code></p>
<p>2．开启mapreduce中map输出压缩功能</p>
<p><code>hive (default)&gt;set mapreduce.map.output.compress=true;</code></p>
<p>3．设置mapreduce中map输出数据的压缩方式</p>
<p>hive (default)&gt;set mapreduce.map.output.compress.codec&#x3D;org.apache.hadoop.io.compress.SnappyCodec;</p>
<p>4．执行查询语句</p>
<pre><code>```hive (default)&gt; select count(ename) name from emp;```
</code></pre>
<h2 id="8-4-开启Reduce输出阶段压缩"><a href="#8-4-开启Reduce输出阶段压缩" class="headerlink" title="8.4 开启Reduce输出阶段压缩"></a><strong>8.4 开启Reduce输出阶段压缩</strong></h2><p>当Hive将输出写入到表中时，输出内容同样可以进行压缩。属性hive.exec.compress.output控制着这个功能。用户可能需要保持默认设置文件中的默认值false，这样默认的输出就是非压缩的纯文本文件了。用户可以通过在查询语句或执行脚本中设置这个值为true，来开启输出结果压缩功能。</p>
<p><strong>案例实操：</strong></p>
<p>1．开启hive最终输出数据压缩功能</p>
<p><code>hive (default)&gt;set hive.exec.compress.output=true;</code></p>
<p>2．开启mapreduce最终输出数据压缩</p>
<p><code>hive (default)&gt;set mapreduce.output.fileoutputformat.compress=true;</code></p>
<p>3．设置mapreduce最终数据输出压缩方式</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">org.apache.hadoop.io.compress.SnappyCodec;</span><br></pre></td></tr></table></figure>

<p>4．设置mapreduce最终数据输出压缩为块压缩</p>
<p><code>hive (default)&gt; set mapreduce.output.fileoutputformat.compress.type=BLOCK;</code></p>
<p>5．测试一下输出结果是否是压缩文件</p>
<p><code>hive (default)&gt; insert overwrite local directory</code></p>
<p><code> &#39;/opt/module/datas/distribute-result&#39; select * from emp distribute by deptno sort by empno desc;</code></p>
<h2 id="8-5-文件存储格式"><a href="#8-5-文件存储格式" class="headerlink" title="8.5 文件存储格式"></a><strong>8.5 文件存储格式</strong></h2><p>Hive支持的存储数的格式主要有：TEXTFILE 、SEQUENCEFILE、ORC、PARQUET。</p>
<h3 id="8-5-1-列式存储和行式存储"><a href="#8-5-1-列式存储和行式存储" class="headerlink" title="8.5.1 列式存储和行式存储"></a><strong>8.5.1 列式存储和行式存储</strong></h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="file:////tmp/wps-xiaojia/ksohtml/wpsIiNsjU.jpg" alt="img"> </p>
<p>图6-10 列式存储和行式存储</p>
<p>如图6-10所示左边为逻辑表，右边第一个为行式存储，第二个为列式存储。</p>
<p>1．行存储的特点</p>
<p>查询满足条件的一整行数据的时候，列存储则需要去每个聚集的字段找到对应的每个列的值，行存储只需要找到其中一个值，其余的值都在相邻地方，所以此时行存储查询的速度更快。</p>
<p>2．列存储的特点</p>
<p>因为每个字段的数据聚集存储，在查询只需要少数几个字段的时候，能大大减少读取的数据量；每个字段的数据类型一定是相同的，列式存储可以针对性的设计更好的设计压缩算法。</p>
<p>TEXTFILE和SEQUENCEFILE的存储格式都是基于行存储的；</p>
<p>ORC和PARQUET是基于列式存储的。</p>
<h3 id="8-5-2-TextFile格式"><a href="#8-5-2-TextFile格式" class="headerlink" title="8.5.2 TextFile格式"></a><strong>8.5.2 TextFile格式</strong></h3><p>默认格式，数据不做压缩，磁盘开销大，数据解析开销大。可结合Gzip、Bzip2使用，但使用Gzip这种方式，hive不会对数据进行切分，从而无法对数据进行并行操作。</p>
<h3 id="8-5-3-Orc格式"><a href="#8-5-3-Orc格式" class="headerlink" title="8.5.3 Orc格式"></a><strong>8.5.3 Orc格式</strong></h3><p>Orc (Optimized Row Columnar)是Hive 0.11版里引入的新的存储格式。</p>
<p>如图6-11所示可以看到每个Orc文件由1个或多个stripe组成，每个stripe250MB大小，这个Stripe实际相当于RowGroup概念，不过大小由4MB-&gt;250MB，这样应该能提升顺序读的吞吐率。每个Stripe里有三部分组成，分别是Index Data，Row Data，Stripe Footer：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="file:////tmp/wps-xiaojia/ksohtml/wpsgDlcOn.jpg" alt="img"> </p>
<p>图6-11 Orc格式</p>
<pre><code>  1）Index Data：一个轻量级的index，默认是每隔1W行做一个索引。这里做的索引应该只是记录某行的各字段在Row Data中的offset。
  
  2）Row Data：存的是具体的数据，先取部分行，然后对这些行按列进行存储。对每个列进行了编码，分成多个Stream来存储。
</code></pre>
<p>  3）Stripe Footer：存的是各个Stream的类型，长度等信息。</p>
<p>每个文件有一个File Footer，这里面存的是每个Stripe的行数，每个Column的数据类型信息等；每个文件的尾部是一个PostScript，这里面记录了整个文件的压缩类型以及FileFooter的长度信息等。在读取文件时，会seek到文件尾部读PostScript，从里面解析到File Footer长度，再读FileFooter，从里面解析到各个Stripe信息，再读各个Stripe，即从后往前读。</p>
<h3 id="8-5-4-Parquet格式"><a href="#8-5-4-Parquet格式" class="headerlink" title="8.5.4 Parquet格式"></a><strong>8.5.4 Parquet格式</strong></h3><p>Parquet是面向分析型业务的列式存储格式，由Twitter和Cloudera合作开发，2015年5月从Apache的孵化器里毕业成为Apache顶级项目。</p>
<p>Parquet文件是以二进制方式存储的，所以是不可以直接读取的，文件中包括该文件的数据和元数据，因此Parquet格式文件是自解析的。</p>
<p>通常情况下，在存储Parquet数据的时候会按照Block大小设置行组的大小，由于一般情况下每一个Mapper任务处理数据的最小单位是一个Block，这样可以把每一个行组由一个Mapper任务处理，增大任务执行并行度。Parquet文件的格式如图6-12所示。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="file:////tmp/wps-xiaojia/ksohtml/wpszTr0iR.jpg" alt="img"></p>
<p>图6-12  Parquet格式</p>
<p>上图展示了一个Parquet文件的内容，一个文件中可以存储多个行组，文件的首位都是该文件的Magic Code，用于校验它是否是一个Parquet文件，Footer length记录了文件元数据的大小，通过该值和文件长度可以计算出元数据的偏移量，文件的元数据中包括每一个行组的元数据信息和该文件存储数据的Schema信息。除了文件中每一个行组的元数据，每一页的开始都会存储该页的元数据，在Parquet中，有三种类型的页：数据页、字典页和索引页。数据页用于存储当前行组中该列的值，字典页存储该列值的编码字典，每一个列块中最多包含一个字典页，索引页用来存储当前行组下该列的索引，目前Parquet中还不支持索引页。</p>
<h3 id="8-5-5-主流文件存储格式对比实验"><a href="#8-5-5-主流文件存储格式对比实验" class="headerlink" title="8.5.5 主流文件存储格式对比实验"></a><strong>8.5.5 主流文件存储格式对比实验</strong></h3><p>从存储文件的压缩比和查询速度两个角度对比。</p>
<p><strong>存储文件的压缩比测试：</strong></p>
<p>\1. 测试数据</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="file:////tmp/wps-xiaojia/ksohtml/wpsadtSNk.png" alt="img"></p>
<p>2．TextFile</p>
<p>（1）创建表，存储数据格式为TEXTFILE</p>
<p><code>create table log_text (track_time string,url string,session_id string,referer string,ip string,end_user_id string,city_id string)row format delimited fields terminated by &#39;\t&#39;stored as textfile ;</code></p>
<p>（2）向表中加载数据</p>
<p><code>hive (default)&gt; load data local inpath &#39;/opt/module/datas/log.data&#39; into table log_text ;</code></p>
<p>（3）查看表中数据大小</p>
<p>hive (default)&gt; dfs -du -h &#x2F;user&#x2F;hive&#x2F;warehouse&#x2F;log_text;&#96;&#96;&#96;</p>
<p>18.1 M  &#x2F;user&#x2F;hive&#x2F;warehouse&#x2F;log_text&#x2F;log.data</p>
<p>3．ORC</p>
<p>​	（1）创建表，存储数据格式为ORC</p>
<p>create table log_orc(track_time string,url string,session_id string,referer string,ip string,end_user_id string,city_id string)row format delimited fields terminated by ‘\t’stored as orc ;&#96;&#96;&#96;</p>
<p>（2）向表中加载数据</p>
<p><code>hive (default)&gt; insert into table log_orc select * from log_text ;</code></p>
<p>（3）查看表中数据大小</p>
<p><code>hive (default)&gt; dfs -du -h /user/hive/warehouse/log_orc/ ;</code></p>
<p>2.8 M  &#x2F;user&#x2F;hive&#x2F;warehouse&#x2F;log_orc&#x2F;000000_0</p>
<p>4．Parquet</p>
<p>（1）创建表，存储数据格式为parquet</p>
<p><code>create table log_parquet(track_time string,url string,session_id string,referer string,ip string,end_user_id string,city_id string)row format delimited fields terminated by &#39;\t&#39;stored as parquet ;</code>	</p>
<p>（2）向表中加载数据</p>
<p><code>hive (default)&gt; insert into table log_parquet select * from log_text ;</code></p>
<p>（3）查看表中数据大小</p>
<p><code>hive (default)&gt; dfs -du -h /user/hive/warehouse/log_parquet/ ;</code></p>
<p>13.1 M  &#x2F;user&#x2F;hive&#x2F;warehouse&#x2F;log_parquet&#x2F;000000_0</p>
<p>存储文件的压缩比总结：</p>
<p>ORC &gt;  Parquet &gt;  textFile</p>
<p><strong>存储文件的查询速度测试：</strong></p>
<p>1．TextFile</p>
<p><code>hive (default)&gt; select count(*) from log_text;</code></p>
<p>_c0</p>
<p>100000</p>
<p>Time taken: 21.54 seconds, Fetched: 1 row(s)</p>
<p>Time taken: 21.08 seconds, Fetched: 1 row(s)</p>
<p>Time taken: 19.298 seconds, Fetched: 1 row(s)</p>
<p>2．ORC</p>
<p><code>hive (default)&gt; select count(*) from log_orc;</code></p>
<p>_c0</p>
<p>100000</p>
<p>Time taken: 20.867 seconds, Fetched: 1 row(s)</p>
<p>Time taken: 22.667 seconds, Fetched: 1 row(s)</p>
<p>Time taken: 18.36 seconds, Fetched: 1 row(s)</p>
<p>3．Parquet</p>
<p><code>hive (default)&gt; select count(*) from log_parquet;</code></p>
<p>_c0</p>
<p>100000</p>
<p>Time taken: 22.922 seconds, Fetched: 1 row(s)</p>
<p>Time taken: 21.074 seconds, Fetched: 1 row(s)</p>
<p>Time taken: 18.384 seconds, Fetched: 1 row(s)</p>
<p>存储文件的查询速度总结：查询速度相近。</p>
<h2 id="8-6-存储和压缩结合"><a href="#8-6-存储和压缩结合" class="headerlink" title="8.6 存储和压缩结合"></a><strong>8.6 存储和压缩结合</strong></h2><h3 id="8-6-1-修改Hadoop集群具有Snappy压缩方式"><a href="#8-6-1-修改Hadoop集群具有Snappy压缩方式" class="headerlink" title="8.6.1 修改Hadoop集群具有Snappy压缩方式"></a><strong>8.6.1</strong> <strong>修改Hadoop集群具有Snappy压缩方式</strong></h3><p>1．查看hadoop checknative命令使用</p>
<p><code>[xiaojia@hadoop104 hadoop-2.7.2]$ hadoop checknative [-a|-h]  check native hadoop and compression libraries availability</code></p>
<p>2．查看hadoop支持的压缩方式</p>
<p>​	<code>[xiaojia@hadoop104 hadoop-2.7.2]$ hadoop checknative</code></p>
<p>17&#x2F;12&#x2F;24 20:32:52 WARN bzip2.Bzip2Factory: Failed to load&#x2F;initialize native-bzip2 library system-native, will use pure-Java version</p>
<p>17&#x2F;12&#x2F;24 20:32:52 INFO zlib.ZlibFactory: Successfully loaded &amp; initialized native-zlib library</p>
<p>Native library checking:</p>
<p>hadoop:  true &#x2F;opt&#x2F;module&#x2F;hadoop-2.7.2&#x2F;lib&#x2F;native&#x2F;libhadoop.so</p>
<p>zlib:   true &#x2F;lib64&#x2F;libz.so.1</p>
<p>snappy:  false </p>
<p>lz4:   true revision:99</p>
<p>bzip2:  false</p>
<p>3．将编译好的支持Snappy压缩的hadoop-2.7.2.tar.gz包导入到hadoop01的&#x2F;opt&#x2F;software中</p>
<p>4．解压hadoop-2.7.2.tar.gz到当前路径</p>
<p><code>[xiaojia@hadoop01 software]$ tar -zxvf hadoop-2.7.2.tar.gz</code></p>
<p>5．进入到&#x2F;opt&#x2F;software&#x2F;hadoop-2.7.2&#x2F;lib&#x2F;native路径可以看到支持Snappy压缩的动态链接库</p>
<p><code>[xiaojia@hadoop01 native]$ pwd</code></p>
<p>&#x2F;opt&#x2F;software&#x2F;hadoop-2.7.2&#x2F;lib&#x2F;native</p>
<p><code>[xiaojia@hadoop01 native]$ ll</code></p>
<p>-rw-r–r–. 1 xiaojia xiaojia  472950 9月  1 10:19 libsnappy.a</p>
<p>-rwxr-xr-x. 1 xiaojia xiaojia   955 9月  1 10:19 libsnappy.la</p>
<p>lrwxrwxrwx. 1 xiaojia xiaojia    18 12月 24 20:39 libsnappy.so -&gt; libsnappy.so.1.3.0</p>
<p>lrwxrwxrwx. 1 xiaojia xiaojia    18 12月 24 20:39 libsnappy.so.1 -&gt; libsnappy.so.1.3.0</p>
<p>-rwxr-xr-x. 1 xiaojia xiaojia  228177 9月  1 10:19 libsnappy.so.1.3.0</p>
<p>6．拷贝&#x2F;opt&#x2F;software&#x2F;hadoop-2.7.2&#x2F;lib&#x2F;native里面的所有内容到开发集群的&#x2F;opt&#x2F;module&#x2F;hadoop-2.7.2&#x2F;lib&#x2F;native路径上</p>
<p><code>[xiaojia@hadoop01 native]$ cp ../native/* /opt/module/hadoop-2.7.2/lib/native/</code></p>
<p>7．分发集群</p>
<p><code>[xiaojia@hadoop01 lib]$ xsync native/</code></p>
<p>8．再次查看hadoop支持的压缩类型</p>
<p><code>[xiaojia@hadoop01 hadoop-2.7.2]$ hadoop checknative</code></p>
<p>17&#x2F;12&#x2F;24 20:45:02 WARN bzip2.Bzip2Factory: Failed to load&#x2F;initialize native-bzip2 library system-native, will use pure-Java version</p>
<p>17&#x2F;12&#x2F;24 20:45:02 INFO zlib.ZlibFactory: Successfully loaded &amp; initialized native-zlib library</p>
<p>Native library checking:</p>
<p>hadoop:  true &#x2F;opt&#x2F;module&#x2F;hadoop-2.7.2&#x2F;lib&#x2F;native&#x2F;libhadoop.so</p>
<p>zlib:   true &#x2F;lib64&#x2F;libz.so.1</p>
<p>snappy:  true &#x2F;opt&#x2F;module&#x2F;hadoop-2.7.2&#x2F;lib&#x2F;native&#x2F;libsnappy.so.1</p>
<p>lz4:   true revision:99</p>
<p>bzip2:  false</p>
<p>9．重新启动hadoop集群和hive</p>
<h3 id="8-6-2-测试存储和压缩"><a href="#8-6-2-测试存储和压缩" class="headerlink" title="8.6.2 测试存储和压缩"></a><strong>8.6.2</strong> <strong>测试存储和压缩</strong></h3><p>官网：<a target="_blank" rel="noopener" href="https://cwiki.apache.org/confluence/display/Hive/LanguageManual+ORC">https://cwiki.apache.org/confluence/display/Hive/LanguageManual+ORC</a></p>
<p>ORC存储方式的压缩：</p>
<p>表6-12</p>
<table>
<thead>
<tr>
<th>Key</th>
<th>Default</th>
<th>Notes</th>
</tr>
</thead>
<tbody><tr>
<td>orc.compress</td>
<td>ZLIB</td>
<td>high level compression (one of NONE, ZLIB, SNAPPY)</td>
</tr>
<tr>
<td>orc.compress.size</td>
<td>262,144</td>
<td>number of bytes in each compression chunk</td>
</tr>
<tr>
<td>orc.stripe.size</td>
<td>67,108,864</td>
<td>number of bytes in each stripe</td>
</tr>
<tr>
<td>orc.row.index.stride</td>
<td>10,000</td>
<td>number of rows between index entries (must be &gt;&#x3D; 1000)</td>
</tr>
<tr>
<td>orc.create.index</td>
<td>true</td>
<td>whether to create row indexes</td>
</tr>
<tr>
<td>orc.bloom.filter.columns</td>
<td>“”</td>
<td>comma separated list of column names for which bloom filter should be created</td>
</tr>
<tr>
<td>orc.bloom.filter.fpp</td>
<td>0.05</td>
<td>false positive probability for bloom filter (must &gt;0.0 and &lt;1.0)</td>
</tr>
</tbody></table>
<p>1．创建一个非压缩的的ORC存储方式</p>
<p>​	（1）建表语句</p>
<p><code>create table log_orc_none(track_time string,url string,session_id string,referer string,ip string,end_user_id string,city_id string)row format delimited fields terminated by &#39;\t&#39;stored as orc tblproperties (&quot;orc.compress&quot;=&quot;NONE&quot;);</code></p>
<p>​	（2）插入数据</p>
<p><code>hive (default)&gt; insert into table log_orc_none select * from log_text ;</code></p>
<p>​	（3）查看插入后数据</p>
<p><code>hive (default)&gt; dfs -du -h /user/hive/warehouse/log_orc_none/ ;</code></p>
<p>7.7 M  &#x2F;user&#x2F;hive&#x2F;warehouse&#x2F;log_orc_none&#x2F;000000_0</p>
<p>2．创建一个SNAPPY压缩的ORC存储方式</p>
<p>​	（1）建表语句</p>
<p><code>create table log_orc_snappy(track_time string,url string,session_id string,referer string,ip string,end_user_id string,city_id string)row format delimited fields terminated by &#39;\t&#39;stored as orc tblproperties (&quot;orc.compress&quot;=&quot;SNAPPY&quot;);</code></p>
<p>​	（2）插入数据</p>
<p><code>hive (default)&gt; insert into table log_orc_snappy select * from log_text ;</code></p>
<p>​	（3）查看插入后数据</p>
<p><code>hive (default)&gt; dfs -du -h /user/hive/warehouse/log_orc_snappy/ ;</code></p>
<p>3.8 M  &#x2F;user&#x2F;hive&#x2F;warehouse&#x2F;log_orc_snappy&#x2F;000000_0</p>
<p>3．上一节中默认创建的ORC存储方式，导入数据后的大小为</p>
<p>2.8 M &#x2F;user&#x2F;hive&#x2F;warehouse&#x2F;log_orc&#x2F;000000_0</p>
<p>比Snappy压缩的还小。原因是orc存储文件默认采用ZLIB压缩。比snappy压缩的小。</p>
<p>4．存储方式和压缩总结</p>
<p>在实际的项目开发当中，hive表的数据存储格式一般选择：orc或parquet。压缩方式一般选择snappy，lzo。</p>
<h1 id="第9章-企业级调优"><a href="#第9章-企业级调优" class="headerlink" title="第9章 企业级调优"></a><strong>第9章</strong> <strong>企业级调优</strong></h1><h2 id="9-1-Fetch抓取"><a href="#9-1-Fetch抓取" class="headerlink" title="9.1 Fetch抓取"></a><strong>9.1 Fetch抓取</strong></h2><p>Fetch抓取是指，Hive中对某些情况的查询可以不必使用MapReduce计算。例如：SELECT * FROM employees;&#96;&#96;&#96;在这种情况下，Hive可以简单地读取employee对应的存储目录下的文件，然后输出查询结果到控制台。</p>
<p>在hive-default.xml.template文件中hive.fetch.task.conversion默认是more，老版本hive默认是minimal，该属性修改为more以后，在全局查找、字段查找、limit查找等都不走mapreduce。</p>
<p><property>  <name>hive.fetch.task.conversion</name>  <value>more</value>  <description>   Expects one of [none, minimal, more].   Some select queries can be converted to single FETCH task minimizing latency.   Currently the query should be single sourced not having any subquery and should not have   any aggregations or distincts (which incurs RS), lateral views and joins.   0. none : disable hive.fetch.task.conversion   1. minimal : SELECT STAR, FILTER on partition columns, LIMIT only   2. more  : SELECT, FILTER, LIMIT only (support TABLESAMPLE and virtual columns)  </description> </property></p>
<p>案例实操：</p>
<p>​	1）把hive.fetch.task.conversion设置成none，然后执行查询语句，都会执行mapreduce程序。</p>
<p><code>hive (default)&gt; set hive.fetch.task.conversion=none;</code></p>
<p><code>hive (default)&gt; select * from emp;</code></p>
<p><code>hive (default)&gt; select ename from emp;</code></p>
<p><code>hive (default)&gt; select ename from emp limit 3;</code></p>
<p>​	2）把hive.fetch.task.conversion设置成more，然后执行查询语句，如下查询方式都不会执行mapreduce程序。</p>
<p><code>hive (default)&gt; set hive.fetch.task.conversion=more;</code></p>
<p><code>hive (default)&gt; select * from emp;</code></p>
<p><code>hive (default)&gt; select ename from emp;</code></p>
<p><code>hive (default)&gt; select ename from emp limit 3;</code></p>
<h2 id="9-2-本地模式"><a href="#9-2-本地模式" class="headerlink" title="9.2 本地模式"></a><strong>9.2 本地模式</strong></h2><p>大多数的Hadoop Job是需要Hadoop提供的完整的可扩展性来处理大数据集的。不过，有时Hive的输入数据量是非常小的。在这种情况下，为查询触发执行任务消耗的时间可能会比实际job的执行时间要多的多。对于大多数这种情况，Hive可以通过本地模式在单台机器上处理所有的任务。对于小数据集，执行时间可以明显被缩短。</p>
<p>用户可以通过设置hive.exec.mode.local.auto的值为true，来让Hive在适当的时候自动启动这个优化。</p>
<p>set hive.exec.mode.local.auto&#x3D;true;<code> //开启本地mr//设置local mr的最大输入数据量，当输入数据量小于这个值时采用local mr的方式，默认为134217728，即128Mset hive.exec.mode.local.auto.inputbytes.max=50000000;</code>&#x2F;&#x2F;设置local mr的最大输入文件个数，当输入文件个数小于这个值时采用local mr的方式，默认为4set hive.exec.mode.local.auto.input.files.max&#x3D;10;&#96;&#96;&#96;</p>
<p>案例实操：</p>
<p>1）开启本地模式，并执行查询语句</p>
<p><code>hive (default)&gt; set hive.exec.mode.local.auto=true;</code> </p>
<p><code>hive (default)&gt; select * from emp cluster by deptno;</code></p>
<p>Time taken: 1.328 seconds, Fetched: 14 row(s)</p>
<p>2）关闭本地模式，并执行查询语句</p>
<p><code>hive (default)&gt; set hive.exec.mode.local.auto=false;</code> </p>
<p><code>hive (default)&gt; select * from emp cluster by deptno;</code></p>
<p>Time taken: 20.09 seconds, Fetched: 14 row(s)</p>
<h2 id="9-3-表的优化"><a href="#9-3-表的优化" class="headerlink" title="9.3 表的优化"></a><strong>9.3 表的优化</strong></h2><h3 id="9-3-1-小表、大表Join"><a href="#9-3-1-小表、大表Join" class="headerlink" title="9.3.1 小表、大表Join"></a><strong>9.3.1 小表、大表Join</strong></h3><p>将key相对分散，并且数据量小的表放在join的左边，这样可以有效减少内存溢出错误发生的几率；再进一步，可以使用map join让小的维度表（1000条以下的记录条数）先进内存。在map端完成reduce。</p>
<p>实际测试发现：新版的hive已经对小表JOIN大表和大表JOIN小表进行了优化。小表放在左边和右边已经没有明显区别。</p>
<p><strong>案例实操</strong></p>
<p>需求</p>
<p>测试大表JOIN小表和小表JOIN大表的效率</p>
<p>2．建大表、小表和JOIN后表的语句</p>
<p><code>// 创建大表create table bigtable(id bigint, time bigint, uid string, keyword string, url_rank int, click_num int, click_url string) row format delimited fields terminated by &#39;\t&#39;;</code>&#x2F;&#x2F; 创建小表create table smalltable(id bigint, time bigint, uid string, keyword string, url_rank int, click_num int, click_url string) row format delimited fields terminated by ‘\t’;<code>// 创建join后表的语句create table jointable(id bigint, time bigint, uid string, keyword string, url_rank int, click_num int, click_url string) row format delimited fields terminated by &#39;\t&#39;;</code></p>
<p>3．分别向大表和小表中导入数据</p>
<p><code>hive (default)&gt; load data local inpath &#39;/opt/module/datas/bigtable&#39; into table bigtable;</code></p>
<p><code>hive (default)&gt;load data local inpath &#39;/opt/module/datas/smalltable&#39; into table smalltable;</code></p>
<p>4．关闭mapjoin功能（默认是打开的）</p>
<p><code>set hive.auto.convert.join = false;</code></p>
<p>5．执行小表JOIN大表语句</p>
<p>insert overwrite table jointable</p>
<p>select b.id, b.time, b.uid, b.keyword, b.url_rank, b.click_num, b.click_url</p>
<p>from smalltable s</p>
<p>left join bigtable  b</p>
<p>on b.id &#x3D; s.id;</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Time taken: 35.921 seconds</span><br><span class="line"></span><br><span class="line">No rows affected (44.456 seconds)</span><br><span class="line"></span><br><span class="line">6．执行大表JOIN小表语句</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>insert overwrite table jointable</p>
<p>select b.id, b.time, b.uid, b.keyword, b.url_rank, b.click_num, b.click_url</p>
<p>from bigtable  b</p>
<p>left join smalltable  s</p>
<p>on s.id &#x3D; b.id;</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">Time taken: 34.196 seconds</span><br><span class="line"></span><br><span class="line">No rows affected (26.287 seconds)</span><br><span class="line"></span><br><span class="line">### **9.3.2 大表Join大表**</span><br><span class="line"></span><br><span class="line">1．空KEY过滤</span><br><span class="line"></span><br><span class="line">有时join超时是因为某些key对应的数据太多，而相同key对应的数据都会发送到相同的reducer上，从而导致内存不够。此时我们应该仔细分析这些异常的key，很多情况下，这些key对应的数据是异常数据，我们需要在SQL语句中进行过滤。例如key对应的字段为空，操作如下：</span><br><span class="line"></span><br><span class="line">案例实操</span><br><span class="line"></span><br><span class="line">（1）配置历史服务器</span><br><span class="line"></span><br><span class="line">	配置mapred-site.xml</span><br><span class="line"></span><br><span class="line">​```xml</span><br><span class="line">&lt;property&gt;</span><br><span class="line">    &lt;name&gt;mapreduce.jobhistory.address&lt;/name&gt;</span><br><span class="line">    &lt;value&gt;hadoop01:10020&lt;/value&gt;</span><br><span class="line">&lt;/property&gt;</span><br><span class="line">&lt;property&gt;</span><br><span class="line">    &lt;name&gt;mapreduce.jobhistory.webapp.address&lt;/name&gt;  &lt;value&gt;hadoop01:19888&lt;/value&gt;&lt;/property&gt;</span><br></pre></td></tr></table></figure>



<p>启动历史服务器</p>
<p><code>sbin/mr-jobhistory-daemon.sh start historyserver</code></p>
<p>查看jobhistory</p>
<p><a target="_blank" rel="noopener" href="http://hadoop01:19888/jobhistory">http://hadoop01:19888/jobhistory</a></p>
<p>（2）创建原始数据表、空id表、合并后数据表</p>
<p><code>// 创建原始表create table ori(id bigint, time bigint, uid string, keyword string, url_rank int, click_num int, click_url string) row format delimited fields terminated by &#39;\t&#39;;// 创建空id表create table nullidtable(id bigint, time bigint, uid string, keyword string, url_rank int, click_num int, click_url string) row format delimited fields terminated by &#39;\t&#39;;// 创建join后表的语句create table jointable(id bigint, time bigint, uid string, keyword string, url_rank int, click_num int, click_url string) row format delimited fields terminated by &#39;\t&#39;;</code></p>
<p>（3）分别加载原始数据和空id数据到对应表中</p>
<p><code>hive (default)&gt; load data local inpath &#39;/opt/module/datas/ori&#39; into table ori;</code></p>
<p><code>hive (default)&gt; load data local inpath &#39;/opt/module/datas/nullid&#39; into table nullidtable;</code></p>
<p>（4）测试不过滤空id</p>
<p><code>hive (default)&gt; insert overwrite table jointable </code></p>
<p><code>select n.* from nullidtable n left join ori o on n.id = o.id;</code></p>
<p>Time taken: 42.038 seconds</p>
<p>Time taken: 37.284 seconds</p>
<p>（5）测试过滤空id</p>
<p><code>hive (default)&gt; insert overwrite table jointable </code></p>
<p><code>select n.* from (select * from nullidtable where id is not null ) n  left join ori o on n.id = o.id;</code></p>
<p>Time taken: 31.725 seconds</p>
<p>Time taken: 28.876 seconds</p>
<p>2．空key转换</p>
<p>有时虽然某个key为空对应的数据很多，但是相应的数据不是异常数据，必须要包含在join的结果中，此时我们可以表a中key为空的字段赋一个随机的值，使得数据随机均匀地分不到不同的reducer上。例如：</p>
<p><strong>案例实操：</strong></p>
<p><strong>不随机分布空null值：</strong></p>
<p>（1）设置5个reduce个数</p>
<p><code>set mapreduce.job.reduces = 5;</code></p>
<p>（2）JOIN两张表</p>
<p><code>insert overwrite table jointable</code></p>
<p><code>select n.* from nullidtable n left join ori b on n.id = b.id;</code></p>
<p><strong>结果：<strong><strong>如图6-13所示，</strong></strong>可以看出来，出现了数据倾斜，某些reducer的资源消耗远大于其他reducer。</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="file:////tmp/wps-xiaojia/ksohtml/wpsBWDfjO.jpg" alt="img"> </p>
<p>图6-13 空key转换</p>
<p>随机分布空null值</p>
<p>（1）设置5个reduce个数</p>
<p><code>set mapreduce.job.reduces = 5;</code></p>
<p>（2）JOIN两张表</p>
<p><code>insert overwrite table jointable</code></p>
<p><code>select n.* from nullidtable n full join ori o on </code></p>
<p><code>case when n.id is null then concat(&#39;hive&#39;, rand()) else n.id end = o.id;</code></p>
<p><strong>结果：<strong><strong>如图6-14所示，</strong></strong>可以看出来，消除了数据倾斜，负载均衡reducer的资源消耗</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="file:////tmp/wps-xiaojia/ksohtml/wpsHRIGOh.jpg" alt="img"> </p>
<p>图6-14 随机分布空值</p>
<h3 id="9-3-3-MapJoin"><a href="#9-3-3-MapJoin" class="headerlink" title="9.3.3 MapJoin"></a><strong>9.3.3 MapJoin</strong></h3><p>如果不指定MapJoin或者不符合MapJoin的条件，那么Hive解析器会将Join操作转换成Common Join，即：在Reduce阶段完成join。容易发生数据倾斜。可以用MapJoin把小表全部加载到内存在map端进行join，避免reducer处理。</p>
<p>1．开启MapJoin参数设置</p>
<p>（1）设置自动选择Mapjoin</p>
<figure class="highlight plaintext"><figcaption><span>hive.auto.convert.join </span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">（2）大表小表的阈值设置（默认25M一下认为是小表）：</span><br><span class="line"></span><br><span class="line">```set hive.mapjoin.smalltable.filesize=25000000;```</span><br><span class="line"></span><br><span class="line">2．MapJoin工作机制，如图6-15所示</span><br><span class="line"></span><br><span class="line">![img](file:////tmp/wps-xiaojia/ksohtml/wpsp4dckL.png)图6-15 MapJoin工作机制</span><br><span class="line"></span><br><span class="line">**案例实操：** </span><br><span class="line"></span><br><span class="line">（1）开启Mapjoin功能</span><br><span class="line"></span><br><span class="line">```set hive.auto.convert.join = true;``` 默认为true</span><br><span class="line"></span><br><span class="line">（2）执行小表JOIN大表语句</span><br><span class="line"></span><br><span class="line">```insert overwrite table jointableselect b.id, b.time, b.uid, b.keyword, b.url_rank, b.click_num, b.click_urlfrom smalltable sjoin bigtable  bon s.id = b.id;```</span><br><span class="line"></span><br><span class="line">Time taken: 24.594 seconds</span><br><span class="line"></span><br><span class="line">（3）执行大表JOIN小表语句</span><br><span class="line"></span><br><span class="line">```insert overwrite table jointableselect b.id, b.time, b.uid, b.keyword, b.url_rank, b.click_num, b.click_urlfrom bigtable  bjoin smalltable  son s.id = b.id;```</span><br><span class="line"></span><br><span class="line">Time taken: 24.315 seconds</span><br><span class="line"></span><br><span class="line">### **9.3.4 Group By**</span><br><span class="line"></span><br><span class="line">默认情况下，Map阶段同一Key数据分发给一个reduce，当一个key数据过大时就倾斜了。</span><br><span class="line"></span><br><span class="line">  并不是所有的聚合操作都需要在Reduce端完成，很多聚合操作都可以先在Map端进行部分聚合，最后在Reduce端得出最终结果。</span><br><span class="line"></span><br><span class="line">1．开启Map端聚合参数设置</span><br><span class="line"></span><br><span class="line">	（1）是否在Map端进行聚合，默认为True</span><br><span class="line"></span><br><span class="line">```hive.map.aggr = true```</span><br><span class="line"></span><br><span class="line">（2）在Map端进行聚合操作的条目数目</span><br><span class="line"></span><br><span class="line">```hive.groupby.mapaggr.checkinterval = 100000```</span><br><span class="line"></span><br><span class="line">（3）有数据倾斜的时候进行负载均衡（默认是false）</span><br><span class="line"></span><br><span class="line">```hive.groupby.skewindata = true```</span><br><span class="line"></span><br><span class="line">  当选项设定为 true，生成的查询计划会有两个MR Job。第一个MR Job中，Map的输出结果会随机分布到Reduce中，每个Reduce做部分聚合操作，并输出结果，这样处理的结果是相同的Group By Key有可能被分发到不同的Reduce中，从而达到负载均衡的目的；第二个MR Job再根据预处理的数据结果按照Group By Key分布到Reduce中（这个过程可以保证相同的Group By Key被分布到同一个Reduce中），最后完成最终的聚合操作。</span><br><span class="line"></span><br><span class="line">### **9.3.5 Count(Distinct) 去重统计**</span><br><span class="line"></span><br><span class="line">数据量小的时候无所谓，数据量大的情况下，由于COUNT DISTINCT操作需要用一个Reduce Task来完成，这一个Reduce需要处理的数据量太大，就会导致整个Job很难完成，一般COUNT DISTINCT使用先GROUP BY再COUNT的方式替换：</span><br><span class="line"></span><br><span class="line">**案例实操**</span><br><span class="line"></span><br><span class="line">1． 创建一张大表</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>hive (default)&gt; create table bigtable(id bigint, time bigint, uid string, keyword</p>
<p>string, url_rank int, click_num int, click_url string) row format delimited</p>
<p>fields terminated by ‘\t’;</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">2．加载数据</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>hive (default)&gt; load data local inpath ‘&#x2F;opt&#x2F;module&#x2F;datas&#x2F;bigtable’ into table bigtable;</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">3．设置5个reduce个数</span><br><span class="line"></span><br><span class="line">```set mapreduce.job.reduces = 5;```</span><br><span class="line"></span><br><span class="line">4．执行去重id查询</span><br><span class="line"></span><br><span class="line">```hive (default)&gt; select count(distinct id) from bigtable;```</span><br><span class="line"></span><br><span class="line">Stage-Stage-1: Map: 1  Reduce: 1  Cumulative CPU: 7.12 sec  HDFS Read: 120741990 HDFS Write: 7 SUCCESS</span><br><span class="line"></span><br><span class="line">Total MapReduce CPU Time Spent: 7 seconds 120 msec</span><br><span class="line"></span><br><span class="line">OK</span><br><span class="line"></span><br><span class="line">c0</span><br><span class="line"></span><br><span class="line">100001</span><br><span class="line"></span><br><span class="line">Time taken: 23.607 seconds, Fetched: 1 row(s)</span><br><span class="line"></span><br><span class="line">5．采用GROUP by去重id</span><br><span class="line"></span><br><span class="line">```hive (default)&gt; select count(id) from (select id from bigtable group by id) a;```</span><br><span class="line"></span><br><span class="line">Stage-Stage-1: Map: 1  Reduce: 5  Cumulative CPU: 17.53 sec  HDFS Read: 120752703 HDFS Write: 580 SUCCESS</span><br><span class="line"></span><br><span class="line">Stage-Stage-2: Map: 1  Reduce: 1  Cumulative CPU: 4.29 sec  HDFS Read: 9409 HDFS Write: 7 SUCCESS</span><br><span class="line"></span><br><span class="line">Total MapReduce CPU Time Spent: 21 seconds 820 msec</span><br><span class="line"></span><br><span class="line">OK</span><br><span class="line"></span><br><span class="line">_c0</span><br><span class="line"></span><br><span class="line">100001</span><br><span class="line"></span><br><span class="line">Time taken: 50.795 seconds, Fetched: 1 row(s)</span><br><span class="line"></span><br><span class="line">虽然会多用一个Job来完成，但在数据量大的情况下，这个绝对是值得的。</span><br><span class="line"></span><br><span class="line">### **9.3.6 笛卡尔积**</span><br><span class="line"></span><br><span class="line">尽量避免笛卡尔积，join的时候不加on条件，或者无效的on条件，Hive只能使用1个reducer来完成笛卡尔积。</span><br><span class="line"></span><br><span class="line">### **9.3.7 行列过滤**</span><br><span class="line"></span><br><span class="line">列处理：在SELECT中，只拿需要的列，如果有，尽量使用分区过滤，少用SELECT *。</span><br><span class="line"></span><br><span class="line">行处理：在分区剪裁中，当使用外关联时，如果将副表的过滤条件写在Where后面，那么就会先全表关联，之后再过滤，比如：</span><br><span class="line"></span><br><span class="line">**案例实操：**</span><br><span class="line"></span><br><span class="line">1．测试先关联两张表，再用where条件过滤</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>hive (default)&gt; select o.id from bigtable b join ori o on o.id &#x3D; b.id where o.id &lt;&#x3D; 10;</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Time taken: 34.406 seconds, Fetched: 100 row(s)</span><br><span class="line"></span><br><span class="line">2．通过子查询后，再关联表</span><br><span class="line"></span><br><span class="line">```hive (default)&gt; select b.id from bigtable b join (select id from ori where id &lt;= 10 ) o on b.id = o.id;```</span><br><span class="line"></span><br><span class="line">Time taken: 30.058 seconds, Fetched: 100 row(s)</span><br><span class="line"></span><br><span class="line">### **9.3.8 动态分区调整**</span><br><span class="line"></span><br><span class="line">关系型数据库中，对分区表Insert数据时候，数据库自动会根据分区字段的值，将数据插入到相应的分区中，Hive中也提供了类似的机制，即动态分区(Dynamic Partition)，只不过，使用Hive的动态分区，需要进行相应的配置。</span><br><span class="line"></span><br><span class="line">1．开启动态分区参数设置</span><br><span class="line"></span><br><span class="line">（1）开启动态分区功能（默认true，开启）</span><br><span class="line"></span><br><span class="line">```hive.exec.dynamic.partition=true```</span><br><span class="line"></span><br><span class="line">（2）设置为非严格模式（动态分区的模式，默认strict，表示必须指定至少一个分区为静态分区，nonstrict模式表示允许所有的分区字段都可以使用动态分区。）</span><br><span class="line"></span><br><span class="line">```hive.exec.dynamic.partition.mode=nonstrict```</span><br><span class="line"></span><br><span class="line">（3）在所有执行MR的节点上，最大一共可以创建多少个动态分区。</span><br><span class="line"></span><br><span class="line">```hive.exec.max.dynamic.partitions=1000```</span><br><span class="line"></span><br><span class="line">	（4）在每个执行MR的节点上，最大可以创建多少个动态分区。该参数需要根据实际的数据来设定。比如：源数据中包含了一年的数据，即day字段有365个值，那么该参数就需要设置成大于365，如果使用默认值100，则会报错。</span><br><span class="line"></span><br><span class="line">```hive.exec.max.dynamic.partitions.pernode=100```</span><br><span class="line"></span><br><span class="line">（5）整个MR Job中，最大可以创建多少个HDFS文件。</span><br><span class="line"></span><br><span class="line">```hive.exec.max.created.files=100000```</span><br><span class="line"></span><br><span class="line">（6）当有空分区生成时，是否抛出异常。一般不需要设置。</span><br><span class="line"></span><br><span class="line">```hive.error.on.empty.partition=false```</span><br><span class="line"></span><br><span class="line">2．案例实操</span><br><span class="line"></span><br><span class="line">需求：将ori中的数据按照时间(如：20111230000008)，插入到目标表ori_partitioned_target的相应分区中。</span><br><span class="line"></span><br><span class="line">（1）创建分区表</span><br><span class="line"></span><br><span class="line">```create table ori_partitioned(id bigint, time bigint, uid string, keyword string, url_rank int, click_num int, click_url string) partitioned by (p_time bigint) row format delimited fields terminated by &#x27;\t&#x27;;```</span><br><span class="line"></span><br><span class="line">（2）加载数据到分区表中</span><br><span class="line"></span><br><span class="line">```hive (default)&gt; load data local inpath &#x27;/home/xiaojia/ds1&#x27; into table ori_partitioned partition(p_time=&#x27;20111230000010&#x27;) ;```hive (default)&gt; load data local inpath &#x27;/home/xiaojia/ds2&#x27; into table ori_partitioned partition(p_time=&#x27;20111230000011&#x27;) ;```</span><br><span class="line"></span><br><span class="line">（3）创建目标分区表</span><br><span class="line"></span><br><span class="line">```create table ori_partitioned_target(id bigint, time bigint, uid string, keyword string, url_rank int, click_num int, click_url string) PARTITIONED BY (p_time STRING) row format delimited fields terminated by &#x27;\t&#x27;;```</span><br><span class="line"></span><br><span class="line">（4）设置动态分区</span><br><span class="line"></span><br><span class="line">```set hive.exec.dynamic.partition = true;```</span><br><span class="line"></span><br><span class="line">```set hive.exec.dynamic.partition.mode = nonstrict;```</span><br><span class="line"></span><br><span class="line">```set hive.exec.max.dynamic.partitions = 1000;```</span><br><span class="line"></span><br><span class="line">```set hive.exec.max.dynamic.partitions.pernode = 100;```</span><br><span class="line"></span><br><span class="line">```set hive.exec.max.created.files = 100000;```</span><br><span class="line"></span><br><span class="line">```set hive.error.on.empty.partition = false;hive (default)&gt; insert overwrite table ori_partitioned_target partition (p_time) select id, time, uid, keyword, url_rank, click_num, click_url, p_time from ori_partitioned;```</span><br><span class="line"></span><br><span class="line">（5）查看目标分区表的分区情况</span><br><span class="line"></span><br><span class="line">```hive (default)&gt; show partitions ori_partitioned_target;```</span><br><span class="line"></span><br><span class="line">### **9.3.9 分桶**</span><br><span class="line"></span><br><span class="line">详见6.6章。</span><br><span class="line"></span><br><span class="line">### **9.3.10 分区**</span><br><span class="line"></span><br><span class="line">详见4.6章。</span><br><span class="line"></span><br><span class="line">## **9.4 数据倾斜**</span><br><span class="line"></span><br><span class="line">### **9.4.1 合理设置Map数**</span><br><span class="line"></span><br><span class="line">**1）通常情况下，作业会通过input的目录产生一个或者多个map任务。**</span><br><span class="line"></span><br><span class="line">主要的决定因素有：input的文件总个数，input的文件大小，集群设置的文件块大小。</span><br><span class="line"></span><br><span class="line">**2）是不是map数越多越好？**</span><br><span class="line"></span><br><span class="line">答案是否定的。如果一个任务有很多小文件（远远小于块大小128m），则每个小文件也会被当做一个块，用一个map任务来完成，而一个map任务启动和初始化的时间远远大于逻辑处理的时间，就会造成很大的资源浪费。而且，同时可执行的map数是受限的。</span><br><span class="line"></span><br><span class="line">**3）是不是保证每个map处理接近128m的文件块，就高枕无忧了？**</span><br><span class="line"></span><br><span class="line">答案也是不一定。比如有一个127m的文件，正常会用一个map去完成，但这个文件只有一个或者两个小字段，却有几千万的记录，如果map处理的逻辑比较复杂，用一个map任务去做，肯定也比较耗时。</span><br><span class="line"></span><br><span class="line">针对上面的问题2和3，我们需要采取两种方式来解决：即减少map数和增加map数；</span><br><span class="line"></span><br><span class="line">### **9.4.2 小文件进行合并**</span><br><span class="line"></span><br><span class="line">在map执行前合并小文件，减少map数：CombineHiveInputFormat具有对小文件进行合并的功能（系统默认的格式）。HiveInputFormat没有对小文件合并功能。</span><br><span class="line"></span><br><span class="line">set hive.input.format= org.apache.hadoop.hive.ql.io.CombineHiveInputFormat;```</span><br><span class="line"></span><br><span class="line">### **9.4.3 复杂文件增加Map数**</span><br><span class="line"></span><br><span class="line">当input的文件都很大，任务逻辑复杂，map执行非常慢的时候，可以考虑增加Map数，来使得每个map处理的数据量减少，从而提高任务的执行效率。</span><br><span class="line"></span><br><span class="line">增加map的方法为：根据computeSliteSize(Math.max(minSize,Math.min(maxSize,blocksize)))=blocksize=128M公式，调整maxSize最大值。让maxSize最大值低于blocksize就可以增加map的个数。</span><br><span class="line"></span><br><span class="line">**案例实操：**</span><br><span class="line"></span><br><span class="line">1．执行查询</span><br><span class="line"></span><br><span class="line">```hive (default)&gt; select count(*) from emp;```</span><br><span class="line"></span><br><span class="line">Hadoop job information for Stage-1: number of mappers: 1; number of reducers: 1</span><br><span class="line"></span><br><span class="line">2．设置最大切片值为100个字节</span><br><span class="line"></span><br><span class="line">```hive (default)&gt; set mapreduce.input.fileinputformat.split.maxsize=100;```</span><br><span class="line"></span><br><span class="line">```hive (default)&gt; select count(*) from emp;```</span><br><span class="line"></span><br><span class="line">Hadoop job information for Stage-1: number of mappers: 6;``` number of reducers: 1</span><br><span class="line"></span><br><span class="line">### **9.4.4 合理设置Reduce数**</span><br><span class="line"></span><br><span class="line">1．调整reduce个数方法一</span><br><span class="line"></span><br><span class="line">（1）每个Reduce处理的数据量默认是256MB</span><br><span class="line"></span><br><span class="line">```hive.exec.reducers.bytes.per.reducer=256000000```</span><br><span class="line"></span><br><span class="line">（2）每个任务最大的reduce数，默认为1009</span><br><span class="line"></span><br><span class="line">```hive.exec.reducers.max=1009```</span><br><span class="line"></span><br><span class="line">（3）计算reducer数的公式</span><br><span class="line"></span><br><span class="line">N=min(参数2，总输入数据量/参数1)</span><br><span class="line"></span><br><span class="line">2．调整reduce个数方法二</span><br><span class="line"></span><br><span class="line">在hadoop的mapred-default.xml文件中修改</span><br><span class="line"></span><br><span class="line">设置每个job的Reduce个数</span><br><span class="line"></span><br><span class="line">```set mapreduce.job.reduces = 15;```</span><br><span class="line"></span><br><span class="line">3．reduce个数并不是越多越好</span><br><span class="line"></span><br><span class="line">1）过多的启动和初始化reduce也会消耗时间和资源；</span><br><span class="line"></span><br><span class="line">2）另外，有多少个reduce，就会有多少个输出文件，如果生成了很多个小文件，那么如果这些小文件作为下一个任务的输入，则也会出现小文件过多的问题；</span><br><span class="line"></span><br><span class="line">在设置reduce个数的时候也需要考虑这两个原则：处理大数据量利用合适的reduce数；使单个reduce任务处理数据量大小要合适；</span><br><span class="line"></span><br><span class="line">## **9.5 并行执行**</span><br><span class="line"></span><br><span class="line">Hive会将一个查询转化成一个或者多个阶段。这样的阶段可以是MapReduce阶段、抽样阶段、合并阶段、limit阶段。或者Hive执行过程中可能需要的其他阶段。默认情况下，Hive一次只会执行一个阶段。不过，某个特定的job可能包含众多的阶段，而这些阶段可能并非完全互相依赖的，也就是说有些阶段是可以并行执行的，这样可能使得整个job的执行时间缩短。不过，如果有更多的阶段可以并行执行，那么job可能就越快完成。</span><br><span class="line"></span><br><span class="line">	通过设置参数hive.exec.parallel值为true，就可以开启并发执行。不过，在共享集群中，需要注意下，如果job中并行阶段增多，那么集群利用率就会增加。</span><br><span class="line"></span><br><span class="line">set hive.exec.parallel=true;```        //打开任务并行执行</span><br><span class="line"></span><br><span class="line">set hive.exec.parallel.thread.number=16;```  //同一个sql允许最大并行度，默认为8。</span><br><span class="line"></span><br><span class="line">当然，得是在系统资源比较空闲的时候才有优势，否则，没资源，并行也起不来。</span><br><span class="line"></span><br><span class="line">## **9.6 严格模式**</span><br><span class="line"></span><br><span class="line">Hive提供了一个严格模式，可以防止用户执行那些可能意想不到的不好的影响的查询。</span><br><span class="line"></span><br><span class="line">	通过设置属性hive.mapred.mode值为默认是非严格模式nonstrict 。开启严格模式需要修改hive.mapred.mode值为strict，开启严格模式可以禁止3种类型的查询。</span><br><span class="line"></span><br><span class="line">```xml</span><br><span class="line">&lt;property&gt;</span><br><span class="line"></span><br><span class="line">  &lt;name&gt;hive.mapred.mode&lt;/name&gt;</span><br><span class="line"></span><br><span class="line">  &lt;value&gt;strict&lt;/value&gt;</span><br><span class="line"></span><br><span class="line">  &lt;description&gt;</span><br><span class="line"></span><br><span class="line">   The mode in which the Hive operations are being performed. </span><br><span class="line"></span><br><span class="line">   In strict mode, some risky queries are not allowed to run. They include:</span><br><span class="line"></span><br><span class="line">    Cartesian Product.</span><br><span class="line"></span><br><span class="line">    No partition being picked up for a query.</span><br><span class="line"></span><br><span class="line">    Comparing bigints and strings.</span><br><span class="line"></span><br><span class="line">    Comparing bigints and doubles.</span><br><span class="line"></span><br><span class="line">    Orderby without limit.</span><br><span class="line"></span><br><span class="line">&lt;/description&gt;</span><br><span class="line"></span><br><span class="line">&lt;/property&gt;</span><br></pre></td></tr></table></figure>





<ol>
<li><p>对于分区表，除非where语句中含有分区字段过滤条件来限制范围，否则不允许执行。换句话说，就是用户不允许扫描所有分区。进行这个限制的原因是，通常分区表都拥有非常大的数据集，而且数据增加迅速。没有进行分区限制的查询可能会消耗令人不可接受的巨大资源来处理这个表。</p>
</li>
<li><p>对于使用了order by语句的查询，要求必须使用limit语句。因为order by为了执行排序过程会将所有的结果数据分发到同一个Reducer中进行处理，强制要求用户增加这个LIMIT语句可以防止Reducer额外执行很长一段时间。</p>
</li>
<li><p>限制笛卡尔积的查询。对关系型数据库非常了解的用户可能期望在执行JOIN查询的时候不使用ON语句而是使用where语句，这样关系数据库的执行优化器就可以高效地将WHERE语句转化成那个ON语句。不幸的是，Hive并不会执行这种优化，因此，如果表足够大，那么这个查询就会出现不可控的情况。</p>
</li>
</ol>
<h2 id="9-7-JVM重用"><a href="#9-7-JVM重用" class="headerlink" title="9.7 JVM重用"></a><strong>9.7 JVM重用</strong></h2><p>JVM重用是Hadoop调优参数的内容，其对Hive的性能具有非常大的影响，特别是对于很难避免小文件的场景或task特别多的场景，这类场景大多数执行时间都很短。</p>
<p>Hadoop的默认配置通常是使用派生JVM来执行map和Reduce任务的。这时JVM的启动过程可能会造成相当大的开销，尤其是执行的job包含有成百上千task任务的情况。JVM重用可以使得JVM实例在同一个job中重新使用N次。N的值可以在Hadoop的mapred-site.xml文件中进行配置。通常在10-20之间，具体多少需要根据具体业务场景测试得出。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line"></span><br><span class="line"> <span class="tag">&lt;<span class="name">name</span>&gt;</span>mapreduce.job.jvm.numtasks<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line"></span><br><span class="line"> <span class="tag">&lt;<span class="name">value</span>&gt;</span>10<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"></span><br><span class="line"> <span class="tag">&lt;<span class="name">description</span>&gt;</span>How many tasks to run per jvm. If set to -1, there is</span><br><span class="line"></span><br><span class="line"> no limit. </span><br><span class="line"></span><br><span class="line"> <span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br></pre></td></tr></table></figure>





<p>这个功能的缺点是，开启JVM重用将一直占用使用到的task插槽，以便进行重用，直到任务完成后才能释放。如果某个“不平衡的”job中有某几个reduce task执行的时间要比其他Reduce task消耗的时间多的多的话，那么保留的插槽就会一直空闲着却无法被其他的job使用，直到所有的task都结束了才会释放。</p>
<h2 id="9-8-推测执行"><a href="#9-8-推测执行" class="headerlink" title="9.8 推测执行"></a><strong>9.8 推测执行</strong></h2><p>在分布式集群环境下，因为程序Bug（包括Hadoop本身的bug），负载不均衡或者资源分布不均等原因，会造成同一个作业的多个任务之间运行速度不一致，有些任务的运行速度可能明显慢于其他任务（比如一个作业的某个任务进度只有50%，而其他所有任务已经运行完毕），则这些任务会拖慢作业的整体执行进度。为了避免这种情况发生，Hadoop采用了推测执行（Speculative Execution）机制，它根据一定的法则推测出“拖后腿”的任务，并为这样的任务启动一个备份任务，让该任务与原始任务同时处理同一份数据，并最终选用最先成功运行完成任务的计算结果作为最终结果。</p>
<p>设置开启推测执行参数：Hadoop的mapred-site.xml文件中进行配置</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>mapreduce.map.speculative<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>true<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>If true, then multiple instances of some map tasks         may be executed in parallel.<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>mapreduce.reduce.speculative<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>true<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>If true, then multiple instances of some reduce tasks         may be executed in parallel.<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br></pre></td></tr></table></figure>





<p>不过hive本身也提供了配置项来控制reduce-side的推测执行：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>hive.mapred.reduce.tasks.speculative.execution<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>true<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>Whether speculative execution for reducers should be turned on. <span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br></pre></td></tr></table></figure>



<p>关于调优这些推测执行变量，还很难给一个具体的建议。如果用户对于运行时的偏差非常敏感的话，那么可以将这些功能关闭掉。如果用户因为输入数据量很大而需要执行长时间的map或者Reduce task的话，那么启动推测执行造成的浪费是非常巨大大。</p>
<h2 id="9-9-压缩"><a href="#9-9-压缩" class="headerlink" title="9.9 压缩"></a><strong>9.9 压缩</strong></h2><p>详见第8章。</p>
<h2 id="9-10-执行计划（Explain）"><a href="#9-10-执行计划（Explain）" class="headerlink" title="9.10 执行计划（Explain）"></a><strong>9.10 执行计划（Explain）</strong></h2><p>1．基本语法</p>
<p><code>EXPLAIN [EXTENDED | DEPENDENCY | AUTHORIZATION] query</code></p>
<p>2．案例实操</p>
<p>（1）查看下面这条语句的执行计划</p>
<p><code>hive (default)&gt; explain select * from emp;</code></p>
<p><code>hive (default)&gt; explain select deptno, avg(sal) avg_sal from emp group by deptno;</code></p>
<p>（2）查看详细执行计划</p>
<p><code>hive (default)&gt; explain extended select * from emp;</code></p>
<p><code>hive (default)&gt; explain extended select deptno, avg(sal) avg_sal from emp group by deptno;</code></p>
<h1 id="第10章-Hive实战之谷粒影音"><a href="#第10章-Hive实战之谷粒影音" class="headerlink" title="第10章 Hive实战之谷粒影音"></a><strong>第10章</strong> <strong>Hive实战之谷粒影音</strong></h1><h2 id="10-1-需求描述"><a href="#10-1-需求描述" class="headerlink" title="10.1 需求描述"></a><strong>10.1 需求描述</strong></h2><p>统计硅谷影音视频网站的常规指标，各种TopN指标：</p>
<p>–统计视频观看数Top10</p>
<p>–统计视频类别热度Top10</p>
<p>–统计视频观看数Top20所属类别</p>
<p>–统计视频观看数Top50所关联视频的所属类别Rank</p>
<p>–统计每个类别中的视频热度Top10</p>
<p>–统计每个类别中视频流量Top10</p>
<p>–统计上传视频最多的用户Top10以及他们上传的视频</p>
<p>–统计每个类别视频观看数Top10</p>
<h2 id="10-2-项目"><a href="#10-2-项目" class="headerlink" title="10.2 项目"></a><strong>10.2 项目</strong></h2><h3 id="10-2-1-数据结构"><a href="#10-2-1-数据结构" class="headerlink" title="10.2.1 数据结构"></a><strong>10.2.1 数据结构</strong></h3><p>1．视频表</p>
<p>表6-13 视频表</p>
<table>
<thead>
<tr>
<th>字段</th>
<th>备注</th>
<th>详细描述</th>
</tr>
</thead>
<tbody><tr>
<td>video id</td>
<td>视频唯一id</td>
<td>11位字符串</td>
</tr>
<tr>
<td>uploader</td>
<td>视频上传者</td>
<td>上传视频的用户名String</td>
</tr>
<tr>
<td>age</td>
<td>视频年龄</td>
<td>视频在平台上的整数天</td>
</tr>
<tr>
<td>category</td>
<td>视频类别</td>
<td>上传视频指定的视频分类</td>
</tr>
<tr>
<td>length</td>
<td>视频长度</td>
<td>整形数字标识的视频长度</td>
</tr>
<tr>
<td>views</td>
<td>观看次数</td>
<td>视频被浏览的次数</td>
</tr>
<tr>
<td>rate</td>
<td>视频评分</td>
<td>满分5分</td>
</tr>
<tr>
<td>ratings</td>
<td>流量</td>
<td>视频的流量，整型数字</td>
</tr>
<tr>
<td>conments</td>
<td>评论数</td>
<td>一个视频的整数评论数</td>
</tr>
<tr>
<td>related ids</td>
<td>相关视频id</td>
<td>相关视频的id，最多20个</td>
</tr>
</tbody></table>
<p>2．用户表</p>
<p>表6-14 用户表</p>
<table>
<thead>
<tr>
<th>字段</th>
<th>备注</th>
<th>字段类型</th>
</tr>
</thead>
<tbody><tr>
<td>uploader</td>
<td>上传者用户名</td>
<td>string</td>
</tr>
<tr>
<td>videos</td>
<td>上传视频数</td>
<td>int</td>
</tr>
<tr>
<td>friends</td>
<td>朋友数量</td>
<td>int</td>
</tr>
</tbody></table>
<h3 id="10-2-2-ETL原始数据"><a href="#10-2-2-ETL原始数据" class="headerlink" title="10.2.2 ETL原始数据"></a><strong>10.2.2 ETL原始数据</strong></h3><p>通过观察原始数据形式，可以发现，视频可以有多个所属分类，每个所属分类用&amp;符号分割，且分割的两边有空格字符，同时相关视频也是可以有多个元素，多个相关视频又用“\t”进行分割。为了分析数据时方便对存在多个子元素的数据进行操作，我们首先进行数据重组清洗操作。即：将所有的类别用“&amp;”分割，同时去掉两边空格，多个相关视频id也使用“&amp;”进行分割。</p>
<p>1．ETL之ETLUtil</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ETLUtil</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">oriString2ETLString</span><span class="params">(String ori)</span>&#123;</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">etlString</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">        String[] splits = ori.split(<span class="string">&quot;\t&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(splits.length &lt; <span class="number">9</span>) <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        splits[<span class="number">3</span>] = splits[<span class="number">3</span>].replace(<span class="string">&quot; &quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>;``` i &lt; splits.length; i++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(i &lt; <span class="number">9</span>)&#123;</span><br><span class="line">                <span class="keyword">if</span>(i == splits.length - <span class="number">1</span>)&#123;</span><br><span class="line">                    etlString.append(splits[i]);</span><br><span class="line">                &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                    etlString.append(splits[i] + <span class="string">&quot;\t&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="keyword">if</span>(i == splits.length - <span class="number">1</span>)&#123;</span><br><span class="line">                    etlString.append(splits[i]);</span><br><span class="line">                &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                    etlString.append(splits[i] + <span class="string">&quot;&amp;&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> etlString.toString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<p>2．ETL之Mapper</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.lang.StringUtils;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.io.NullWritable;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.io.Text;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.Mapper;</span><br><span class="line"><span class="keyword">import</span> com.xiaojia.util.ETLUtil;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">VideoETLMapper</span> <span class="keyword">extends</span> <span class="title class_">Mapper</span>&lt;Object, Text, NullWritable, Text&gt; &#123;</span><br><span class="line">    <span class="type">Text</span> <span class="variable">text</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Text</span>();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">map</span><span class="params">(Object key, Text value, Context context)</span> <span class="keyword">throws</span> IOException, InterruptedException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">etlString</span> <span class="operator">=</span> ETLUtil.oriString2ETLString(value.toString());</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isBlank(etlString)) <span class="keyword">return</span>;</span><br><span class="line">        text.set(etlString);</span><br><span class="line">        context.write(NullWritable.get(), text);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<p>3．ETL之Runner</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line">import java.io.IOException;</span><br><span class="line"></span><br><span class="line">import org.apache.hadoop.conf.Configuration;</span><br><span class="line">import org.apache.hadoop.fs.FileSystem;</span><br><span class="line">import org.apache.hadoop.fs.Path;</span><br><span class="line">import org.apache.hadoop.io.NullWritable;</span><br><span class="line">import org.apache.hadoop.io.Text;</span><br><span class="line">import org.apache.hadoop.mapreduce.Job;</span><br><span class="line">import org.apache.hadoop.mapreduce.lib.input.FileInputFormat;</span><br><span class="line">import org.apache.hadoop.mapreduce.lib.output.FileOutputFormat;</span><br><span class="line">import org.apache.hadoop.util.Tool;</span><br><span class="line">import org.apache.hadoop.util.ToolRunner;</span><br><span class="line"></span><br><span class="line">public class VideoETLRunner implements Tool &#123;</span><br><span class="line">    private Configuration conf = null;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void setConf(Configuration conf) &#123;</span><br><span class="line">        this.conf = conf;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public Configuration getConf() &#123;</span><br><span class="line">        return this.conf;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public int run(String[] args) throws Exception &#123;</span><br><span class="line">        conf = this.getConf();</span><br><span class="line">        conf.set(&quot;inpath&quot;, args[0]);</span><br><span class="line">        conf.set(&quot;outpath&quot;, args[1]);</span><br><span class="line">        Job job = Job.getInstance(conf);</span><br><span class="line">        job.setJarByClass(VideoETLRunner.class);</span><br><span class="line">        job.setMapperClass(VideoETLMapper.class);</span><br><span class="line">        job.setMapOutputKeyClass(NullWritable.class);</span><br><span class="line">        job.setMapOutputValueClass(Text.class);</span><br><span class="line">        job.setNumReduceTasks(0);</span><br><span class="line">        this.initJobInputPath(job);</span><br><span class="line">        this.initJobOutputPath(job);</span><br><span class="line">        return job.waitForCompletion(true) ? 0 : 1;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private void initJobOutputPath(Job job) throws IOException &#123;</span><br><span class="line">        Configuration conf = job.getConfiguration();</span><br><span class="line">        String outPathString = conf.get(&quot;outpath&quot;);</span><br><span class="line">        FileSystem fs = FileSystem.get(conf);</span><br><span class="line">        Path outPath = new Path(outPathString);</span><br><span class="line">        if (fs.exists(outPath)) &#123;</span><br><span class="line">            fs.delete(outPath, true);</span><br><span class="line">        &#125;</span><br><span class="line">        FileOutputFormat.setOutputPath(job, outPath);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private void initJobInputPath(Job job) throws IOException &#123;</span><br><span class="line">        Configuration conf = job.getConfiguration();</span><br><span class="line">        String inPathString = conf.get(&quot;inpath&quot;);</span><br><span class="line">        FileSystem fs = FileSystem.get(conf);</span><br><span class="line">        Path inPath = new Path(inPathString);</span><br><span class="line">        if (fs.exists(inPath)) &#123;</span><br><span class="line">            FileInputFormat.addInputPath(job, inPath);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            throw new RuntimeException(&quot;HDFS中该文件目录不存在：&quot; + inPathString);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            int resultCode = ToolRunner.run(new VideoETLRunner(), args);</span><br><span class="line">            if (resultCode == 0) &#123;</span><br><span class="line">                System.out.println(&quot;Success!&quot;);</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                System.out.println(&quot;Fail!&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">            System.exit(resultCode);</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            System.exit(1);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>4．执行ETL</p>
<p><code>$ bin/yarn jar ~/softwares/jars/gulivideo-0.0.1-SNAPSHOT.jar \com.xiaojia.etl.ETLVideosRunner \/gulivideo/video/2008/0222 \/gulivideo/output/video/2008/0222</code></p>
<h2 id="10-3-准备工作"><a href="#10-3-准备工作" class="headerlink" title="10.3 准备工作"></a><strong>10.3 准备工作</strong></h2><h3 id="10-3-1-创建表"><a href="#10-3-1-创建表" class="headerlink" title="10.3.1 创建表"></a><strong>10.3.1 创建表</strong></h3><p>创建表：gulivideo_ori，gulivideo_user_ori，</p>
<p>创建表：gulivideo_orc，gulivideo_user_orc</p>
<p>gulivideo_ori：</p>
<p><code>create table gulivideo_ori(  videoId string,   uploader string,   age int,   category array&lt;string&gt;,   length int,   views int,   rate float,   ratings int,   comments int,  relatedId array&lt;string&gt;)row format delimited fields terminated by &quot;\t&quot;collection items terminated by &quot;&amp;&quot;stored as textfile;</code></p>
<p>gulivideo_user_ori：</p>
<p><code>create table gulivideo_user_ori(  uploader string,  videos int,  friends int)row format delimited fields terminated by &quot;\t&quot; stored as textfile;</code></p>
<p>然后把原始数据插入到orc表中</p>
<p>gulivideo_orc：</p>
<p><code>create table gulivideo_orc(  videoId string,   uploader string,   age int,   category array&lt;string&gt;,   length int,   views int,   rate float,   ratings int,   comments int,  relatedId array&lt;string&gt;)clustered by (uploader) into 8 buckets row format delimited fields terminated by &quot;\t&quot; collection items terminated by &quot;&amp;&quot; stored as orc;</code></p>
<p>gulivideo_user_orc：</p>
<p><code>create table gulivideo_user_orc(  uploader string,  videos int,  friends int)row format delimited fields terminated by &quot;\t&quot; stored as orc;</code></p>
<h3 id="10-3-2-导入ETL后的数据"><a href="#10-3-2-导入ETL后的数据" class="headerlink" title="10.3.2 导入ETL后的数据"></a><strong>10.3.2 导入ETL后的数据</strong></h3><p>gulivideo_ori：</p>
<p><code>load data inpath &quot;/gulivideo/output/video/2008/0222&quot; into table gulivideo_ori;</code></p>
<p>gulivideo_user_ori：</p>
<p><code>load data inpath &quot;/gulivideo/user/2008/0903&quot; into table gulivideo_user_ori;</code></p>
<h3 id="10-3-3-向ORC表插入数据"><a href="#10-3-3-向ORC表插入数据" class="headerlink" title="10.3.3 向ORC表插入数据"></a><strong>10.3.3 向ORC表插入数据</strong></h3><p>gulivideo_orc：</p>
<p><code>insert into table gulivideo_orc select * from gulivideo_ori;</code></p>
<p>gulivideo_user_orc：</p>
<p><code>insert into table gulivideo_user_orc select * from gulivideo_user_ori;</code></p>
<h2 id="10-4-业务分析"><a href="#10-4-业务分析" class="headerlink" title="10.4 业务分析"></a><strong>10.4 业务分析</strong></h2><h3 id="10-4-1-统计视频观看数Top10"><a href="#10-4-1-统计视频观看数Top10" class="headerlink" title="10.4.1 统计视频观看数Top10"></a><strong>10.4.1 统计视频观看数Top10</strong></h3><p>思路：使用order by按照views字段做一个全局排序即可，同时我们设置只显示前10条。</p>
<p>最终代码：</p>
<p><code>select   videoId,   uploader,   age,   category,   length,   views,   rate,   ratings,   comments from   gulivideo_orc order by   views desc limit   10;</code></p>
<h3 id="10-4-2-统计视频类别热度Top10"><a href="#10-4-2-统计视频类别热度Top10" class="headerlink" title="10.4.2 统计视频类别热度Top10"></a><strong>10.4.2 统计视频类别热度Top10</strong></h3><p>思路：</p>
<ol>
<li><p>即统计每个类别有多少个视频，显示出包含视频最多的前10个类别。</p>
</li>
<li><p>我们需要按照类别group by聚合，然后count组内的videoId个数即可。</p>
</li>
<li><p>因为当前表结构为：一个视频对应一个或多个类别。所以如果要group by类别，需要先将类别进行列转行(展开)，然后再进行count即可。</p>
</li>
<li><p>最后按照热度排序，显示前10条。</p>
</li>
</ol>
<p>最终代码：</p>
<p><code>select   category_name as category,   count(t1.videoId) as hot from (  select     videoId,    category_name   from     gulivideo_orc lateral view explode(category) t_catetory as category_name) t1 group by   t1.category_name order by   hot desc limit   10;</code></p>
<h3 id="10-4-3-统计出视频观看数最高的20个视频的所属类别以及类别包含Top20视频的个数"><a href="#10-4-3-统计出视频观看数最高的20个视频的所属类别以及类别包含Top20视频的个数" class="headerlink" title="10.4.3 统计出视频观看数最高的20个视频的所属类别以及类别包含Top20视频的个数"></a><strong>10.4.3 统计出视频观看数最高的20个视频的所属类别以及类别包含Top20视频的个数</strong></h3><p>思路：</p>
<ol>
<li><p>先找到观看数最高的20个视频所属条目的所有信息，降序排列</p>
</li>
<li><p>把这20条信息中的category分裂出来(列转行)</p>
</li>
<li><p>最后查询视频分类名称和该分类下有多少个Top20的视频</p>
</li>
</ol>
<p>最终代码：</p>
<p><code>select   category_name as category,   count(t2.videoId) as hot_with_views from (  select     videoId,     category_name   from (    select       *     from       gulivideo_orc     order by       views     desc limit       20) t1 lateral view explode(category) t_catetory as category_name) t2 group by   category_name order by   hot_with_views desc;</code></p>
<h3 id="10-4-4-统计视频观看数Top50所关联视频的所属类别Rank"><a href="#10-4-4-统计视频观看数Top50所关联视频的所属类别Rank" class="headerlink" title="10.4.4 统计视频观看数Top50所关联视频的所属类别Rank"></a><strong>10.4.4 统计视频观看数Top50所关联视频的所属类别Rank</strong></h3><p>思路：</p>
<ol>
<li>查询出观看数最多的前50个视频的所有信息(当然包含了每个视频对应的关联视频)，记为临时表t1</li>
</ol>
<p>t1：观看数前50的视频</p>
<p><code>select   * from   gulivideo_orc order by   views desc limit   50;</code></p>
<ol start="2">
<li>将找到的50条视频信息的相关视频relatedId列转行，记为临时表t2</li>
</ol>
<p>t2：将相关视频的id进行列转行操作</p>
<p><code>select   explode(relatedId) as videoId from 	t1;</code></p>
<ol start="3">
<li>将相关视频的id和gulivideo_orc表进行inner join操作</li>
</ol>
<p>t5：得到两列数据，一列是category，一列是之前查询出来的相关视频id</p>
<p> <code>(select   distinct(t2.videoId),   t3.category from   t2inner join   gulivideo_orc t3 on t2.videoId = t3.videoId) t4 lateral view explode(category) t_catetory as category_name;</code></p>
<ol start="4">
<li>按照视频类别进行分组，统计每组视频个数，然后排行</li>
</ol>
<p>最终代码：</p>
<p><code>select   category_name as category,   count(t5.videoId) as hot from (  select     videoId,     category_name   from (    select       distinct(t2.videoId),       t3.category     from (      select         explode(relatedId) as videoId       from (        select           *         from           gulivideo_orc         order by           views         desc limit           50) t1) t2     inner join       gulivideo_orc t3 on t2.videoId = t3.videoId) t4 lateral view explode(category) t_catetory as category_name) t5group by   category_name order by   hot desc;</code></p>
<h3 id="10-4-5-统计每个类别中的视频热度Top10，以Music为例"><a href="#10-4-5-统计每个类别中的视频热度Top10，以Music为例" class="headerlink" title="10.4.5 统计每个类别中的视频热度Top10，以Music为例"></a><strong>10.4.5 统计每个类别中的视频热度Top10，以Music为例</strong></h3><p>思路：</p>
<ol>
<li><p>要想统计Music类别中的视频热度Top10，需要先找到Music类别，那么就需要将category展开，所以可以创建一张表用于存放categoryId展开的数据。</p>
</li>
<li><p>向category展开的表中插入数据。</p>
</li>
<li><p>统计对应类别（Music）中的视频热度。</p>
</li>
</ol>
<p>最终代码：</p>
<p>创建表类别表：</p>
<p><code>create table gulivideo_category(  videoId string,   uploader string,   age int,   categoryId string,   length int,   views int,   rate float,   ratings int,   comments int,   relatedId array&lt;string&gt;)row format delimited fields terminated by &quot;\t&quot; collection items terminated by &quot;&amp;&quot; stored as orc;</code></p>
<p>向类别表中插入数据：</p>
<p><code>insert into table gulivideo_category    select     videoId,    uploader,    age,    categoryId,    length,    views,    rate,    ratings,    comments,    relatedId   from     gulivideo_orc lateral view explode(category) catetory as categoryId;</code></p>
<p>统计Music类别的Top10（也可以统计其他）</p>
<p><code>select   videoId,   viewsfrom   gulivideo_category where   categoryId = &quot;Music&quot; order by   views desc limit  10;</code></p>
<h3 id="10-4-6-统计每个类别中视频流量Top10，以Music为例"><a href="#10-4-6-统计每个类别中视频流量Top10，以Music为例" class="headerlink" title="10.4.6 统计每个类别中视频流量Top10，以Music为例"></a><strong>10.4.6 统计每个类别中视频流量Top10，以Music为例</strong></h3><p>思路：</p>
<ol>
<li><p>创建视频类别展开表（categoryId列转行后的表）</p>
</li>
<li><p>按照ratings排序即可</p>
</li>
</ol>
<p>最终代码：</p>
<p><code>select   videoId,  views,  ratings from   gulivideo_category where   categoryId = &quot;Music&quot; order by   ratings desc limit   10;</code></p>
<h3 id="10-4-7-统计上传视频最多的用户Top10以及他们上传的观看次数在前20的视频"><a href="#10-4-7-统计上传视频最多的用户Top10以及他们上传的观看次数在前20的视频" class="headerlink" title="10.4.7 统计上传视频最多的用户Top10以及他们上传的观看次数在前20的视频"></a><strong>10.4.7 统计上传视频最多的用户Top10以及他们上传的观看次数在前20的视频</strong></h3><p>思路：</p>
<ol>
<li>先找到上传视频最多的10个用户的用户信息</li>
</ol>
<p><code>select   * from   gulivideo_user_orc order by   videos desc limit   10;</code></p>
<ol start="2">
<li>通过uploader字段与gulivideo_orc表进行join，得到的信息按照views观看次数进行排序即可。</li>
</ol>
<p>最终代码：</p>
<p><code>select   t2.videoId,   t2.views,  t2.ratings,  t1.videos,  t1.friends from (  select     *   from     gulivideo_user_orc   order by     videos desc   limit     10) t1 join   gulivideo_orc t2on   t1.uploader = t2.uploader order by   views desc limit   20;</code></p>
<h3 id="10-4-8-统计每个类别视频观看数Top10"><a href="#10-4-8-统计每个类别视频观看数Top10" class="headerlink" title="10.4.8 统计每个类别视频观看数Top10"></a><strong>10.4.8 统计每个类别视频观看数Top10</strong></h3><p>思路：</p>
<ol>
<li><p>先得到categoryId展开的表数据</p>
</li>
<li><p>子查询按照categoryId进行分区，然后分区内排序，并生成递增数字，该递增数字这一列起名为rank列</p>
</li>
<li><p>通过子查询产生的临时表，查询rank值小于等于10的数据行即可。</p>
</li>
</ol>
<p>最终代码：</p>
<p><code>select   t1.* from (  select     videoId,    categoryId,    views,    row_number() over(partition by categoryId order by views desc) rank from gulivideo_category) t1 where   rank &lt;= 10;</code></p>
<h1 id="第11章-常见错误及解决方案"><a href="#第11章-常见错误及解决方案" class="headerlink" title="第11章 常见错误及解决方案"></a><strong>第11章</strong> <strong>常见错误及解决方案</strong></h1><p>1）SecureCRT 7.3出现乱码或者删除不掉数据，免安装版的SecureCRT 卸载或者用虚拟机直接操作或者换安装版的SecureCRT </p>
<p>2）连接不上mysql数据库</p>
<pre><code>（1）导错驱动包，应该把mysql-connector-java-5.1.27-bin.jar导入/opt/module/hive/lib的不是这个包。错把mysql-connector-java-5.1.27.tar.gz导入hive/lib包下。

（2）修改user表中的主机名称没有都修改为%，而是修改为localhost
</code></pre>
<p>3）hive默认的输入格式处理是CombineHiveInputFormat，会对小文件进行合并。</p>
<p><code>hive (default)&gt; set hive.input.format;</code></p>
<p>hive.input.format&#x3D;org.apache.hadoop.hive.ql.io.CombineHiveInputFormat</p>
<p>可以采用HiveInputFormat就会根据分区数输出相应的文件。</p>
<p><code>hive (default)&gt; set hive.input.format=org.apache.hadoop.hive.ql.io.HiveInputFormat;</code></p>
<p>4）不能执行mapreduce程序</p>
<pre><code>可能是hadoop的yarn没开启。
</code></pre>
<p>5）启动mysql服务时，报MySQL server PID file could not be found! 异常。</p>
<pre><code>在/var/lock/subsys/mysql路径下创建hadoop01.pid，并在文件中添加内容：4396
</code></pre>
<p>6）报service mysql status MySQL is not running, but lock file (&#x2F;var&#x2F;lock&#x2F;subsys&#x2F;mysql[失败])异常。</p>
<pre><code>解决方案：在/var/lib/mysql 目录下创建： -rw-rw----. 1 mysql mysql     5 12月 22 16:41 hadoop01.pid 文件，并修改权限为 777。
</code></pre>
<p>7）JVM堆内存溢出</p>
<p>描述：java.lang.OutOfMemoryError: Java heap space</p>
<p>解决：在yarn-site.xml中加入如下代码</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">name</span>&gt;</span>yarn.scheduler.maximum-allocation-mb<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">value</span>&gt;</span>2048<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line"></span><br><span class="line"> 	<span class="tag">&lt;<span class="name">name</span>&gt;</span>yarn.scheduler.minimum-allocation-mb<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line"></span><br><span class="line"> 	<span class="tag">&lt;<span class="name">value</span>&gt;</span>2048<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">name</span>&gt;</span>yarn.nodemanager.vmem-pmem-ratio<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">value</span>&gt;</span>2.1<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">name</span>&gt;</span>mapred.child.java.opts<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">value</span>&gt;</span>-Xmx1024m<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br></pre></td></tr></table></figure>



</article><div class="post-copyright"><div class="copyright-cc-box"><i class="anzhiyufont anzhiyu-icon-copyright"></i></div><div class="post-copyright__author_box"><a class="post-copyright__author_img" href="/" title="头像"><img class="post-copyright__author_img_back" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2023/04/27/64496e511b09c.jpg" title="头像" alt="头像"><img class="post-copyright__author_img_front" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2023/04/27/64496e511b09c.jpg" title="头像" alt="头像"></a><div class="post-copyright__author_name">小贾嗯嗯</div><div class="post-copyright__author_desc"></div></div><div class="post-copyright__post__info"><a class="post-copyright__original" title="该文章为原创文章，注意版权协议" href="http://mujxn.cn/2021/02/21/hive/">原创</a><a class="post-copyright-title"><span onclick="rm.copyPageUrl('http://mujxn.cn/2021/02/21/hive/')">hive</span></a></div><div class="post-tools" id="post-tools"><div class="post-tools-left"><div class="rewardLeftButton"><div class="post-reward" onclick="anzhiyu.addRewardMask()"><div class="reward-button button--animated" title="赞赏作者"><i class="anzhiyufont anzhiyu-icon-hand-heart-fill"></i>打赏作者</div><div class="reward-main"><div class="reward-all"><span class="reward-title">感谢你赐予我前进的力量</span><ul class="reward-group"><li class="reward-item"><a href="https://typora-notes-xiaojia.oss-cn-beijing.aliyuncs.com/mujxn.cn/WechatIMG47.jpg" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://typora-notes-xiaojia.oss-cn-beijing.aliyuncs.com/mujxn.cn/WechatIMG47.jpg" alt="微信"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://typora-notes-xiaojia.oss-cn-beijing.aliyuncs.com/mujxn.cn/WechatIMG46.jpg" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://typora-notes-xiaojia.oss-cn-beijing.aliyuncs.com/mujxn.cn/WechatIMG46.jpg" alt="支付宝"/></a><div class="post-qr-code-desc">支付宝</div></li></ul><a class="reward-main-btn" href="/about/#about-reward" target="_blank"><div class="reward-text">赞赏者名单</div><div class="reward-dec">因为你们的支持让我意识到写文章的价值🙏</div></a></div></div></div><div id="quit-box" onclick="anzhiyu.removeRewardMask()" style="display: none"></div></div><div class="shareRight"><div class="share-link mobile"><div class="share-qrcode"><div class="share-button" title="使用手机访问这篇文章"><i class="anzhiyufont anzhiyu-icon-qrcode"></i></div><div class="share-main"><div class="share-main-all"><div id="qrcode" title="http://mujxn.cn/2021/02/21/hive/"></div><div class="reward-dec">使用手机访问这篇文章</div></div></div></div></div><div class="share-link weibo"><a class="share-button" target="_blank" href="https://service.weibo.com/share/share.php?title=hive&amp;url=http://mujxn.cn/2021/02/21/hive/&amp;pic=https://api-storage.4ce.cn/v1/56377fd133a97667091971790db975ba.jpg" rel="external nofollow noreferrer noopener"><i class="anzhiyufont anzhiyu-icon-weibo"></i></a></div><script>function copyCurrentPageUrl() {
  var currentPageUrl = window.location.href;
  var input = document.createElement("input");
  input.setAttribute("value", currentPageUrl);
  document.body.appendChild(input);
  input.select();
  input.setSelectionRange(0, 99999);
  document.execCommand("copy");
  document.body.removeChild(input);
}</script><div class="share-link copyurl"><div class="share-button" id="post-share-url" title="复制链接" onclick="copyCurrentPageUrl()"><i class="anzhiyufont anzhiyu-icon-link"></i></div></div></div></div></div><div class="post-copyright__notice"><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://mujxn.cn" target="_blank">木槿昔年</a>！</span></div></div><div class="post-tools-right"><div class="tag_share"><div class="post-meta__box"><div class="post-meta__box__tag-list"><a class="post-meta__box__tags" href="/tags/hive/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>hive<span class="tagsPageCount">1</span></a></div></div></div><div class="post_share"><div class="social-share" data-image="https://api-storage.4ce.cn/v1/0a5ec69131962af4779f28215c2785f4.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"/><script src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer="defer"></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2021/02/21/Could%20not%20retrieve%20mirrorlist%20http:%20%20mirrorlist.centos.org%20?release=6/"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://api-storage.4ce.cn/v1/e449f9b80152982c49726d13f538b367.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Could not retrieve mirrorlist http://mirrorlist.centos.org/?release=6</div></div></a></div><div class="next-post pull-right"><a href="/2021/02/21/CentOS6%E8%A7%A3%E5%86%B3yum%E4%B8%8D%E8%83%BD%E4%BD%BF%E7%94%A8%E9%97%AE%E9%A2%98/"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://api-storage.4ce.cn/v1/5e2b26ed1d14d895655dc4bbb820dc7d.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">CentOS6解决yum不能使用问题</div></div></a></div></nav><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="anzhiyufont anzhiyu-icon-comments"></i><span> 评论</span></div><div class="comment-randomInfo"><a onclick="anzhiyu.addRandomCommentInfo()" href="javascript:void(0)">匿名评论</a><a href="/privacy" style="margin-left: 4px">隐私政策</a></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div><div class="comment-barrage"></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-content"><div class="author-info-avatar"><img class="avatar-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2023/04/27/64496e511b09c.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__description"></div><div class="author-info__bottom-group"><a class="author-info__bottom-group-left" href="/"><h1 class="author-info__name">小贾嗯嗯</h1><div class="author-info__desc"></div></a><div class="card-info-social-icons is-center"><a class="social-icon faa-parent animated-hover" href="https://github.com/xiaojiaenen" target="_blank" title="Github"><i class="anzhiyufont anzhiyu-icon-github"></i></a><a class="social-icon faa-parent animated-hover" href="https://space.bilibili.com/626120309" target="_blank" title="BiliBili"><i class="anzhiyufont anzhiyu-icon-bilibili"></i></a></div></div></div></div><div class="card-widget anzhiyu-right-widget" id="card-wechat" onclick="null"><div id="flip-wrapper"><div id="flip-content"><div class="face" style="background: url(https://bu.dusays.com/2023/01/13/63c02edf44033.png) center center / 100% no-repeat"></div><div class="back face" style="background: url(https://bu.dusays.com/2023/05/13/645fa415e8694.png) center center / 100% no-repeat"></div></div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bars"></i><span>文章目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#Hive%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C"><span class="toc-number">1.</span> <span class="toc-text">Hive基本操作</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%EF%BC%881%EF%BC%89%E5%90%AF%E5%8A%A8hive"><span class="toc-number">1.1.</span> <span class="toc-text">（1）启动hive</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%EF%BC%882%EF%BC%89%E6%9F%A5%E7%9C%8B%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="toc-number">1.2.</span> <span class="toc-text">（2）查看数据库</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%EF%BC%883%EF%BC%89%E6%89%93%E5%BC%80%E9%BB%98%E8%AE%A4%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="toc-number">1.3.</span> <span class="toc-text">（3）打开默认数据库</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%EF%BC%884%EF%BC%89%E6%98%BE%E7%A4%BAdefault%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B8%AD%E7%9A%84%E8%A1%A8"><span class="toc-number">1.4.</span> <span class="toc-text">（4）显示default数据库中的表</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%EF%BC%885%EF%BC%89%E5%88%9B%E5%BB%BA%E4%B8%80%E5%BC%A0%E8%A1%A8"><span class="toc-number">1.5.</span> <span class="toc-text">（5）创建一张表</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%EF%BC%886%EF%BC%89%E6%98%BE%E7%A4%BA%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B8%AD%E6%9C%89%E5%87%A0%E5%BC%A0%E8%A1%A8"><span class="toc-number">1.6.</span> <span class="toc-text">（6）显示数据库中有几张表</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%EF%BC%887%EF%BC%89%E6%9F%A5%E7%9C%8B%E8%A1%A8%E7%9A%84%E7%BB%93%E6%9E%84"><span class="toc-number">1.7.</span> <span class="toc-text">（7）查看表的结构</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%EF%BC%888%EF%BC%89%E5%90%91%E8%A1%A8%E4%B8%AD%E6%8F%92%E5%85%A5%E6%95%B0%E6%8D%AE"><span class="toc-number">1.8.</span> <span class="toc-text">（8）向表中插入数据</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%EF%BC%889%EF%BC%89%E6%9F%A5%E8%AF%A2%E8%A1%A8%E4%B8%AD%E6%95%B0%E6%8D%AE"><span class="toc-number">1.9.</span> <span class="toc-text">（9）查询表中数据</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%EF%BC%8810%EF%BC%89%E9%80%80%E5%87%BAhive"><span class="toc-number">1.10.</span> <span class="toc-text">（10）退出hive</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Hive%E5%AE%9E%E9%99%85%E6%93%8D%E4%BD%9C"><span class="toc-number">2.</span> <span class="toc-text">Hive实际操作</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%EF%BC%881%EF%BC%89%E5%90%AF%E5%8A%A8hive-1"><span class="toc-number">2.1.</span> <span class="toc-text">（1）启动hive</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%EF%BC%882%EF%BC%89%E6%98%BE%E7%A4%BA%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="toc-number">2.2.</span> <span class="toc-text">（2）显示数据库</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%EF%BC%883%EF%BC%89%E4%BD%BF%E7%94%A8default%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="toc-number">2.3.</span> <span class="toc-text">（3）使用default数据库</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%EF%BC%884%EF%BC%89%E6%98%BE%E7%A4%BAdefault%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B8%AD%E7%9A%84%E8%A1%A8-1"><span class="toc-number">2.4.</span> <span class="toc-text">（4）显示default数据库中的表</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%EF%BC%885%EF%BC%89%E5%88%A0%E9%99%A4%E5%B7%B2%E5%88%9B%E5%BB%BA%E7%9A%84student%E8%A1%A8"><span class="toc-number">2.5.</span> <span class="toc-text">（5）删除已创建的student表</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%EF%BC%886%EF%BC%89%E5%88%9B%E5%BB%BAstudent%E8%A1%A8-%E5%B9%B6%E5%A3%B0%E6%98%8E%E6%96%87%E4%BB%B6%E5%88%86%E9%9A%94%E7%AC%A6%E2%80%99-t%E2%80%99"><span class="toc-number">2.6.</span> <span class="toc-text">（6）创建student表, 并声明文件分隔符’\t’</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%EF%BC%887%EF%BC%89%E5%8A%A0%E8%BD%BD-opt-module-datas-student-txt-%E6%96%87%E4%BB%B6%E5%88%B0student%E6%95%B0%E6%8D%AE%E5%BA%93%E8%A1%A8%E4%B8%AD%E3%80%82"><span class="toc-number">2.7.</span> <span class="toc-text">（7）加载&#x2F;opt&#x2F;module&#x2F;datas&#x2F;student.txt 文件到student数据库表中。</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%EF%BC%888%EF%BC%89Hive%E6%9F%A5%E8%AF%A2%E7%BB%93%E6%9E%9C"><span class="toc-number">2.8.</span> <span class="toc-text">（8）Hive查询结果</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%EF%BC%8E%E9%81%87%E5%88%B0%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-number">3.</span> <span class="toc-text">3．遇到的问题</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%86%8D%E6%89%93%E5%BC%80%E4%B8%80%E4%B8%AA%E5%AE%A2%E6%88%B7%E7%AB%AF%E7%AA%97%E5%8F%A3%E5%90%AF%E5%8A%A8hive%EF%BC%8C%E4%BC%9A%E4%BA%A7%E7%94%9Fjava-sql-SQLException%E5%BC%82%E5%B8%B8%E3%80%82"><span class="toc-number">3.1.</span> <span class="toc-text">再打开一个客户端窗口启动hive，会产生java.sql.SQLException异常。</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">4.</span> <span class="toc-text">配置文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HiveJDBC%E8%AE%BF%E9%97%AE"><span class="toc-number">5.</span> <span class="toc-text">HiveJDBC访问</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-6-1%E5%90%AF%E5%8A%A8hiveserver2%E6%9C%8D%E5%8A%A1"><span class="toc-number">5.1.</span> <span class="toc-text">2.6.1启动hiveserver2服务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-6-2%E5%90%AF%E5%8A%A8beeline"><span class="toc-number">5.2.</span> <span class="toc-text">2.6.2启动beeline</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-6-3%E8%BF%9E%E6%8E%A5hiveserver2"><span class="toc-number">6.</span> <span class="toc-text">2.6.3连接hiveserver2</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-7-Hive%E5%B8%B8%E7%94%A8%E4%BA%A4%E4%BA%92%E5%91%BD%E4%BB%A4"><span class="toc-number">7.</span> <span class="toc-text">2.7 Hive常用交互命令</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1%EF%BC%8E%E2%80%9C-e%E2%80%9D%E4%B8%8D%E8%BF%9B%E5%85%A5hive%E7%9A%84%E4%BA%A4%E4%BA%92%E7%AA%97%E5%8F%A3%E6%89%A7%E8%A1%8Csql%E8%AF%AD%E5%8F%A5"><span class="toc-number">7.1.</span> <span class="toc-text">1．“-e”不进入hive的交互窗口执行sql语句</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2%EF%BC%8E%E2%80%9C-f%E2%80%9D%E6%89%A7%E8%A1%8C%E8%84%9A%E6%9C%AC%E4%B8%ADsql%E8%AF%AD%E5%8F%A5"><span class="toc-number">7.2.</span> <span class="toc-text">2．“-f”执行脚本中sql语句</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-Hive%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B"><span class="toc-number">8.</span> <span class="toc-text">3 Hive数据类型</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-%E5%9F%BA%E6%9C%AC%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B"><span class="toc-number">8.1.</span> <span class="toc-text">3.1 基本数据类型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-%E9%9B%86%E5%90%88%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B"><span class="toc-number">8.2.</span> <span class="toc-text">3.2 集合数据类型</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B%E5%AE%9E%E6%93%8D"><span class="toc-number">9.</span> <span class="toc-text">案例实操</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1%EF%BC%89-%E5%81%87%E8%AE%BE%E6%9F%90%E8%A1%A8%E6%9C%89%E5%A6%82%E4%B8%8B%E4%B8%80%E8%A1%8C%EF%BC%8C%E6%88%91%E4%BB%AC%E7%94%A8JSON%E6%A0%BC%E5%BC%8F%E6%9D%A5%E8%A1%A8%E7%A4%BA%E5%85%B6%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E3%80%82%E5%9C%A8Hive%E4%B8%8B%E8%AE%BF%E9%97%AE%E7%9A%84%E6%A0%BC%E5%BC%8F%E4%B8%BA"><span class="toc-number">9.1.</span> <span class="toc-text">1） 假设某表有如下一行，我们用JSON格式来表示其数据结构。在Hive下访问的格式为</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2%EF%BC%89%E5%9F%BA%E4%BA%8E%E4%B8%8A%E8%BF%B0%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%EF%BC%8C%E6%88%91%E4%BB%AC%E5%9C%A8Hive%E9%87%8C%E5%88%9B%E5%BB%BA%E5%AF%B9%E5%BA%94%E7%9A%84%E8%A1%A8%EF%BC%8C%E5%B9%B6%E5%AF%BC%E5%85%A5%E6%95%B0%E6%8D%AE%E3%80%82"><span class="toc-number">9.2.</span> <span class="toc-text">2）基于上述数据结构，我们在Hive里创建对应的表，并导入数据。</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E6%9C%AC%E5%9C%B0%E6%B5%8B%E8%AF%95%E6%96%87%E4%BB%B6test-txt"><span class="toc-number">9.2.1.</span> <span class="toc-text">创建本地测试文件test.txt</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3%EF%BC%89Hive%E4%B8%8A%E5%88%9B%E5%BB%BA%E6%B5%8B%E8%AF%95%E8%A1%A8test"><span class="toc-number">9.2.2.</span> <span class="toc-text">3）Hive上创建测试表test</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4%EF%BC%89%E5%AF%BC%E5%85%A5%E6%96%87%E6%9C%AC%E6%95%B0%E6%8D%AE%E5%88%B0%E6%B5%8B%E8%AF%95%E8%A1%A8"><span class="toc-number">9.3.</span> <span class="toc-text">4）导入文本数据到测试表</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5%EF%BC%89%E8%AE%BF%E9%97%AE%E4%B8%89%E7%A7%8D%E9%9B%86%E5%90%88%E5%88%97%E9%87%8C%E7%9A%84%E6%95%B0%E6%8D%AE%EF%BC%8C%E4%BB%A5%E4%B8%8B%E5%88%86%E5%88%AB%E6%98%AFARRAY%EF%BC%8CMAP%EF%BC%8CSTRUCT%E7%9A%84%E8%AE%BF%E9%97%AE%E6%96%B9%E5%BC%8F"><span class="toc-number">9.4.</span> <span class="toc-text">5）访问三种集合列里的数据，以下分别是ARRAY，MAP，STRUCT的访问方式</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-%E7%B1%BB%E5%9E%8B%E8%BD%AC%E5%8C%96"><span class="toc-number">10.</span> <span class="toc-text">3.3 类型转化</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC4%E7%AB%A0-DDL%E6%95%B0%E6%8D%AE%E5%AE%9A%E4%B9%89"><span class="toc-number"></span> <span class="toc-text">第4章 DDL数据定义</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1-%E5%88%9B%E5%BB%BA%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="toc-number"></span> <span class="toc-text">4.1 创建数据库</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-2-%E6%9F%A5%E8%AF%A2%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="toc-number"></span> <span class="toc-text">4.2 查询数据库</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-1-%E6%98%BE%E7%A4%BA%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="toc-number">1.</span> <span class="toc-text">4.2.1 显示数据库</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-2-%E6%9F%A5%E7%9C%8B%E6%95%B0%E6%8D%AE%E5%BA%93%E8%AF%A6%E6%83%85"><span class="toc-number">2.</span> <span class="toc-text">4.2.2 查看数据库详情</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-3-%E5%88%87%E6%8D%A2%E5%BD%93%E5%89%8D%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="toc-number">3.</span> <span class="toc-text">4.3.3 切换当前数据库</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-3-%E4%BF%AE%E6%94%B9%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="toc-number"></span> <span class="toc-text">4.3 修改数据库</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-4-%E5%88%A0%E9%99%A4%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="toc-number"></span> <span class="toc-text">4.4 删除数据库</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-5-%E5%88%9B%E5%BB%BA%E8%A1%A8"><span class="toc-number"></span> <span class="toc-text">4.5 创建表</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-5-1-%E7%AE%A1%E7%90%86%E8%A1%A8"><span class="toc-number">1.</span> <span class="toc-text">4.5.1 管理表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-5-2-%E5%A4%96%E9%83%A8%E8%A1%A8"><span class="toc-number">2.</span> <span class="toc-text">4.5.2 外部表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-5-3-%E7%AE%A1%E7%90%86%E8%A1%A8%E4%B8%8E%E5%A4%96%E9%83%A8%E8%A1%A8%E7%9A%84%E4%BA%92%E7%9B%B8%E8%BD%AC%E6%8D%A2"><span class="toc-number">3.</span> <span class="toc-text">**4.5.3 **管理表与外部表的互相转换</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-6-%E5%88%86%E5%8C%BA%E8%A1%A8"><span class="toc-number"></span> <span class="toc-text">4.6 分区表</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-6-1-%E5%88%86%E5%8C%BA%E8%A1%A8%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C"><span class="toc-number">1.</span> <span class="toc-text">4.6.1 分区表基本操作</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-6-2-%E5%88%86%E5%8C%BA%E8%A1%A8%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9"><span class="toc-number">2.</span> <span class="toc-text">4.6.2 分区表注意事项</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-7-%E4%BF%AE%E6%94%B9%E8%A1%A8"><span class="toc-number"></span> <span class="toc-text">4.7 修改表</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-7-1-%E9%87%8D%E5%91%BD%E5%90%8D%E8%A1%A8"><span class="toc-number">1.</span> <span class="toc-text">4.7.1 重命名表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-7-2-%E5%A2%9E%E5%8A%A0%E3%80%81%E4%BF%AE%E6%94%B9%E5%92%8C%E5%88%A0%E9%99%A4%E8%A1%A8%E5%88%86%E5%8C%BA"><span class="toc-number">2.</span> <span class="toc-text">4.7.2 增加、修改和删除表分区</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-7-3-%E5%A2%9E%E5%8A%A0-%E4%BF%AE%E6%94%B9-%E6%9B%BF%E6%8D%A2%E5%88%97%E4%BF%A1%E6%81%AF"><span class="toc-number">3.</span> <span class="toc-text">4.7.3 增加&#x2F;修改&#x2F;替换列信息</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-8-%E5%88%A0%E9%99%A4%E8%A1%A8"><span class="toc-number"></span> <span class="toc-text">4.8 删除表</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC5%E7%AB%A0-DML%E6%95%B0%E6%8D%AE%E6%93%8D%E4%BD%9C"><span class="toc-number"></span> <span class="toc-text">第5章 DML数据操作</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#5-1-%E6%95%B0%E6%8D%AE%E5%AF%BC%E5%85%A5"><span class="toc-number"></span> <span class="toc-text">5.1 数据导入</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-1-%E5%90%91%E8%A1%A8%E4%B8%AD%E8%A3%85%E8%BD%BD%E6%95%B0%E6%8D%AE%EF%BC%88Load%EF%BC%89"><span class="toc-number">1.</span> <span class="toc-text">5.1.1 向表中装载数据（Load）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-2-%E9%80%9A%E8%BF%87%E6%9F%A5%E8%AF%A2%E8%AF%AD%E5%8F%A5%E5%90%91%E8%A1%A8%E4%B8%AD%E6%8F%92%E5%85%A5%E6%95%B0%E6%8D%AE%EF%BC%88Insert%EF%BC%89"><span class="toc-number">2.</span> <span class="toc-text">5.1.2 通过查询语句向表中插入数据（Insert）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-3-%E6%9F%A5%E8%AF%A2%E8%AF%AD%E5%8F%A5%E4%B8%AD%E5%88%9B%E5%BB%BA%E8%A1%A8%E5%B9%B6%E5%8A%A0%E8%BD%BD%E6%95%B0%E6%8D%AE%EF%BC%88As-Select%EF%BC%89"><span class="toc-number">3.</span> <span class="toc-text">5.1.3 查询语句中创建表并加载数据（As Select）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-4-%E5%88%9B%E5%BB%BA%E8%A1%A8%E6%97%B6%E9%80%9A%E8%BF%87Location%E6%8C%87%E5%AE%9A%E5%8A%A0%E8%BD%BD%E6%95%B0%E6%8D%AE%E8%B7%AF%E5%BE%84"><span class="toc-number">4.</span> <span class="toc-text">5.1.4 创建表时通过Location指定加载数据路径</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-5-Import%E6%95%B0%E6%8D%AE%E5%88%B0%E6%8C%87%E5%AE%9AHive%E8%A1%A8%E4%B8%AD"><span class="toc-number">5.</span> <span class="toc-text">5.1.5 Import数据到指定Hive表中</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-2-%E6%95%B0%E6%8D%AE%E5%AF%BC%E5%87%BA"><span class="toc-number"></span> <span class="toc-text">5.2 数据导出</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-1-Insert%E5%AF%BC%E5%87%BA"><span class="toc-number">1.</span> <span class="toc-text">5.2.1 Insert导出</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-2-Hadoop%E5%91%BD%E4%BB%A4%E5%AF%BC%E5%87%BA%E5%88%B0%E6%9C%AC%E5%9C%B0"><span class="toc-number">2.</span> <span class="toc-text">5.2.2 Hadoop命令导出到本地</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-3-Hive-Shell-%E5%91%BD%E4%BB%A4%E5%AF%BC%E5%87%BA"><span class="toc-number">3.</span> <span class="toc-text">5.2.3 Hive Shell 命令导出</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-4-Export%E5%AF%BC%E5%87%BA%E5%88%B0HDFS%E4%B8%8A"><span class="toc-number">4.</span> <span class="toc-text">5.2.4 Export导出到HDFS上</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-5-Sqoop%E5%AF%BC%E5%87%BA"><span class="toc-number">5.</span> <span class="toc-text">5.2.5 Sqoop导出</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-3-%E6%B8%85%E9%99%A4%E8%A1%A8%E4%B8%AD%E6%95%B0%E6%8D%AE%EF%BC%88Truncate%EF%BC%89"><span class="toc-number"></span> <span class="toc-text">5.3 清除表中数据（Truncate）</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC6%E7%AB%A0-%E6%9F%A5%E8%AF%A2"><span class="toc-number"></span> <span class="toc-text">第6章 查询</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#6-1-%E5%9F%BA%E6%9C%AC%E6%9F%A5%E8%AF%A2%EF%BC%88Select%E2%80%A6From%EF%BC%89"><span class="toc-number"></span> <span class="toc-text">6.1 基本查询（Select…From）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-1-%E5%85%A8%E8%A1%A8%E5%92%8C%E7%89%B9%E5%AE%9A%E5%88%97%E6%9F%A5%E8%AF%A2"><span class="toc-number">1.</span> <span class="toc-text">6.1.1 全表和特定列查询</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-2-%E5%88%97%E5%88%AB%E5%90%8D"><span class="toc-number">2.</span> <span class="toc-text">6.1.2 列别名</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-3-%E7%AE%97%E6%9C%AF%E8%BF%90%E7%AE%97%E7%AC%A6"><span class="toc-number">3.</span> <span class="toc-text">6.1.3 算术运算符</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-4-%E5%B8%B8%E7%94%A8%E5%87%BD%E6%95%B0"><span class="toc-number">4.</span> <span class="toc-text">6.1.4 常用函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-5-Limit%E8%AF%AD%E5%8F%A5"><span class="toc-number">5.</span> <span class="toc-text">6.1.5 Limit语句</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-2-Where%E8%AF%AD%E5%8F%A5"><span class="toc-number"></span> <span class="toc-text">6.2 Where语句</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2-1-%E6%AF%94%E8%BE%83%E8%BF%90%E7%AE%97%E7%AC%A6%EF%BC%88Between-In-Is-Null%EF%BC%89"><span class="toc-number">1.</span> <span class="toc-text">6.2.1 比较运算符（Between&#x2F;In&#x2F; Is Null）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2-2-Like%E5%92%8CRLike"><span class="toc-number">2.</span> <span class="toc-text">6.2.2 Like和RLike</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2-3-%E9%80%BB%E8%BE%91%E8%BF%90%E7%AE%97%E7%AC%A6%EF%BC%88And-Or-Not%EF%BC%89"><span class="toc-number">3.</span> <span class="toc-text">6.2.3 逻辑运算符（And&#x2F;Or&#x2F;Not）</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-3-%E5%88%86%E7%BB%84"><span class="toc-number"></span> <span class="toc-text">6.3 分组</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-3-1-Group-By%E8%AF%AD%E5%8F%A5"><span class="toc-number">1.</span> <span class="toc-text">6.3.1 Group By语句</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-3-2-Having%E8%AF%AD%E5%8F%A5"><span class="toc-number">2.</span> <span class="toc-text">6.3.2 Having语句</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-4-Join%E8%AF%AD%E5%8F%A5"><span class="toc-number"></span> <span class="toc-text">6.4 Join语句</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-4-1-%E7%AD%89%E5%80%BCJoin"><span class="toc-number">1.</span> <span class="toc-text">6.4.1 等值Join</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-4-2-%E8%A1%A8%E7%9A%84%E5%88%AB%E5%90%8D"><span class="toc-number">2.</span> <span class="toc-text">6.4.2 表的别名</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-4-3-%E5%86%85%E8%BF%9E%E6%8E%A5"><span class="toc-number">3.</span> <span class="toc-text">6.4.3 内连接</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-4-4-%E5%B7%A6%E5%A4%96%E8%BF%9E%E6%8E%A5"><span class="toc-number">4.</span> <span class="toc-text">6.4.4 左外连接</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-4-5-%E5%8F%B3%E5%A4%96%E8%BF%9E%E6%8E%A5"><span class="toc-number">5.</span> <span class="toc-text">6.4.5 右外连接</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-4-6-%E6%BB%A1%E5%A4%96%E8%BF%9E%E6%8E%A5"><span class="toc-number">6.</span> <span class="toc-text">6.4.6 满外连接</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-4-7-%E5%A4%9A%E8%A1%A8%E8%BF%9E%E6%8E%A5"><span class="toc-number">7.</span> <span class="toc-text">6.4.7 多表连接</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-4-8-%E7%AC%9B%E5%8D%A1%E5%B0%94%E7%A7%AF"><span class="toc-number">8.</span> <span class="toc-text">6.4.8 笛卡尔积</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-4-9-%E8%BF%9E%E6%8E%A5%E8%B0%93%E8%AF%8D%E4%B8%AD%E4%B8%8D%E6%94%AF%E6%8C%81or"><span class="toc-number">9.</span> <span class="toc-text">6.4.9 连接谓词中不支持or</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-5-%E6%8E%92%E5%BA%8F"><span class="toc-number"></span> <span class="toc-text">6.5 排序</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-5-1-%E5%85%A8%E5%B1%80%E6%8E%92%E5%BA%8F%EF%BC%88Order-By%EF%BC%89"><span class="toc-number">1.</span> <span class="toc-text">6.5.1 全局排序（Order By）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-5-2-%E6%8C%89%E7%85%A7%E5%88%AB%E5%90%8D%E6%8E%92%E5%BA%8F"><span class="toc-number">2.</span> <span class="toc-text">6.5.2 按照别名排序</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-5-3-%E5%A4%9A%E4%B8%AA%E5%88%97%E6%8E%92%E5%BA%8F"><span class="toc-number">3.</span> <span class="toc-text">6.5.3 多个列排序</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-5-4-%E6%AF%8F%E4%B8%AAMapReduce%E5%86%85%E9%83%A8%E6%8E%92%E5%BA%8F%EF%BC%88Sort-By%EF%BC%89"><span class="toc-number">4.</span> <span class="toc-text">6.5.4 每个MapReduce内部排序（Sort By）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-5-5-%E5%88%86%E5%8C%BA%E6%8E%92%E5%BA%8F%EF%BC%88Distribute-By%EF%BC%89"><span class="toc-number">5.</span> <span class="toc-text">6.5.5 分区排序（Distribute By）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-5-6-Cluster-By"><span class="toc-number">6.</span> <span class="toc-text">6.5.6 Cluster By</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-6-%E5%88%86%E6%A1%B6%E5%8F%8A%E6%8A%BD%E6%A0%B7%E6%9F%A5%E8%AF%A2"><span class="toc-number"></span> <span class="toc-text">6.6 分桶及抽样查询</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-6-1-%E5%88%86%E6%A1%B6%E8%A1%A8%E6%95%B0%E6%8D%AE%E5%AD%98%E5%82%A8"><span class="toc-number">1.</span> <span class="toc-text">6.6.1 分桶表数据存储</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-6-2-%E5%88%86%E6%A1%B6%E6%8A%BD%E6%A0%B7%E6%9F%A5%E8%AF%A2"><span class="toc-number">2.</span> <span class="toc-text">6.6.2 分桶抽样查询</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-7-%E5%85%B6%E4%BB%96%E5%B8%B8%E7%94%A8%E6%9F%A5%E8%AF%A2%E5%87%BD%E6%95%B0"><span class="toc-number"></span> <span class="toc-text">6.7 其他常用查询函数</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-7-1-%E7%A9%BA%E5%AD%97%E6%AE%B5%E8%B5%8B%E5%80%BC"><span class="toc-number">1.</span> <span class="toc-text">6.7.1 空字段赋值</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-7-2-CASE-WHEN"><span class="toc-number">2.</span> <span class="toc-text">6.7.2 CASE WHEN</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-7-2-%E8%A1%8C%E8%BD%AC%E5%88%97"><span class="toc-number">3.</span> <span class="toc-text">6.7.2 行转列</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-7-3-%E5%88%97%E8%BD%AC%E8%A1%8C"><span class="toc-number">4.</span> <span class="toc-text">6.7.3 列转行</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-7-4-%E7%AA%97%E5%8F%A3%E5%87%BD%E6%95%B0"><span class="toc-number">5.</span> <span class="toc-text">6.7.4 窗口函数</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC8%E7%AB%A0-%E5%8E%8B%E7%BC%A9%E5%92%8C%E5%AD%98%E5%82%A8"><span class="toc-number"></span> <span class="toc-text">第8章 压缩和存储</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#8-1-Hadoop%E6%BA%90%E7%A0%81%E7%BC%96%E8%AF%91%E6%94%AF%E6%8C%81Snappy%E5%8E%8B%E7%BC%A9"><span class="toc-number"></span> <span class="toc-text">8.1 Hadoop源码编译支持Snappy压缩</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#8-1-1-%E8%B5%84%E6%BA%90%E5%87%86%E5%A4%87"><span class="toc-number">1.</span> <span class="toc-text">8.1.1 资源准备</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-1-2-jar%E5%8C%85%E5%AE%89%E8%A3%85"><span class="toc-number">2.</span> <span class="toc-text">8.1.2 jar包安装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-1-3-%E7%BC%96%E8%AF%91%E6%BA%90%E7%A0%81"><span class="toc-number">3.</span> <span class="toc-text">8.1.3 编译源码</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-2-Hadoop%E5%8E%8B%E7%BC%A9%E9%85%8D%E7%BD%AE"><span class="toc-number"></span> <span class="toc-text">8.2 Hadoop压缩配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#8-2-1-MR%E6%94%AF%E6%8C%81%E7%9A%84%E5%8E%8B%E7%BC%A9%E7%BC%96%E7%A0%81"><span class="toc-number">1.</span> <span class="toc-text">8.2.1 MR支持的压缩编码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-2-2-%E5%8E%8B%E7%BC%A9%E5%8F%82%E6%95%B0%E9%85%8D%E7%BD%AE"><span class="toc-number">2.</span> <span class="toc-text">8.2.2 压缩参数配置</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-3-%E5%BC%80%E5%90%AFMap%E8%BE%93%E5%87%BA%E9%98%B6%E6%AE%B5%E5%8E%8B%E7%BC%A9"><span class="toc-number"></span> <span class="toc-text">8.3 开启Map输出阶段压缩</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-4-%E5%BC%80%E5%90%AFReduce%E8%BE%93%E5%87%BA%E9%98%B6%E6%AE%B5%E5%8E%8B%E7%BC%A9"><span class="toc-number"></span> <span class="toc-text">8.4 开启Reduce输出阶段压缩</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-5-%E6%96%87%E4%BB%B6%E5%AD%98%E5%82%A8%E6%A0%BC%E5%BC%8F"><span class="toc-number"></span> <span class="toc-text">8.5 文件存储格式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#8-5-1-%E5%88%97%E5%BC%8F%E5%AD%98%E5%82%A8%E5%92%8C%E8%A1%8C%E5%BC%8F%E5%AD%98%E5%82%A8"><span class="toc-number">1.</span> <span class="toc-text">8.5.1 列式存储和行式存储</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-5-2-TextFile%E6%A0%BC%E5%BC%8F"><span class="toc-number">2.</span> <span class="toc-text">8.5.2 TextFile格式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-5-3-Orc%E6%A0%BC%E5%BC%8F"><span class="toc-number">3.</span> <span class="toc-text">8.5.3 Orc格式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-5-4-Parquet%E6%A0%BC%E5%BC%8F"><span class="toc-number">4.</span> <span class="toc-text">8.5.4 Parquet格式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-5-5-%E4%B8%BB%E6%B5%81%E6%96%87%E4%BB%B6%E5%AD%98%E5%82%A8%E6%A0%BC%E5%BC%8F%E5%AF%B9%E6%AF%94%E5%AE%9E%E9%AA%8C"><span class="toc-number">5.</span> <span class="toc-text">8.5.5 主流文件存储格式对比实验</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-6-%E5%AD%98%E5%82%A8%E5%92%8C%E5%8E%8B%E7%BC%A9%E7%BB%93%E5%90%88"><span class="toc-number"></span> <span class="toc-text">8.6 存储和压缩结合</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#8-6-1-%E4%BF%AE%E6%94%B9Hadoop%E9%9B%86%E7%BE%A4%E5%85%B7%E6%9C%89Snappy%E5%8E%8B%E7%BC%A9%E6%96%B9%E5%BC%8F"><span class="toc-number">1.</span> <span class="toc-text">8.6.1 修改Hadoop集群具有Snappy压缩方式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-6-2-%E6%B5%8B%E8%AF%95%E5%AD%98%E5%82%A8%E5%92%8C%E5%8E%8B%E7%BC%A9"><span class="toc-number">2.</span> <span class="toc-text">8.6.2 测试存储和压缩</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC9%E7%AB%A0-%E4%BC%81%E4%B8%9A%E7%BA%A7%E8%B0%83%E4%BC%98"><span class="toc-number"></span> <span class="toc-text">第9章 企业级调优</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#9-1-Fetch%E6%8A%93%E5%8F%96"><span class="toc-number"></span> <span class="toc-text">9.1 Fetch抓取</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-2-%E6%9C%AC%E5%9C%B0%E6%A8%A1%E5%BC%8F"><span class="toc-number"></span> <span class="toc-text">9.2 本地模式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-3-%E8%A1%A8%E7%9A%84%E4%BC%98%E5%8C%96"><span class="toc-number"></span> <span class="toc-text">9.3 表的优化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#9-3-1-%E5%B0%8F%E8%A1%A8%E3%80%81%E5%A4%A7%E8%A1%A8Join"><span class="toc-number">1.</span> <span class="toc-text">9.3.1 小表、大表Join</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-3-3-MapJoin"><span class="toc-number">2.</span> <span class="toc-text">9.3.3 MapJoin</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-7-JVM%E9%87%8D%E7%94%A8"><span class="toc-number"></span> <span class="toc-text">9.7 JVM重用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-8-%E6%8E%A8%E6%B5%8B%E6%89%A7%E8%A1%8C"><span class="toc-number"></span> <span class="toc-text">9.8 推测执行</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-9-%E5%8E%8B%E7%BC%A9"><span class="toc-number"></span> <span class="toc-text">9.9 压缩</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-10-%E6%89%A7%E8%A1%8C%E8%AE%A1%E5%88%92%EF%BC%88Explain%EF%BC%89"><span class="toc-number"></span> <span class="toc-text">9.10 执行计划（Explain）</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC10%E7%AB%A0-Hive%E5%AE%9E%E6%88%98%E4%B9%8B%E8%B0%B7%E7%B2%92%E5%BD%B1%E9%9F%B3"><span class="toc-number"></span> <span class="toc-text">第10章 Hive实战之谷粒影音</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#10-1-%E9%9C%80%E6%B1%82%E6%8F%8F%E8%BF%B0"><span class="toc-number"></span> <span class="toc-text">10.1 需求描述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-2-%E9%A1%B9%E7%9B%AE"><span class="toc-number"></span> <span class="toc-text">10.2 项目</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#10-2-1-%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="toc-number">1.</span> <span class="toc-text">10.2.1 数据结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-2-2-ETL%E5%8E%9F%E5%A7%8B%E6%95%B0%E6%8D%AE"><span class="toc-number">2.</span> <span class="toc-text">10.2.2 ETL原始数据</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-3-%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C"><span class="toc-number"></span> <span class="toc-text">10.3 准备工作</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#10-3-1-%E5%88%9B%E5%BB%BA%E8%A1%A8"><span class="toc-number">1.</span> <span class="toc-text">10.3.1 创建表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-3-2-%E5%AF%BC%E5%85%A5ETL%E5%90%8E%E7%9A%84%E6%95%B0%E6%8D%AE"><span class="toc-number">2.</span> <span class="toc-text">10.3.2 导入ETL后的数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-3-3-%E5%90%91ORC%E8%A1%A8%E6%8F%92%E5%85%A5%E6%95%B0%E6%8D%AE"><span class="toc-number">3.</span> <span class="toc-text">10.3.3 向ORC表插入数据</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-4-%E4%B8%9A%E5%8A%A1%E5%88%86%E6%9E%90"><span class="toc-number"></span> <span class="toc-text">10.4 业务分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#10-4-1-%E7%BB%9F%E8%AE%A1%E8%A7%86%E9%A2%91%E8%A7%82%E7%9C%8B%E6%95%B0Top10"><span class="toc-number">1.</span> <span class="toc-text">10.4.1 统计视频观看数Top10</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-4-2-%E7%BB%9F%E8%AE%A1%E8%A7%86%E9%A2%91%E7%B1%BB%E5%88%AB%E7%83%AD%E5%BA%A6Top10"><span class="toc-number">2.</span> <span class="toc-text">10.4.2 统计视频类别热度Top10</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-4-3-%E7%BB%9F%E8%AE%A1%E5%87%BA%E8%A7%86%E9%A2%91%E8%A7%82%E7%9C%8B%E6%95%B0%E6%9C%80%E9%AB%98%E7%9A%8420%E4%B8%AA%E8%A7%86%E9%A2%91%E7%9A%84%E6%89%80%E5%B1%9E%E7%B1%BB%E5%88%AB%E4%BB%A5%E5%8F%8A%E7%B1%BB%E5%88%AB%E5%8C%85%E5%90%ABTop20%E8%A7%86%E9%A2%91%E7%9A%84%E4%B8%AA%E6%95%B0"><span class="toc-number">3.</span> <span class="toc-text">10.4.3 统计出视频观看数最高的20个视频的所属类别以及类别包含Top20视频的个数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-4-4-%E7%BB%9F%E8%AE%A1%E8%A7%86%E9%A2%91%E8%A7%82%E7%9C%8B%E6%95%B0Top50%E6%89%80%E5%85%B3%E8%81%94%E8%A7%86%E9%A2%91%E7%9A%84%E6%89%80%E5%B1%9E%E7%B1%BB%E5%88%ABRank"><span class="toc-number">4.</span> <span class="toc-text">10.4.4 统计视频观看数Top50所关联视频的所属类别Rank</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-4-5-%E7%BB%9F%E8%AE%A1%E6%AF%8F%E4%B8%AA%E7%B1%BB%E5%88%AB%E4%B8%AD%E7%9A%84%E8%A7%86%E9%A2%91%E7%83%AD%E5%BA%A6Top10%EF%BC%8C%E4%BB%A5Music%E4%B8%BA%E4%BE%8B"><span class="toc-number">5.</span> <span class="toc-text">10.4.5 统计每个类别中的视频热度Top10，以Music为例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-4-6-%E7%BB%9F%E8%AE%A1%E6%AF%8F%E4%B8%AA%E7%B1%BB%E5%88%AB%E4%B8%AD%E8%A7%86%E9%A2%91%E6%B5%81%E9%87%8FTop10%EF%BC%8C%E4%BB%A5Music%E4%B8%BA%E4%BE%8B"><span class="toc-number">6.</span> <span class="toc-text">10.4.6 统计每个类别中视频流量Top10，以Music为例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-4-7-%E7%BB%9F%E8%AE%A1%E4%B8%8A%E4%BC%A0%E8%A7%86%E9%A2%91%E6%9C%80%E5%A4%9A%E7%9A%84%E7%94%A8%E6%88%B7Top10%E4%BB%A5%E5%8F%8A%E4%BB%96%E4%BB%AC%E4%B8%8A%E4%BC%A0%E7%9A%84%E8%A7%82%E7%9C%8B%E6%AC%A1%E6%95%B0%E5%9C%A8%E5%89%8D20%E7%9A%84%E8%A7%86%E9%A2%91"><span class="toc-number">7.</span> <span class="toc-text">10.4.7 统计上传视频最多的用户Top10以及他们上传的观看次数在前20的视频</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-4-8-%E7%BB%9F%E8%AE%A1%E6%AF%8F%E4%B8%AA%E7%B1%BB%E5%88%AB%E8%A7%86%E9%A2%91%E8%A7%82%E7%9C%8B%E6%95%B0Top10"><span class="toc-number">8.</span> <span class="toc-text">10.4.8 统计每个类别视频观看数Top10</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC11%E7%AB%A0-%E5%B8%B8%E8%A7%81%E9%94%99%E8%AF%AF%E5%8F%8A%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="toc-number"></span> <span class="toc-text">第11章 常见错误及解决方案</span></a></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-history"></i><span>最近发布</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2022/11/01/%E5%85%A8%E8%BF%9E%E6%8E%A5%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C/" title="全连接神经网络"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://api-storage.4ce.cn/v1/0a5ec69131962af4779f28215c2785f4.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="全连接神经网络"/></a><div class="content"><a class="title" href="/2022/11/01/%E5%85%A8%E8%BF%9E%E6%8E%A5%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C/" title="全连接神经网络">全连接神经网络</a><time datetime="2022-11-01T08:12:03.000Z" title="发表于 2022-11-01 16:12:03">2022-11-01</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/10/01/Hadoop3.x%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6/" title="Hadoop3.x配置文件"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://api-storage.4ce.cn/v1/6d4ee66d79c8fcdba92f41f9a7f8bfc2.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Hadoop3.x配置文件"/></a><div class="content"><a class="title" href="/2022/10/01/Hadoop3.x%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6/" title="Hadoop3.x配置文件">Hadoop3.x配置文件</a><time datetime="2022-10-01T04:52:52.000Z" title="发表于 2022-10-01 12:52:52">2022-10-01</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/05/07/%E5%A4%A7%E6%95%B0%E6%8D%AE%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA/" title="大数据集群搭建"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://api-storage.4ce.cn/v1/58912e513bc61ddde4132a2c0aa8e5ef.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="大数据集群搭建"/></a><div class="content"><a class="title" href="/2022/05/07/%E5%A4%A7%E6%95%B0%E6%8D%AE%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA/" title="大数据集群搭建">大数据集群搭建</a><time datetime="2022-05-07T12:29:10.000Z" title="发表于 2022-05-07 20:29:10">2022-05-07</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/11/23/centos7%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AEmysql5.7/" title="centos7安装配置mysql5.7"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://api-storage.4ce.cn/v1/0400163ad69ac53d9c1e2473e8d517c7.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="centos7安装配置mysql5.7"/></a><div class="content"><a class="title" href="/2021/11/23/centos7%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AEmysql5.7/" title="centos7安装配置mysql5.7">centos7安装配置mysql5.7</a><time datetime="2021-11-23T14:20:22.000Z" title="发表于 2021-11-23 22:20:22">2021-11-23</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/07/04/%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90/" title="数据分析"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://api-storage.4ce.cn/v1/bf56007d912fc00ab0782c7708d4df5d.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="数据分析"/></a><div class="content"><a class="title" href="/2021/07/04/%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90/" title="数据分析">数据分析</a><time datetime="2021-07-04T10:11:03.000Z" title="发表于 2021-07-04 18:11:03">2021-07-04</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"></div><div id="footer-bar"><div class="footer-bar-links"><div class="footer-bar-left"><div id="footer-bar-tips"><div class="copyright">&copy;2020 - 2023 By <a class="footer-bar-link" href="/" title="小贾嗯嗯" target="_blank">小贾嗯嗯</a></div></div><div id="footer-type-tips"></div></div><div class="footer-bar-right"><a class="footer-bar-link" target="_blank" rel="noopener" href="https://github.com/anzhiyu-c/hexo-theme-anzhiyu" title="主题">主题</a></div></div></div></footer></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="sidebar-site-data site-data is-center"><a href="/archives/" title="archive"><div class="headline">文章</div><div class="length-num">69</div></a><a href="/tags/" title="tag"><div class="headline">标签</div><div class="length-num">75</div></a><a href="/categories/" title="category"><div class="headline">分类</div><div class="length-num">9</div></a></div><span class="sidebar-menu-item-title">功能</span><div class="sidebar-menu-item"><a class="darkmode_switchbutton menu-child" href="javascript:void(0);" title="显示模式"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span>显示模式</span></a></div><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://blog.anheyu.com/" title="博客"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="博客"/><span class="back-menu-item-text">博客</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://image.anheyu.com/" title="安知鱼图床"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://image.anheyu.com/favicon.ico" alt="安知鱼图床"/><span class="back-menu-item-text">安知鱼图床</span></a></div></div></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size: 0.9em;"></i><span> 隧道</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size: 0.9em;"></i><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size: 0.9em;"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/bangumis/"><i class="anzhiyufont anzhiyu-icon-bilibili faa-tada" style="font-size: 0.9em;"></i><span> 追番页</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada" style="font-size: 0.9em;"></i><span> 关于本人</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/essay/"><i class="anzhiyufont anzhiyu-icon-lightbulb faa-tada" style="font-size: 0.9em;"></i><span> 闲言碎语</span></a></li></ul></div></div><span class="sidebar-menu-item-title">标签</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/ajax/" style="font-size: 0.88rem;">ajax<sup>1</sup></a><a href="/tags/centos6-yum-error/" style="font-size: 0.88rem;">centos6, yum, error<sup>0</sup></a><a href="/tags/css/" style="font-size: 0.88rem;">css<sup>1</sup></a><a href="/tags/echarts-%E7%8E%AB%E7%91%B0%E8%8A%B1%E5%9B%BE-%E5%8F%AF%E8%A7%86%E5%8C%96/" style="font-size: 0.88rem;">echarts, 玫瑰花图, 可视化<sup>0</sup></a><a href="/tags/error/" style="font-size: 0.88rem;">error<sup>5</sup></a><a href="/tags/error-SparkStreaming/" style="font-size: 0.88rem;">error, SparkStreaming<sup>0</sup></a><a href="/tags/error-flink/" style="font-size: 0.88rem;">error, flink<sup>0</sup></a><a href="/tags/error-hadoop/" style="font-size: 0.88rem;">error, hadoop<sup>0</sup></a><a href="/tags/flink-kafka/" style="font-size: 0.88rem;">flink, kafka<sup>0</sup></a><a href="/tags/git/" style="font-size: 0.88rem;">git<sup>1</sup></a><a href="/tags/hadoop/" style="font-size: 0.88rem;">hadoop<sup>1</sup></a><a href="/tags/hadoop-%E9%AB%98%E5%8F%AF%E7%94%A8/" style="font-size: 0.88rem;">hadoop, 高可用<sup>0</sup></a><a href="/tags/hdfs-hadoop/" style="font-size: 0.88rem;">hdfs, hadoop<sup>0</sup></a><a href="/tags/hive/" style="font-size: 0.88rem;">hive<sup>1</sup></a><a href="/tags/jieba/" style="font-size: 0.88rem;">jieba<sup>1</sup></a><a href="/tags/js/" style="font-size: 0.88rem;">js<sup>2</sup></a><a href="/tags/mapreduce/" style="font-size: 0.88rem;">mapreduce<sup>15</sup></a><a href="/tags/mybatis/" style="font-size: 0.88rem;">mybatis<sup>1</sup></a><a href="/tags/mysql-centos7/" style="font-size: 0.88rem;">mysql, centos7<sup>0</sup></a><a href="/tags/numpy/" style="font-size: 0.88rem;">numpy<sup>2</sup></a><a href="/tags/numpy-%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90-pandas-matplotlib/" style="font-size: 0.88rem;">numpy, 数据分析, pandas, matplotlib<sup>0</sup></a><a href="/tags/pandas/" style="font-size: 0.88rem;">pandas<sup>1</sup></a><a href="/tags/scala-%E9%9A%90%E5%BC%8F%E8%BD%AC%E6%8D%A2/" style="font-size: 0.88rem;">scala, 隐式转换<sup>0</sup></a><a href="/tags/sqoop/" style="font-size: 0.88rem;">sqoop<sup>1</sup></a><a href="/tags/%E5%8F%8C%E5%90%91%E9%93%BE%E8%A1%A8-%E9%93%BE%E8%A1%A8/" style="font-size: 0.88rem;">双向链表, 链表<sup>0</sup></a><a href="/tags/%E5%8F%AF%E8%A7%86%E5%8C%96-%E7%88%AC%E8%99%AB/" style="font-size: 0.88rem;">可视化, 爬虫<sup>0</sup></a><a href="/tags/%E5%93%88%E5%B8%8C/" style="font-size: 0.88rem;">哈希<sup>1</sup></a><a href="/tags/%E5%93%94%E5%93%A9%E5%93%94%E5%93%A9-%E7%88%AC%E8%99%AB-%E5%8F%AF%E8%A7%86%E5%8C%96/" style="font-size: 0.88rem;">哔哩哔哩, 爬虫, 可视化<sup>0</sup></a><a href="/tags/%E5%9B%BE/" style="font-size: 0.88rem;">图<sup>1</sup></a><a href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B-%E7%88%AC%E8%99%AB/" style="font-size: 0.88rem;">多线程, 爬虫<sup>0</sup></a><a href="/tags/%E5%A4%A7%E6%95%B0%E6%8D%AE-%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA/" style="font-size: 0.88rem;">大数据, 集群搭建<sup>0</sup></a><a href="/tags/%E6%8E%92%E5%BA%8F-%E7%AE%97%E6%B3%95/" style="font-size: 0.88rem;">排序, 算法<sup>0</sup></a><a href="/tags/%E6%A0%88/" style="font-size: 0.88rem;">栈<sup>1</sup></a><a href="/tags/%E7%88%AC%E8%99%AB/" style="font-size: 0.88rem;">爬虫<sup>1</sup></a><a href="/tags/%E7%8E%AF%E5%BD%A2%E9%93%BE%E8%A1%A8-%E9%93%BE%E8%A1%A8/" style="font-size: 0.88rem;">环形链表, 链表<sup>0</sup></a><a href="/tags/%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C/" style="font-size: 0.88rem;">神经网络<sup>1</sup></a><a href="/tags/%E7%AE%97%E6%B3%95/" style="font-size: 0.88rem;">算法<sup>1</sup></a><a href="/tags/%E7%AE%97%E6%B3%95-%E6%9F%A5%E6%89%BE%E7%AE%97%E6%B3%95/" style="font-size: 0.88rem;">算法, 查找算法<sup>0</sup></a><a href="/tags/%E9%93%BE%E8%A1%A8-%E5%8D%95%E5%90%91%E9%93%BE%E8%A1%A8/" style="font-size: 0.88rem;">链表, 单向链表<sup>0</sup></a><a href="/tags/%E9%9A%8F%E7%AC%94/" style="font-size: 0.88rem;">随笔<sup>1</sup></a></div></div><hr/></div></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="anzhiyufont anzhiyu-icon-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="anzhiyufont anzhiyu-icon-gear"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="anzhiyufont anzhiyu-icon-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="anzhiyufont anzhiyu-icon-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></button></div></div><div id="nav-music"><a id="nav-music-hoverTips" onclick="anzhiyu.musicToggle()" accesskey="m">播放音乐</a><div id="console-music-bg"></div><meting-js id="8152976493" server="netease" type="playlist" mutex="true" preload="none" theme="var(--anzhiyu-main)" data-lrctype="0" order="random"></meting-js></div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><div class="rightMenu-item" id="menu-backward"><i class="anzhiyufont anzhiyu-icon-arrow-left"></i></div><div class="rightMenu-item" id="menu-forward"><i class="anzhiyufont anzhiyu-icon-arrow-right"></i></div><div class="rightMenu-item" id="menu-refresh"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right" style="font-size: 1rem;"></i></div><div class="rightMenu-item" id="menu-top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></div></div><div class="rightMenu-group rightMenu-line rightMenuPlugin"><div class="rightMenu-item" id="menu-copytext"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制选中文本</span></div><div class="rightMenu-item" id="menu-pastetext"><i class="anzhiyufont anzhiyu-icon-paste"></i><span>粘贴文本</span></div><a class="rightMenu-item" id="menu-commenttext"><i class="anzhiyufont anzhiyu-icon-comment-medical"></i><span>引用到评论</span></a><div class="rightMenu-item" id="menu-newwindow"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开</span></div><div class="rightMenu-item" id="menu-copylink"><i class="anzhiyufont anzhiyu-icon-link"></i><span>复制链接地址</span></div><div class="rightMenu-item" id="menu-copyimg"><i class="anzhiyufont anzhiyu-icon-images"></i><span>复制此图片</span></div><div class="rightMenu-item" id="menu-downloadimg"><i class="anzhiyufont anzhiyu-icon-download"></i><span>下载此图片</span></div><div class="rightMenu-item" id="menu-newwindowimg"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开图片</span></div><div class="rightMenu-item" id="menu-search"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>站内搜索</span></div><div class="rightMenu-item" id="menu-searchBaidu"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>百度搜索</span></div><div class="rightMenu-item" id="menu-music-toggle"><i class="anzhiyufont anzhiyu-icon-play"></i><span>播放音乐</span></div><div class="rightMenu-item" id="menu-music-back"><i class="anzhiyufont anzhiyu-icon-backward"></i><span>切换到上一首</span></div><div class="rightMenu-item" id="menu-music-forward"><i class="anzhiyufont anzhiyu-icon-forward"></i><span>切换到下一首</span></div><div class="rightMenu-item" id="menu-music-playlist" onclick="window.open(&quot;https://y.qq.com/n/ryqq/playlist/8802438608&quot;, &quot;_blank&quot;);" style="display: none;"><i class="anzhiyufont anzhiyu-icon-radio"></i><span>查看所有歌曲</span></div><div class="rightMenu-item" id="menu-music-copyMusicName"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制歌名</span></div></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item menu-link" id="menu-randomPost"><i class="anzhiyufont anzhiyu-icon-shuffle"></i><span>随便逛逛</span></a><a class="rightMenu-item menu-link" href="/categories/"><i class="anzhiyufont anzhiyu-icon-cube"></i><span>博客分类</span></a><a class="rightMenu-item menu-link" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags"></i><span>文章标签</span></a></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item" id="menu-copy" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制地址</span></a><a class="rightMenu-item" id="menu-commentBarrage" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-message"></i><span class="menu-commentBarrage-text">关闭热评</span></a><a class="rightMenu-item" id="menu-darkmode" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span class="menu-darkmode-text">深色模式</span></a><a class="rightMenu-item" id="menu-translate" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-language"></i><span>轉為繁體</span></a></div></div><div id="rightmenu-mask"></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.cbd.int/@fancyapps/ui@5.0.20/dist/fancybox/fancybox.umd.js"></script><script src="https://cdn.cbd.int/instant.page@5.2.0/instantpage.js" type="module"></script><script src="https://cdn.cbd.int/vanilla-lazyload@17.8.4/dist/lazyload.iife.min.js"></script><script src="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.js"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdn.cbd.int/pangu@4.0.7/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (true){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><canvas id="universe"></canvas><script async src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/dark/dark.js"></script><script>// 消除控制台打印
var HoldLog = console.log;
console.log = function () {};
let now1 = new Date();
queueMicrotask(() => {
  const Log = function () {
    HoldLog.apply(console, arguments);
  }; //在恢复前输出日志
  const grt = new Date("08/13/2020 00:00:00"); //此处修改你的建站时间或者网站上线时间
  now1.setTime(now1.getTime() + 250);
  const days = (now1 - grt) / 1000 / 60 / 60 / 24;
  const dnum = Math.floor(days);
  const ascll = [
    `欢迎使用安知鱼!`,
    `生活明朗, 万物可爱`,
    `
        
       █████╗ ███╗   ██╗███████╗██╗  ██╗██╗██╗   ██╗██╗   ██╗
      ██╔══██╗████╗  ██║╚══███╔╝██║  ██║██║╚██╗ ██╔╝██║   ██║
      ███████║██╔██╗ ██║  ███╔╝ ███████║██║ ╚████╔╝ ██║   ██║
      ██╔══██║██║╚██╗██║ ███╔╝  ██╔══██║██║  ╚██╔╝  ██║   ██║
      ██║  ██║██║ ╚████║███████╗██║  ██║██║   ██║   ╚██████╔╝
      ╚═╝  ╚═╝╚═╝  ╚═══╝╚══════╝╚═╝  ╚═╝╚═╝   ╚═╝    ╚═════╝
        
        `,
    "已上线",
    dnum,
    "天",
    "©2020 By 安知鱼 V1.6.8",
  ];
  const ascll2 = [`NCC2-036`, `调用前置摄像头拍照成功，识别为【小笨蛋】.`, `Photo captured: `, `🤪`];

  setTimeout(
    Log.bind(
      console,
      `\n%c${ascll[0]} %c ${ascll[1]} %c ${ascll[2]} %c${ascll[3]}%c ${ascll[4]}%c ${ascll[5]}\n\n%c ${ascll[6]}\n`,
      "color:#425AEF",
      "",
      "color:#425AEF",
      "color:#425AEF",
      "",
      "color:#425AEF",
      ""
    )
  );
  setTimeout(
    Log.bind(
      console,
      `%c ${ascll2[0]} %c ${ascll2[1]} %c \n${ascll2[2]} %c\n${ascll2[3]}\n`,
      "color:white; background-color:#4fd953",
      "",
      "",
      'background:url("https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/tinggge.gif") no-repeat;font-size:450%'
    )
  );

  setTimeout(Log.bind(console, "%c WELCOME %c 你好，小笨蛋.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(
      console,
      "%c ⚡ Powered by 安知鱼 %c 你正在访问 小贾嗯嗯 的博客.",
      "color:white; background-color:#f0ad4e",
      ""
    )
  );

  setTimeout(Log.bind(console, "%c W23-12 %c 你已打开控制台.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(console, "%c S013-782 %c 你现在正处于监控中.", "color:white; background-color:#d9534f", "")
  );
});</script><script async src="/anzhiyu/random.js"></script><div class="js-pjax"><script>(() => {
  const initValine = () => {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: 'ZaTIDM5CkSSMvRBB3xW3OAno-gzGzoHsz',
      appKey: 'WoMTzDyuYVpPWU0x65bOlLhb',
      avatar: 'mp',
      serverURLs: '',
      emojiMaps: {"tv_doge":"6ea59c827c414b4a2955fe79e0f6fd3dcd515e24.png","tv_亲亲":"a8111ad55953ef5e3be3327ef94eb4a39d535d06.png","tv_偷笑":"bb690d4107620f1c15cff29509db529a73aee261.png","tv_再见":"180129b8ea851044ce71caf55cc8ce44bd4a4fc8.png","tv_冷漠":"b9cbc755c2b3ee43be07ca13de84e5b699a3f101.png","tv_发怒":"34ba3cd204d5b05fec70ce08fa9fa0dd612409ff.png","tv_发财":"34db290afd2963723c6eb3c4560667db7253a21a.png","tv_可爱":"9e55fd9b500ac4b96613539f1ce2f9499e314ed9.png","tv_吐血":"09dd16a7aa59b77baa1155d47484409624470c77.png","tv_呆":"fe1179ebaa191569b0d31cecafe7a2cd1c951c9d.png","tv_呕吐":"9f996894a39e282ccf5e66856af49483f81870f3.png","tv_困":"241ee304e44c0af029adceb294399391e4737ef2.png","tv_坏笑":"1f0b87f731a671079842116e0991c91c2c88645a.png","tv_大佬":"093c1e2c490161aca397afc45573c877cdead616.png","tv_大哭":"23269aeb35f99daee28dda129676f6e9ea87934f.png","tv_委屈":"d04dba7b5465779e9755d2ab6f0a897b9b33bb77.png","tv_害羞":"a37683fb5642fa3ddfc7f4e5525fd13e42a2bdb1.png","tv_尴尬":"7cfa62dafc59798a3d3fb262d421eeeff166cfa4.png","tv_微笑":"70dc5c7b56f93eb61bddba11e28fb1d18fddcd4c.png","tv_思考":"90cf159733e558137ed20aa04d09964436f618a1.png","tv_惊吓":"0d15c7e2ee58e935adc6a7193ee042388adc22af.png"},
      path: window.location.pathname,
      visitor: false
    }, null))
  }

  const loadValine = async () => {
    if (typeof Valine === 'function') initValine()
    else {
      await getScript('https://cdn.cbd.int/valine@1.5.1/dist/Valine.min.js')
      initValine()
    }
  }

  if ('Valine' === 'Valine' || !false) {
    if (false) anzhiyu.loadComment(document.getElementById('vcomment'),loadValine)
    else setTimeout(loadValine, 0)
  } else {
    window.loadOtherComment = loadValine
  }
})()</script><input type="hidden" name="page-type" id="page-type" value="post"></div><script src="https://cdn.cbd.int/blueimp-md5@2.19.0/js/md5.min.js"></script><script>window.addEventListener('load', () => {
  const changeContent = (content) => {
    if (content === '') return content

    content = content.replace(/<img.*?src="(.*?)"?[^\>]+>/ig, '[图片]') // replace image link
    content = content.replace(/<a[^>]+?href=["']?([^"']+)["']?[^>]*>([^<]+)<\/a>/gi, '[链接]') // replace url
    content = content.replace(/<pre><code>.*?<\/pre>/gi, '[代码]') // replace code
    content = content.replace(/<[^>]+>/g,"") // remove html tag

    if (content.length > 150) {
      content = content.substring(0,150) + '...'
    }
    return content
  }

  const getIcon = (icon, mail) => {
    if (icon) return icon
    let defaultIcon = '?d=mp'
    let iconUrl = `https://gravatar.loli.net/avatar/${md5(mail.toLowerCase()) + defaultIcon}`
    return iconUrl
  }

  const generateHtml = array => {
    let result = ''

    if (array.length) {
      for (let i = 0; i < array.length; i++) {
        result += '<div class=\'aside-list-item\'>'

        if (true) {
          const name = 'data-lazy-src'
          result += `<a href='${array[i].url}' class='thumbnail'><img ${name}='${array[i].avatar}' alt='${array[i].nick}'></a>`
        }

        result += `<div class='content'>
        <a class='comment' href='${array[i].url}' title='${array[i].content}'>${array[i].content}</a>
        <div class='name'><span>${array[i].nick} / </span><time datetime="${array[i].date}">${anzhiyu.diffDate(array[i].date, true)}</time></div>
        </div></div>`
      }
    } else {
      result += '没有评论'
    }

    let $dom = document.querySelector('#card-newest-comments .aside-list')
    $dom.innerHTML= result
    window.lazyLoadInstance && window.lazyLoadInstance.update()
    window.pjax && window.pjax.refresh($dom)
  }

  const getComment = () => {
    const serverURL = 'https://ZaTIDM5C.api.lncldglobal.com'

    var settings = {
      "method": "GET",
      "headers": {
        "X-LC-Id": 'ZaTIDM5CkSSMvRBB3xW3OAno-gzGzoHsz',
        "X-LC-Key": 'WoMTzDyuYVpPWU0x65bOlLhb',
        "Content-Type": "application/json"
      },
    }

    fetch(`${serverURL}/1.1/classes/Comment?limit=6&order=-createdAt`,settings)
      .then(response => response.json())
      .then(data => {
        const valineArray = data.results.map(function (e) {
          return {
            'avatar': getIcon(e.QQAvatar, e.mail),
            'content': changeContent(e.comment),
            'nick': e.nick,
            'url': e.url + '#' + e.objectId,
            'date': e.updatedAt,
          }
        })
        saveToLocal.set('valine-newest-comments', JSON.stringify(valineArray), 10/(60*24))
        generateHtml(valineArray)
      }).catch(e => {
        const $dom = document.querySelector('#card-newest-comments .aside-list')
        $dom.textContent= "无法获取评论，请确认相关配置是否正确"
      }) 
  }

  const newestCommentInit = () => {
    if (document.querySelector('#card-newest-comments .aside-list')) {
      const data = saveToLocal.get('valine-newest-comments')
      if (data) {
        generateHtml(JSON.parse(data))
      } else {
        getComment()
      }
    }
  }

  newestCommentInit()
  document.addEventListener('pjax:complete', newestCommentInit)
})</script><script>var visitorMail = "visitor@anheyu.com";
</script><script async data-pjax src="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/waterfall/waterfall.js"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/qrcodejs/1.0.0/qrcode.min.js"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.9/icon/ali_iconfont_css.css"><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/aplayer/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.cbd.int/anzhiyu-blog-static@1.0.1/js/APlayer.min.js"></script><script src="https://cdn.cbd.int/hexo-anzhiyu-music@1.0.1/assets/js/Meting2.min.js"></script><script src="https://cdn.cbd.int/pjax@0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]
var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {
  // removeEventListener scroll 
  anzhiyu.removeGlobalFnEvent('pjax')
  anzhiyu.removeGlobalFnEvent('themeChange')

  document.getElementById('rightside').classList.remove('rightside-show')
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', e => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script charset="UTF-8" src="https://cdn.cbd.int/anzhiyu-theme-static@1.1.5/accesskey/accesskey.js"></script></div><div id="popup-window"><div class="popup-window-title">通知</div><div class="popup-window-divider"></div><div class="popup-window-content"><div class="popup-tip">你好呀</div><div class="popup-link"><i class="anzhiyufont anzhiyu-icon-arrow-circle-right"></i></div></div></div></body></html>